<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0, interactive-widget=resizes-content"/>
<title>LegalFlow OS – Aharoni Legal Platform</title>
<script src="https://cdn.tailwindcss.com"></script>
<link href="https://fonts.googleapis.com/css2?family=Heebo:wght@300;400;500;600;700;800&family=Alef:wght@400;700&display=swap" rel="stylesheet"/>
<style>
  :root {
    --brand: #1e3a5f;
    --brand-light: #2563eb;
    --accent: #f59e0b;
    --surface: #f8fafc;
    --card: #ffffff;
    --border: #e2e8f0;
    --text: #1e293b;
    --muted: #64748b;
  }
  * { box-sizing: border-box; margin: 0; padding: 0; }
  html, body {
    height: 100%;
    /* Use dvh so the layout shrinks when keyboard appears */
    min-height: 100dvh;
  }
  body {
    font-family: 'Heebo', sans-serif;
    background: var(--surface);
    color: var(--text);
    direction: rtl;
    overflow-x: hidden;
  }
  /* Sidebar */
  #sidebar {
    width: 260px;
    min-height: 100dvh;
    background: linear-gradient(160deg, #0f2744 0%, #1e3a5f 60%, #1e4080 100%);
    display: flex;
    flex-direction: column;
    position: fixed;
    right: 0;
    top: 0;
    bottom: 0;
    z-index: 50;
    box-shadow: -4px 0 24px rgba(0,0,0,0.18);
  }
  .sidebar-logo {
    padding: 28px 20px 20px;
    border-bottom: 1px solid rgba(255,255,255,0.08);
  }
  .sidebar-logo h1 {
    font-family: 'Alef', sans-serif;
    font-size: 1.15rem;
    font-weight: 700;
    color: #fff;
    line-height: 1.3;
  }
  .sidebar-logo p {
    font-size: 0.72rem;
    color: rgba(255,255,255,0.5);
    margin-top: 3px;
    letter-spacing: 0.04em;
  }
  .nav-section {
    padding: 16px 12px 8px;
    font-size: 0.65rem;
    font-weight: 600;
    color: rgba(255,255,255,0.35);
    letter-spacing: 0.1em;
    text-transform: uppercase;
  }
  .nav-item {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 11px 16px;
    margin: 2px 8px;
    border-radius: 10px;
    cursor: pointer;
    color: rgba(255,255,255,0.65);
    font-size: 0.875rem;
    font-weight: 500;
    transition: all 0.18s ease;
    position: relative;
  }
  .nav-item:hover { background: rgba(255,255,255,0.08); color: #fff; }
  .nav-item.active {
    background: rgba(37,99,235,0.35);
    color: #fff;
    box-shadow: inset 3px 0 0 #f59e0b;
  }
  .nav-item .icon { font-size: 1.1rem; width: 22px; text-align: center; }
  .nav-badge {
    margin-right: auto;
    background: #ef4444;
    color: #fff;
    font-size: 0.65rem;
    padding: 1px 6px;
    border-radius: 99px;
    font-weight: 700;
  }
  /* Status bar at bottom of sidebar */
  .sidebar-footer {
    margin-top: auto;
    padding: 16px;
    border-top: 1px solid rgba(255,255,255,0.08);
  }
  .status-pill {
    display: flex;
    align-items: center;
    gap: 8px;
    background: rgba(255,255,255,0.06);
    padding: 10px 14px;
    border-radius: 10px;
  }
  .dot { width: 8px; height: 8px; border-radius: 50%; flex-shrink: 0; }
  .dot-green { background: #22c55e; box-shadow: 0 0 6px #22c55e; }
  .dot-red { background: #ef4444; box-shadow: 0 0 6px #ef4444; }
  .dot-yellow { background: #f59e0b; box-shadow: 0 0 6px #f59e0b; }
  /* Main */
  #main {
    margin-right: 260px;
    min-height: 100dvh;
    padding: 32px 36px;
  }
  /* Header bar */
  .topbar {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 28px;
  }
  .topbar-title {
    font-size: 1.5rem;
    font-weight: 700;
    color: var(--brand);
  }
  .topbar-sub { font-size: 0.8rem; color: var(--muted); margin-top: 2px; }
  /* Cards */
  .card {
    background: var(--card);
    border: 1px solid var(--border);
    border-radius: 16px;
    padding: 24px;
    margin-bottom: 20px;
    box-shadow: 0 1px 4px rgba(0,0,0,0.05);
  }
  .card-title {
    font-size: 1rem;
    font-weight: 700;
    color: var(--brand);
    margin-bottom: 18px;
    padding-bottom: 12px;
    border-bottom: 2px solid #e8f0fe;
    display: flex;
    align-items: center;
    gap: 8px;
  }
  /* Form */
  .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
  .form-grid-3 { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 16px; }
  .form-group { display: flex; flex-direction: column; gap: 6px; }
  .form-group label { font-size: 0.8rem; font-weight: 600; color: var(--muted); }
  .form-group input, .form-group select {
    padding: 9px 13px;
    border: 1.5px solid var(--border);
    border-radius: 9px;
    font-family: 'Heebo', sans-serif;
    font-size: 0.875rem;
    color: var(--text);
    background: #fff;
    transition: border-color 0.15s;
    direction: rtl;
    width: 100%;
  }
  .form-group input:focus, .form-group select:focus {
    outline: none;
    border-color: var(--brand-light);
    box-shadow: 0 0 0 3px rgba(37,99,235,0.1);
  }
  .form-group input[readonly] { background: #f1f5f9; color: var(--muted); }
  /* Toggle */
  .toggle-row {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 13px 16px;
    background: #f8fafc;
    border: 1.5px solid var(--border);
    border-radius: 10px;
    margin-bottom: 10px;
  }
  .toggle-label { font-size: 0.875rem; font-weight: 600; color: var(--text); }
  .toggle-switch {
    position: relative;
    width: 44px;
    height: 24px;
    flex-shrink: 0;
  }
  .toggle-switch input { opacity: 0; width: 0; height: 0; }
  .toggle-slider {
    position: absolute;
    inset: 0;
    background: #cbd5e1;
    border-radius: 24px;
    cursor: pointer;
    transition: 0.25s;
  }
  .toggle-slider::before {
    content: '';
    position: absolute;
    width: 18px; height: 18px;
    left: 3px; top: 3px;
    background: #fff;
    border-radius: 50%;
    transition: 0.25s;
    box-shadow: 0 1px 4px rgba(0,0,0,0.2);
  }
  .toggle-switch input:checked + .toggle-slider { background: #22c55e; }
  .toggle-switch input:checked + .toggle-slider::before { transform: translateX(20px); }
  /* Alerts */
  .alert {
    display: flex;
    align-items: flex-start;
    gap: 12px;
    padding: 14px 18px;
    border-radius: 12px;
    margin-bottom: 16px;
    font-size: 0.875rem;
    font-weight: 500;
    line-height: 1.5;
  }
  .alert-icon { font-size: 1.2rem; flex-shrink: 0; margin-top: 1px; }
  .alert-red { background: #fef2f2; border: 1.5px solid #fecaca; color: #991b1b; }
  .alert-yellow { background: #fffbeb; border: 1.5px solid #fde68a; color: #92400e; }
  .alert-blue { background: #eff6ff; border: 1.5px solid #bfdbfe; color: #1e40af; }
  .alert-green { background: #f0fdf4; border: 1.5px solid #bbf7d0; color: #14532d; }
  /* Buttons */
  .btn {
    display: inline-flex;
    align-items: center;
    gap: 7px;
    padding: 9px 20px;
    border-radius: 9px;
    font-family: 'Heebo', sans-serif;
    font-size: 0.875rem;
    font-weight: 600;
    cursor: pointer;
    border: none;
    transition: all 0.15s;
    text-decoration: none;
  }
  .btn-primary { background: var(--brand-light); color: #fff; }
  .btn-primary:hover { background: #1d4ed8; transform: translateY(-1px); box-shadow: 0 4px 12px rgba(37,99,235,0.3); }
  .btn-secondary { background: #f1f5f9; color: var(--brand); border: 1.5px solid var(--border); }
  .btn-secondary:hover { background: #e2e8f0; }
  .btn-accent { background: var(--accent); color: #fff; }
  .btn-accent:hover { background: #d97706; }
  .btn-group { display: flex; flex-wrap: wrap; gap: 10px; margin-top: 16px; }

  /* ── Street View Button ── */
  .btn-streetview {
    background: linear-gradient(135deg, #1a73e8, #0d47a1);
    color: #fff; border: none; position: relative; overflow: hidden;
  }
  .btn-streetview::before {
    content: ''; position: absolute; inset: 0;
    background: linear-gradient(135deg, rgba(255,255,255,.12) 0%, transparent 60%);
  }
  .btn-streetview:hover {
    transform: translateY(-1px);
    box-shadow: 0 4px 16px rgba(26,115,232,.45);
    filter: brightness(1.08);
  }
  .sv-pegman { font-size: 1rem; display: inline-block; transition: transform .3s; }
  .btn-streetview:hover .sv-pegman { transform: translateY(-2px) rotate(-5deg); }

  /* ── Modal shell ── */
  #sv-modal  { position: fixed; inset: 0; z-index: 9000; }
  #sv-backdrop {
    position: absolute; inset: 0;
    background: rgba(10,20,40,.78);
    backdrop-filter: blur(5px);
    animation: svFadeIn .2s ease;
  }
  #sv-panel {
    position: absolute; top: 50%; left: 50%;
    transform: translate(-50%, -50%);
    width: min(940px, 96vw);
    height: min(600px, 90vh);
    background: #0b1420;
    border-radius: 16px; overflow: hidden;
    display: flex; flex-direction: column;
    box-shadow: 0 32px 80px rgba(0,0,0,.65), 0 0 0 1px rgba(255,255,255,.07);
    animation: svSlideIn .25s cubic-bezier(.34,1.56,.64,1);
  }
  @keyframes svFadeIn  { from{opacity:0} to{opacity:1} }
  @keyframes svSlideIn {
    from { opacity:0; transform: translate(-50%,-47%) scale(.96) }
    to   { opacity:1; transform: translate(-50%,-50%) scale(1)   }
  }

  /* ── Header ── */
  #sv-header {
    display: flex; align-items: center; justify-content: space-between;
    padding: 12px 16px; flex-shrink: 0;
    background: linear-gradient(90deg, #162035 0%, #0b1420 100%);
    border-bottom: 1px solid rgba(255,255,255,.06);
  }
  #sv-header-left { display: flex; align-items: center; gap: 10px; }
  #sv-pegman-icon {
    font-size: 1.5rem;
    background: linear-gradient(135deg, #1a73e8, #0d47a1);
    border-radius: 50%; width: 38px; height: 38px;
    display: flex; align-items: center; justify-content: center; flex-shrink: 0;
  }
  #sv-title { font-size: .9rem; font-weight: 700; color: #e2e8f0; }
  #sv-address-label {
    font-size: .72rem; color: rgba(255,255,255,.4); margin-top: 2px;
    direction: rtl; max-width: 380px;
    white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
  }
  #sv-header-right { display: flex; gap: 6px; }
  .sv-hbtn {
    background: rgba(255,255,255,.07);
    border: 1px solid rgba(255,255,255,.1);
    color: rgba(255,255,255,.65);
    width: 30px; height: 30px; border-radius: 7px;
    cursor: pointer; font-size: .82rem;
    display: flex; align-items: center; justify-content: center;
    transition: all .15s; text-decoration: none;
  }
  .sv-hbtn:hover { background: rgba(255,255,255,.16); color: #fff; }

  /* ── Panorama body ── */
  #sv-body { flex: 1; min-height: 0; position: relative; }
  #sv-pano  { width: 100%; height: 100%; }

  /* ── Status overlay (shown while loading / on error) ── */
  #sv-status {
    position: absolute; inset: 0;
    display: flex; flex-direction: column;
    align-items: center; justify-content: center; gap: 12px;
    background: #060e1a;
    color: rgba(255,255,255,.6); font-size: .9rem;
    transition: opacity .3s; z-index: 5;
  }
  #sv-status.sv-hidden { opacity: 0; pointer-events: none; }
  #sv-status .sv-spinner {
    width: 34px; height: 34px;
    border: 3px solid rgba(26,115,232,.2);
    border-top-color: #1a73e8;
    border-radius: 50%;
    animation: spin .8s linear infinite;
  }

  @media (max-width: 640px) {
    #sv-panel { width: 100vw; height: 100dvh; top: 0; left: 0; transform: none; border-radius: 0; animation: none; }
    #sv-backdrop { display: none; }
    #sv-address-label { max-width: 160px; }
  }

  /* Checklist */  /* Checklist */  /* Checklist */
  .checklist-item {
    display: flex;
    align-items: flex-start;
    gap: 12px;
    padding: 12px 16px;
    background: #f8fafc;
    border: 1.5px solid var(--border);
    border-radius: 10px;
    margin-bottom: 8px;
    transition: all 0.15s;
  }
  .checklist-item:hover { border-color: var(--brand-light); background: #eff6ff; }
  .checklist-item input[type=checkbox] { width: 18px; height: 18px; margin-top: 1px; accent-color: var(--brand-light); cursor: pointer; flex-shrink: 0; }
  .checklist-item label { font-size: 0.875rem; line-height: 1.5; cursor: pointer; color: var(--text); }
  .checklist-item.completed label { text-decoration: line-through; color: var(--muted); }
  .task-tag {
    display: inline-block;
    font-size: 0.68rem;
    font-weight: 700;
    padding: 2px 8px;
    border-radius: 99px;
    margin-right: 6px;
    letter-spacing: 0.03em;
  }
  .tag-red { background: #fee2e2; color: #991b1b; }
  .tag-yellow { background: #fef3c7; color: #92400e; }
  .tag-blue { background: #dbeafe; color: #1e40af; }
  .tag-purple { background: #ede9fe; color: #5b21b6; }
  /* Timer block */
  .timer-block {
    background: linear-gradient(135deg, #1e3a5f, #1e4080);
    border-radius: 14px;
    padding: 22px;
    color: #fff;
    margin-top: 16px;
  }
  .timer-digits {
    display: flex;
    gap: 10px;
    justify-content: center;
    margin: 16px 0;
  }
  .digit-box {
    background: rgba(255,255,255,0.12);
    border-radius: 10px;
    padding: 12px 18px;
    text-align: center;
    min-width: 72px;
  }
  .digit-num { font-size: 2rem; font-weight: 800; line-height: 1; }
  .digit-lbl { font-size: 0.7rem; color: rgba(255,255,255,0.6); margin-top: 4px; }
  /* Progress bar */
  .progress-bar-wrap {
    height: 6px;
    background: rgba(255,255,255,0.15);
    border-radius: 99px;
    overflow: hidden;
    margin-top: 12px;
  }
  .progress-bar-fill {
    height: 100%;
    background: linear-gradient(90deg, #22c55e, #86efac);
    border-radius: 99px;
    transition: width 0.6s ease;
  }
  /* Fee warning overlay */
  .fee-gate {
    position: relative;
  }
  .fee-gate-overlay {
    position: absolute;
    inset: 0;
    background: rgba(255,255,255,0.85);
    border-radius: 16px;
    z-index: 10;
    display: flex;
    align-items: center;
    justify-content: center;
    backdrop-filter: blur(3px);
  }
  .fee-gate-msg {
    text-align: center;
    padding: 32px;
  }
  .fee-gate-msg .icon { font-size: 3rem; }
  /* Loading spinner */
  .spinner {
    display: inline-block;
    width: 16px;
    height: 16px;
    border: 2px solid rgba(37,99,235,0.3);
    border-top-color: #2563eb;
    border-radius: 50%;
    animation: spin 0.7s linear infinite;
  }
  @keyframes spin { to { transform: rotate(360deg); } }
  /* GIS status */
  .gis-status {
    font-size: 0.78rem;
    color: var(--muted);
    padding: 6px 0;
    min-height: 24px;
    display: flex;
    align-items: center;
    gap: 6px;
  }
  /* Tab view animation */
  .tab-view { animation: fadeIn 0.2s ease; }
  @keyframes fadeIn { from { opacity: 0; transform: translateY(6px); } to { opacity: 1; transform: translateY(0); } }
  /* Summary chip */
  .summary-chip {
    display: inline-flex;
    align-items: center;
    gap: 5px;
    background: #eff6ff;
    border: 1px solid #bfdbfe;
    border-radius: 99px;
    padding: 4px 12px;
    font-size: 0.78rem;
    color: var(--brand);
    font-weight: 600;
  }
  /* Divider */
  .divider { height: 1px; background: var(--border); margin: 20px 0; }
  /* Stat card */
  .stat-card {
    background: var(--card);
    border: 1px solid var(--border);
    border-radius: 14px;
    padding: 18px 20px;
    text-align: center;
  }
  .stat-num { font-size: 1.8rem; font-weight: 800; color: var(--brand); }
  .stat-lbl { font-size: 0.75rem; color: var(--muted); margin-top: 3px; }
  /* Number input ILS */
  .ils-input-wrap { position: relative; }
  .ils-prefix {
    position: absolute;
    right: 12px;
    top: 50%;
    transform: translateY(-50%);
    color: var(--muted);
    font-size: 0.8rem;
    pointer-events: none;
  }
  .ils-input-wrap input { padding-right: 30px; }
  /* Scroll */
  ::-webkit-scrollbar { width: 5px; }
  ::-webkit-scrollbar-track { background: transparent; }
  ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 99px; }

  /* Autocomplete */
  .ac-wrap { position: relative; }
  .ac-input {
    width: 100%;
    padding: 9px 13px;
    border: 1.5px solid var(--border);
    border-radius: 9px;
    font-family: 'Heebo', sans-serif;
    font-size: 0.875rem;
    color: var(--text);
    background: #fff;
    transition: border-color 0.15s;
    direction: rtl;
  }
  .ac-input:focus {
    outline: none;
    border-color: var(--brand-light);
    box-shadow: 0 0 0 3px rgba(37,99,235,0.1);
  }
  .ac-input.loading {
    background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none'%3E%3Ccircle cx='12' cy='12' r='9' stroke='%23cbd5e1' stroke-width='2'/%3E%3Cpath d='M12 3a9 9 0 0 1 9 9' stroke='%232563eb' stroke-width='2' stroke-linecap='round'%3E%3CanimateTransform attributeName='transform' type='rotate' from='0 12 12' to='360 12 12' dur='0.7s' repeatCount='indefinite'/%3E%3C/path%3E%3C/svg%3E");
    background-repeat: no-repeat;
    background-position: left 10px center;
    background-size: 16px 16px;
  }
  .ac-dropdown {
    position: absolute;
    top: calc(100% + 4px);
    right: 0; left: 0;
    background: #fff;
    border: 1.5px solid var(--border);
    border-radius: 10px;
    box-shadow: 0 8px 24px rgba(0,0,0,0.12);
    z-index: 200;
    max-height: 220px;
    overflow-y: auto;
    animation: fadeIn 0.12s ease;
  }
  .ac-item {
    padding: 9px 14px;
    font-size: 0.875rem;
    cursor: pointer;
    color: var(--text);
    border-bottom: 1px solid #f1f5f9;
    transition: background 0.1s;
    display: flex;
    align-items: center;
    gap: 8px;
  }
  .ac-item:last-child { border-bottom: none; }
  .ac-item:hover, .ac-item.selected { background: #eff6ff; color: var(--brand-light); }
  .ac-item .ac-icon { color: var(--muted); font-size: 0.85rem; }
  .ac-empty {
    padding: 12px 14px;
    font-size: 0.82rem;
    color: var(--muted);
    text-align: center;
  }
  .ac-hint {
    font-size: 0.72rem;
    color: var(--muted);
    margin-top: 4px;
    padding-right: 2px;
    min-height: 16px;
  }
  /* ════════════════════════════════════════════════════════
     MOBILE CHROME — topbar, sidebar overlay, bottom nav
  ════════════════════════════════════════════════════════ */

  /* Hidden on desktop; shown via media query */
  #mobile-topbar {
    display: none;
    position: fixed;
    top: 0; left: 0; right: 0;
    height: 56px;
    background: linear-gradient(90deg, #0f2744, #1e3a5f);
    z-index: 100;
    align-items: center;
    justify-content: space-between;
    padding: 0 16px;
    box-shadow: 0 2px 12px rgba(0,0,0,0.25);
  }
  #mobile-topbar h1 {
    font-family: 'Alef', sans-serif;
    font-size: 1rem; font-weight: 700; color: #fff;
  }
  #hamburger {
    background: none; border: none; cursor: pointer;
    display: flex; flex-direction: column; gap: 5px; padding: 6px;
    /* Explicit tap target */
    min-width: 44px; min-height: 44px;
    align-items: center; justify-content: center;
  }
  #hamburger span {
    display: block; width: 22px; height: 2px;
    background: #fff; border-radius: 2px; transition: all 0.25s;
  }
  #hamburger.open span:nth-child(1) { transform: translateY(7px) rotate(45deg); }
  #hamburger.open span:nth-child(2) { opacity: 0; }
  #hamburger.open span:nth-child(3) { transform: translateY(-7px) rotate(-45deg); }

  /* Sidebar overlay */
  #sidebar-overlay {
    display: none; position: fixed; inset: 0;
    background: rgba(0,0,0,0.45); z-index: 98;
    backdrop-filter: blur(2px);
  }
  #sidebar-overlay.active { display: block; }

  /* Bottom nav — hidden on desktop */
  #bottom-nav {
    display: none;
    position: fixed;
    bottom: 0; left: 0; right: 0;
    background: #fff;
    border-top: 1.5px solid var(--border);
    z-index: 90;
    box-shadow: 0 -4px 16px rgba(0,0,0,0.08);
    /* Safe area for notch phones */
    padding-bottom: env(safe-area-inset-bottom, 0px);
  }
  .bottom-nav-items { display: flex; justify-content: space-around; }
  .bnav-item {
    flex: 1; display: flex; flex-direction: column;
    align-items: center; justify-content: center;
    padding: 8px 2px 10px;
    cursor: pointer; font-size: 0.6rem;
    color: var(--muted); font-weight: 600; gap: 3px;
    position: relative; transition: color 0.15s;
    border: none; background: none;
    font-family: 'Heebo', sans-serif;
    min-height: 56px; /* touch-friendly */
  }
  .bnav-item .bicon { font-size: 1.25rem; line-height: 1; }
  .bnav-item.active { color: var(--brand-light); }
  .bnav-item.active::after {
    content: ''; position: absolute;
    top: 0; left: 20%; right: 20%;
    height: 2.5px; background: var(--brand-light);
    border-radius: 0 0 3px 3px;
  }
  .bnav-badge {
    position: absolute; top: 6px; left: 50%;
    transform: translateX(6px);
    background: #ef4444; color: #fff;
    font-size: 0.55rem; width: 14px; height: 14px;
    border-radius: 50%; display: flex;
    align-items: center; justify-content: center; font-weight: 800;
  }

  /* ════════════════════════════════════════════════════════
     TABLET  (≤ 900px) — sidebar narrower, 1-col forms
  ════════════════════════════════════════════════════════ */
  @media (max-width: 900px) {
    #sidebar { width: 220px; }
    #main    { margin-right: 220px; padding: 24px 20px; }
    .form-grid   { grid-template-columns: 1fr; }
    .form-grid-3 { grid-template-columns: 1fr 1fr; }
    .timer-digits { flex-wrap: wrap; }
  }

  /* ════════════════════════════════════════════════════════
     MOBILE  (≤ 640px) — full mobile-first layout
  ════════════════════════════════════════════════════════ */
  @media (max-width: 640px) {

    /* ── Show mobile chrome ── */
    #mobile-topbar { display: flex; }
    #bottom-nav    { display: block; }

    /* ── Sidebar: hidden off-screen, slides in ── */
    #sidebar {
      right: -290px; width: 290px;
      transition: right 0.28s cubic-bezier(0.4,0,0.2,1);
      z-index: 99; overflow-y: auto;
    }
    #sidebar.open { right: 0; }

    /* ── Main: full width; pad clear of topbar + bottom-nav ── */
    #main {
      margin-right: 0 !important;
      padding: 70px 12px calc(72px + env(safe-area-inset-bottom, 0px));
      min-height: 100dvh;
    }

    /* ── Top bar (title row inside main) ── */
    .topbar {
      flex-direction: column; align-items: flex-start;
      gap: 4px; margin-bottom: 14px;
    }
    .topbar-title { font-size: 1.1rem; }
    .topbar-sub   { font-size: 0.75rem; }
    .topbar > div:last-child {
      display: flex; gap: 6px; flex-wrap: wrap;
    }

    /* ── Cards ── */
    .card { padding: 14px 12px; border-radius: 12px; margin-bottom: 14px; }
    .card-title { font-size: 0.88rem; margin-bottom: 12px; padding-bottom: 10px; }

    /* ── All form grids → single column ── */
    .form-grid,
    .form-grid-3 { grid-template-columns: 1fr !important; }

    /* Kill any inline span-2 on mobile */
    [style*="grid-column:span 2"],
    [style*="grid-column: span 2"] { grid-column: span 1 !important; }

    /* ── Touch-friendly inputs & selects ── */
    input:not([type="checkbox"]),
    select,
    textarea,
    .ac-input {
      min-height: 48px !important;
      padding: 10px 13px !important;
      /* Prevent iOS auto-zoom (need ≥16px) */
      font-size: 16px !important;
    }
    .ils-input-wrap input { padding-right: 30px !important; }
    .form-group { gap: 5px; }
    .form-group label { font-size: 0.78rem; }

    /* ── Buttons: full-width on mobile ── */
    .btn-group { flex-direction: column; gap: 8px; }
    .btn-group .btn { width: 100%; justify-content: center; min-height: 48px; font-size: 0.9rem; }

    /* ── Finance stats: 2-col on mobile ── */
    #finance-stats { grid-template-columns: 1fr 1fr !important; }
    .stat-card { padding: 12px 10px; }
    .stat-num  { font-size: 1.25rem; }
    .stat-lbl  { font-size: 0.68rem; }

    /* ── Timer ── */
    .timer-block { padding: 16px 12px; }
    .timer-digits { flex-direction: row; flex-wrap: wrap; justify-content: center; gap: 8px; }
    .digit-box  { min-width: 70px; padding: 10px 10px; flex: 1; }
    .digit-num  { font-size: 1.5rem; }
    .digit-lbl  { font-size: 0.65rem; }

    /* ── Alerts ── */
    .alert { padding: 10px 12px; font-size: 0.82rem; }

    /* ── Legal/planning checklists ── */
    .checklist-item { padding: 10px 12px; gap: 10px; }
    .checklist-item label { font-size: 0.82rem; line-height: 1.45; }
    .task-tag { font-size: 0.65rem; }

    /* ── Document tracker rows ── */
    /* Each doc row: checkbox + input wrap + delete */
    #docs-list > div {
      flex-wrap: nowrap !important;
      min-height: 48px;
    }
    #docs-list input[type="text"] {
      min-width: 0; /* shrink properly in flex */
      font-size: 15px !important; /* slightly smaller OK inside rows */
    }
    #docs-list input[type="checkbox"] {
      width: 22px !important; height: 22px !important;
    }

    /* ── Summary grid (onboarding) ── */
    #summary-content [style*="grid-template-columns:1fr 1fr"],
    #summary-content [style*="grid-template-columns: 1fr 1fr"] {
      grid-template-columns: 1fr !important;
    }

    /* ── Autocomplete dropdown larger items ── */
    .ac-item { padding: 12px 14px; font-size: 0.9rem; }

    /* ── Toggle rows: comfortable spacing ── */
    .toggle-row { padding: 12px 14px; }
    .toggle-label { font-size: 0.82rem; }

    /* ── GIS status ── */
    .gis-status { font-size: 0.75rem; }

    /* ── Hide bottom nav when keyboard is open (JS adds class) ── */
    #bottom-nav.keyboard-open    { display: none !important; }
    #mobile-topbar.keyboard-open { display: none !important; }
  }

  /* ════════════════════════════════════════════════════════
     EXTRA SMALL  (≤ 380px) — very small phones
  ════════════════════════════════════════════════════════ */
  @media (max-width: 380px) {
    .bnav-item { font-size: 0.55rem; }
    .bnav-item .bicon { font-size: 1.1rem; }
    #main { padding-left: 8px; padding-right: 8px; }
    .card { padding: 12px 10px; }
    .stat-num { font-size: 1.1rem; }
  }

  /* ── Summary grid: 1-col on mobile ── */
  @media (max-width: 640px) {
    #summary-grid { grid-template-columns: 1fr !important; }
    /* Finance stats: override inline 3-col → 2-col */
    .finance-stats-grid { grid-template-columns: 1fr 1fr !important; }
    /* Docs card: remove max-width constraint on mobile */
    #tab-docs .card { max-width: 100% !important; }
    /* Docs progress badge: smaller text */
    #docs-progress-badge { font-size: .75rem; padding: 5px 12px; }
    /* Docs add-button: touch height */
    #tab-docs button:last-of-type { min-height: 48px; }
  }
  /* ════════════════════════════════════════════════════════
     AI COPILOT — floating chat widget
  ════════════════════════════════════════════════════════ */

  /* Floating bubble */
  #ai-bubble {
    position: fixed;
    bottom: 22px; left: 22px;
    width: 56px; height: 56px;
    border-radius: 50%;
    background: linear-gradient(135deg, #6366f1, #8b5cf6);
    box-shadow: 0 4px 20px rgba(99,102,241,.5);
    cursor: pointer; z-index: 8000;
    display: flex; align-items: center; justify-content: center;
    font-size: 1.5rem;
    transition: transform .2s, box-shadow .2s;
    border: none;
    /* pulse ring */
    animation: aiBubblePulse 3s ease-in-out infinite;
  }
  #ai-bubble:hover {
    transform: scale(1.1);
    box-shadow: 0 6px 28px rgba(99,102,241,.65);
    animation: none;
  }
  @keyframes aiBubblePulse {
    0%,100% { box-shadow: 0 4px 20px rgba(99,102,241,.5); }
    50%      { box-shadow: 0 4px 32px rgba(99,102,241,.85), 0 0 0 8px rgba(99,102,241,.12); }
  }
  #ai-bubble-badge {
    position: absolute; top: -2px; right: -2px;
    background: #ef4444; color: #fff;
    font-size: 0.6rem; font-weight: 800;
    width: 18px; height: 18px; border-radius: 50%;
    display: none; align-items: center; justify-content: center;
    border: 2px solid #fff;
  }

  /* Chat panel */
  #ai-panel {
    position: fixed;
    bottom: 90px; left: 18px;
    width: 360px;
    max-height: 560px;
    background: #fff;
    border-radius: 20px;
    box-shadow: 0 16px 56px rgba(0,0,0,.18), 0 0 0 1px rgba(0,0,0,.06);
    z-index: 7999;
    display: flex; flex-direction: column;
    overflow: hidden;
    transition: opacity .2s, transform .2s;
    transform-origin: bottom left;
  }
  #ai-panel.ai-hidden {
    opacity: 0; transform: scale(.92) translateY(16px);
    pointer-events: none;
  }

  /* Panel header */
  #ai-header {
    background: linear-gradient(135deg, #4f46e5, #7c3aed);
    padding: 14px 16px;
    display: flex; align-items: center; gap: 10px;
    flex-shrink: 0;
  }
  #ai-header-avatar {
    width: 36px; height: 36px; border-radius: 50%;
    background: rgba(255,255,255,.2);
    display: flex; align-items: center; justify-content: center;
    font-size: 1.1rem; flex-shrink: 0;
  }
  #ai-header-info { flex: 1; min-width: 0; }
  #ai-header-info strong {
    display: block; color: #fff; font-size: .88rem; font-weight: 700;
  }
  #ai-header-info span {
    font-size: .7rem; color: rgba(255,255,255,.65);
  }
  #ai-header-btns { display: flex; gap: 6px; }
  .ai-hbtn {
    background: rgba(255,255,255,.15); border: none;
    color: rgba(255,255,255,.8); width: 28px; height: 28px;
    border-radius: 7px; cursor: pointer; font-size: .8rem;
    display: flex; align-items: center; justify-content: center;
    transition: background .15s;
  }
  .ai-hbtn:hover { background: rgba(255,255,255,.28); color: #fff; }

  /* Context bar */
  #ai-context-bar {
    background: #f8f7ff;
    border-bottom: 1px solid #e8e5ff;
    padding: 6px 14px;
    font-size: .7rem; color: #6d28d9;
    display: flex; align-items: center; gap: 6px;
    flex-shrink: 0;
    white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
  }

  /* Messages area */
  #ai-messages {
    flex: 1; overflow-y: auto;
    padding: 14px 12px;
    display: flex; flex-direction: column; gap: 10px;
    scroll-behavior: smooth;
  }
  #ai-messages::-webkit-scrollbar { width: 4px; }
  #ai-messages::-webkit-scrollbar-thumb { background: #e0e0e0; border-radius: 99px; }

  .ai-msg {
    max-width: 85%;
    padding: 10px 13px;
    border-radius: 16px;
    font-size: .84rem;
    line-height: 1.55;
    word-break: break-word;
    white-space: pre-wrap;
  }
  .ai-msg-user {
    align-self: flex-end;
    background: linear-gradient(135deg, #4f46e5, #7c3aed);
    color: #fff;
    border-bottom-right-radius: 4px;
  }
  .ai-msg-bot {
    align-self: flex-start;
    background: #f3f4f6;
    color: #1f2937;
    border-bottom-left-radius: 4px;
  }
  .ai-msg-system {
    align-self: center;
    background: #fef3c7;
    color: #92400e;
    font-size: .75rem;
    border-radius: 10px;
    text-align: center;
    max-width: 95%;
  }

  /* Typing indicator */
  #ai-typing {
    align-self: flex-start;
    background: #f3f4f6;
    padding: 10px 14px;
    border-radius: 16px;
    border-bottom-left-radius: 4px;
    display: none;
    gap: 5px;
    align-items: center;
  }
  #ai-typing span {
    width: 7px; height: 7px; border-radius: 50%;
    background: #9ca3af;
    display: inline-block;
    animation: aiTypingDot 1.2s ease-in-out infinite;
  }
  #ai-typing span:nth-child(2) { animation-delay: .2s; }
  #ai-typing span:nth-child(3) { animation-delay: .4s; }
  @keyframes aiTypingDot {
    0%,80%,100% { transform: scale(.6); opacity: .4; }
    40%          { transform: scale(1); opacity: 1; }
  }

  /* Input row */
  #ai-input-row {
    padding: 10px 12px;
    border-top: 1px solid #f1f1f1;
    display: flex; gap: 8px; align-items: flex-end;
    flex-shrink: 0; background: #fff;
  }
  #ai-input {
    flex: 1; resize: none; border: 1.5px solid #e5e7eb;
    border-radius: 12px; padding: 9px 12px;
    font-family: 'Heebo', sans-serif; font-size: .875rem;
    color: #1f2937; line-height: 1.4;
    max-height: 100px; overflow-y: auto;
    direction: rtl; outline: none;
    transition: border-color .15s;
  }
  #ai-input:focus { border-color: #6366f1; box-shadow: 0 0 0 3px rgba(99,102,241,.12); }
  #ai-send-btn {
    width: 38px; height: 38px; border-radius: 10px; flex-shrink: 0;
    background: linear-gradient(135deg, #4f46e5, #7c3aed);
    border: none; cursor: pointer; color: #fff; font-size: 1rem;
    display: flex; align-items: center; justify-content: center;
    transition: opacity .15s, transform .15s;
  }
  #ai-send-btn:disabled { opacity: .4; cursor: not-allowed; }
  #ai-send-btn:not(:disabled):hover { transform: scale(1.08); }

  /* Settings modal */
  #ai-settings-modal {
    position: fixed; inset: 0; z-index: 9500;
    background: rgba(0,0,0,.5); backdrop-filter: blur(4px);
    display: flex; align-items: center; justify-content: center;
    padding: 20px;
  }
  #ai-settings-modal.ai-hidden { display: none; }
  #ai-settings-box {
    background: #fff; border-radius: 20px;
    width: min(460px, 100%);
    box-shadow: 0 24px 64px rgba(0,0,0,.2);
    overflow: hidden;
  }
  #ai-settings-hdr {
    background: linear-gradient(135deg, #4f46e5, #7c3aed);
    padding: 20px 24px;
    color: #fff;
  }
  #ai-settings-hdr h3 { font-size: 1.05rem; font-weight: 700; }
  #ai-settings-hdr p  { font-size: .78rem; opacity: .75; margin-top: 3px; }
  #ai-settings-body { padding: 24px; }
  #ai-settings-body label {
    display: block; font-size: .8rem; font-weight: 700;
    color: #374151; margin-bottom: 6px;
  }
  #ai-key-input {
    width: 100%; padding: 10px 13px;
    border: 1.5px solid #e5e7eb; border-radius: 10px;
    font-family: 'Heebo', sans-serif; font-size: .875rem;
    direction: ltr; outline: none;
    transition: border-color .15s;
  }
  #ai-key-input:focus { border-color: #6366f1; box-shadow: 0 0 0 3px rgba(99,102,241,.12); }
  #ai-key-hint {
    font-size: .72rem; color: #6b7280; margin-top: 6px;
  }
  #ai-settings-footer {
    padding: 0 24px 20px;
    display: flex; gap: 10px; justify-content: flex-end;
  }
  .ai-settings-btn {
    padding: 9px 20px; border-radius: 9px;
    font-family: 'Heebo', sans-serif; font-size: .875rem;
    font-weight: 600; cursor: pointer; border: none;
    transition: all .15s;
  }
  .ai-settings-btn-cancel {
    background: #f3f4f6; color: #374151;
    border: 1.5px solid #e5e7eb;
  }
  .ai-settings-btn-save {
    background: linear-gradient(135deg, #4f46e5, #7c3aed);
    color: #fff;
  }
  .ai-settings-btn-save:hover { opacity: .9; }

  /* Settings sidebar button */
  .nav-item-settings {
    display: flex; align-items: center; gap: 10px;
    padding: 11px 16px; margin: 2px 8px;
    border-radius: 10px; cursor: pointer;
    color: rgba(255,255,255,.5);
    font-size: .875rem; font-weight: 500;
    transition: all .18s;
  }
  .nav-item-settings:hover { background: rgba(255,255,255,.06); color: rgba(255,255,255,.8); }

  /* Mobile adjustments for chat panel */
  @media (max-width: 640px) {
    #ai-panel {
      left: 0; right: 0; bottom: 0;
      width: 100%; max-height: 75dvh;
      border-radius: 20px 20px 0 0;
      transform-origin: bottom center;
    }
    #ai-panel.ai-hidden { transform: translateY(100%); }
    #ai-bubble { bottom: 76px; left: 14px; width: 50px; height: 50px; font-size: 1.3rem; }
  }

  /* ═══════════════════════════════════════════
     Payment Schedule Builder
  ═══════════════════════════════════════════ */

  /* ── Card header ── */
  .psch-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    flex-wrap: wrap;
    gap: 10px;
    padding-bottom: 14px;
    margin-bottom: 16px;
    border-bottom: 2px solid #e8f0fe;
  }
  .psch-header-title {
    display: flex; align-items: center; gap: 8px;
    font-size: 1rem; font-weight: 700; color: var(--brand);
  }
  .psch-header-meta {
    display: flex; align-items: center; gap: 8px; flex-wrap: wrap;
  }
  .psch-price-badge {
    font-size: .85rem; font-weight: 800;
    color: #fff;
    background: var(--brand-light);
    padding: 3px 12px; border-radius: 99px;
  }
  .psch-reset-btn {
    font-size: .72rem; font-weight: 600; color: var(--muted);
    background: #f1f5f9; border: 1.5px solid var(--border);
    border-radius: 6px; padding: 4px 12px; cursor: pointer;
    transition: all .15s;
  }
  .psch-reset-btn:hover { background: #e2e8f0; color: var(--text); }

  /* ── Column header strip (desktop) ── */
  .psch-col-heads {
    display: grid;
    grid-template-columns: 170px 1fr 1fr 40px;
    gap: 10px;
    padding: 0 4px 8px;
    margin-bottom: 4px;
  }
  .psch-col-head {
    font-size: .68rem; font-weight: 700; color: var(--muted);
    text-transform: uppercase; letter-spacing: .05em;
  }

  /* ── Individual row ── */
  .psch-row {
    display: grid;
    grid-template-columns: 170px 1fr 1fr 40px;
    gap: 10px;
    align-items: end;
    position: relative;
    padding: 14px;
    background: #f8fafc;
    border: 1.5px solid var(--border);
    border-radius: 12px;
    margin-bottom: 8px;
    transition: border-color .15s, box-shadow .15s, background .15s;
    animation: pschSlideIn .2s cubic-bezier(.25,.46,.45,.94);
  }
  .psch-row:hover { border-color: #93c5fd; background: #f0f7ff; box-shadow: 0 2px 8px rgba(37,99,235,.07); }
  .psch-row:focus-within { border-color: var(--brand-light); background: #f0f7ff; box-shadow: 0 0 0 3px rgba(37,99,235,.09); }
  @keyframes pschSlideIn {
    from { opacity: 0; transform: translateY(-8px) scale(.98); }
    to   { opacity: 1; transform: translateY(0) scale(1); }
  }

  /* Row index badge */
  .psch-row-idx {
    position: absolute;
    top: -9px; right: 14px;
    background: linear-gradient(135deg, var(--brand), var(--brand-light));
    color: #fff; font-size: .6rem; font-weight: 800;
    padding: 2px 9px; border-radius: 99px; letter-spacing: .06em;
  }

  /* ── Field groups inside row ── */
  .psch-field { display: flex; flex-direction: column; gap: 4px; }
  .psch-field-label {
    font-size: .68rem; font-weight: 700; color: var(--muted);
    text-transform: uppercase; letter-spacing: .04em;
  }

  /* Amount wrapper */
  .psch-amt-wrap { position: relative; }
  .psch-ils-sign {
    position: absolute; right: 10px; top: 50%;
    transform: translateY(-50%);
    color: var(--muted); font-size: .82rem; pointer-events: none;
    font-weight: 600;
  }

  /* Shared input style */
  .psch-input {
    width: 100%;
    padding: 9px 12px;
    border: 1.5px solid var(--border);
    border-radius: 9px;
    font-family: 'Heebo', sans-serif; font-size: .875rem;
    color: var(--text); background: #fff;
    transition: border-color .15s, box-shadow .15s;
    direction: rtl;
    box-sizing: border-box;
  }
  .psch-input:focus {
    outline: none;
    border-color: var(--brand-light);
    box-shadow: 0 0 0 3px rgba(37,99,235,.1);
  }
  .psch-input-amount {
    padding-right: 28px;
    direction: ltr; text-align: right;
    font-weight: 700; color: var(--brand);
  }
  .psch-input-amount:focus { color: var(--text); }

  /* Delete button */
  .psch-del {
    width: 36px; height: 36px; flex-shrink: 0;
    border-radius: 8px; border: none; cursor: pointer;
    background: #fee2e2; color: #dc2626;
    display: flex; align-items: center; justify-content: center;
    transition: all .15s; align-self: end;
  }
  .psch-del:hover:not(:disabled) { background: #fca5a5; transform: scale(1.1); }
  .psch-del:disabled { opacity: .25; cursor: default; }

  /* ── Add row button ── */
  #psch-add-btn {
    width: 100%; margin-top: 4px;
    padding: 12px 0;
    border: 2px dashed #93c5fd;
    border-radius: 12px;
    background: transparent;
    color: var(--brand-light);
    font-family: 'Heebo', sans-serif; font-size: .875rem; font-weight: 700;
    cursor: pointer;
    display: flex; align-items: center; justify-content: center; gap: 8px;
    transition: all .18s;
  }
  #psch-add-btn:hover {
    background: #eff6ff;
    border-color: var(--brand-light);
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(37,99,235,.1);
  }
  #psch-add-btn:active { transform: translateY(0); }

  /* ── Summary footer ── */
  #psch-footer {
    margin-top: 12px;
    padding: 14px 18px;
    border-radius: 12px;
    border: 1.5px solid var(--border);
    display: flex; align-items: center; gap: 10px;
    transition: all .25s;
  }
  #psch-footer.state-empty  { background: #f8fafc; border-color: var(--border); color: var(--muted); }
  #psch-footer.state-under  { background: #fffbeb; border-color: #fde68a; color: #92400e; }
  #psch-footer.state-exact  { background: #f0fdf4; border-color: #86efac; color: #15803d; }
  #psch-footer.state-over   { background: #fef2f2; border-color: #fca5a5; color: #991b1b; }
  #psch-footer .psch-foot-icon { font-size: 1.25rem; flex-shrink: 0; }
  .psch-foot-main { flex: 1; min-width: 0; }
  .psch-foot-label { font-size: .8rem; font-weight: 700; }
  .psch-foot-sub   { font-size: .72rem; opacity: .75; margin-top: 2px; }

  /* Progress bar inside footer */
  .psch-prog-track {
    height: 6px; border-radius: 99px;
    background: rgba(0,0,0,.08);
    overflow: hidden; flex-shrink: 0; width: 90px;
  }
  .psch-prog-fill {
    height: 100%; border-radius: 99px;
    transition: width .35s ease, background .25s;
  }
  .psch-pct-lbl { font-size: .72rem; font-weight: 800; min-width: 40px; text-align: left; }

  /* ── Mobile: stack columns ── */
  @media (max-width: 680px) {
    .psch-col-heads { display: none; }
    .psch-row {
      grid-template-columns: 1fr 1fr;
      grid-template-areas:
        "amt   cond"
        "notes notes"
        "del   del";
    }
    .psch-row > .psch-field:nth-child(2) { grid-area: amt; }
    .psch-row > .psch-field:nth-child(3) { grid-area: cond; }
    .psch-row > .psch-field:nth-child(4) { grid-area: notes; }
    .psch-row > .psch-del               { grid-area: del; width: 100%; border-radius: 8px; }
    .psch-prog-track { display: none; }
  }
  @media (max-width: 400px) {
    .psch-row {
      grid-template-columns: 1fr;
      grid-template-areas: "amt" "cond" "notes" "del";
    }
  }

  /* ── Tax tab ── */
  #tax-engine-root .card + .card { margin-top: 0; border-radius: 0; border-top: none; }
  #tax-engine-root .card:last-child { border-radius: 0 0 16px 16px; }
  #tax-engine-root .card:first-child { border-radius: 16px 16px 0 0; }
  #tax-engine-root .card:only-child  { border-radius: 16px; }
  @media (max-width: 640px) {
    #tax-engine-root label[style] { min-width: 100% !important; }
  }

  /* ═══════════════════════════════════════════
     DASHBOARD VIEW
  ═══════════════════════════════════════════ */
  #dashboard-view {
    display: flex;
    flex-direction: column;
    align-items: center;
    min-height: 100%;
    padding: 32px 20px 100px;
  }
  .dv-hero {
    width: 100%; max-width: 860px;
    background: linear-gradient(135deg, #0f2744 0%, #1e4080 100%);
    border-radius: 20px;
    padding: 36px 40px;
    color: #fff;
    display: flex;
    align-items: center;
    justify-content: space-between;
    flex-wrap: wrap;
    gap: 20px;
    margin-bottom: 28px;
    box-shadow: 0 8px 32px rgba(30,58,95,.28);
  }
  .dv-hero h2 { font-size: 1.6rem; font-weight: 800; margin-bottom: 6px; }
  .dv-hero p  { font-size: .875rem; opacity: .75; max-width: 400px; }
  .dv-new-btn {
    display: inline-flex; align-items: center; gap: 10px;
    padding: 14px 28px;
    background: #f59e0b; color: #1e293b;
    font-family: 'Heebo', sans-serif; font-size: 1rem; font-weight: 800;
    border: none; border-radius: 14px; cursor: pointer;
    box-shadow: 0 4px 16px rgba(245,158,11,.4);
    transition: all .18s; white-space: nowrap;
  }
  .dv-new-btn:hover { background: #fbbf24; transform: translateY(-2px); box-shadow: 0 6px 20px rgba(245,158,11,.5); }

  /* Cases grid */
  .dv-cases-wrap { width: 100%; max-width: 860px; }
  .dv-section-head {
    display: flex; align-items: center; justify-content: space-between;
    margin-bottom: 14px;
  }
  .dv-section-title {
    font-size: .8rem; font-weight: 800; color: var(--muted);
    text-transform: uppercase; letter-spacing: .08em;
  }
  .dv-case-count {
    font-size: .75rem; color: var(--muted);
    background: #f1f5f9; border-radius: 99px; padding: 2px 10px;
  }
  .dv-empty {
    text-align: center; padding: 48px 24px;
    color: var(--muted); font-size: .9rem;
    background: #fff; border-radius: 16px;
    border: 2px dashed var(--border);
  }
  .dv-empty-icon { font-size: 3rem; margin-bottom: 12px; }

  /* Case card */
  .dv-card {
    background: #fff;
    border: 1.5px solid var(--border);
    border-radius: 16px;
    padding: 18px 20px;
    margin-bottom: 10px;
    display: flex; align-items: center; gap: 16px;
    transition: all .15s;
    cursor: default;
  }
  .dv-card:hover { border-color: #93c5fd; box-shadow: 0 4px 16px rgba(37,99,235,.08); }
  .dv-card-avatar {
    width: 46px; height: 46px; border-radius: 14px; flex-shrink: 0;
    display: flex; align-items: center; justify-content: center;
    font-size: 1.4rem;
  }
  .dv-card-avatar.role-seller   { background: #fef2f2; }
  .dv-card-avatar.role-buyer_2nd { background: #eff6ff; }
  .dv-card-avatar.role-buyer_contractor { background: #f0fdf4; }
  .dv-card-avatar.role-none { background: #f8fafc; }
  .dv-card-info { flex: 1; min-width: 0; }
  .dv-card-name { font-size: .95rem; font-weight: 700; color: var(--text); margin-bottom: 3px; }
  .dv-card-meta { font-size: .75rem; color: var(--muted); display: flex; gap: 10px; flex-wrap: wrap; }
  .dv-role-badge {
    display: inline-flex; align-items: center;
    font-size: .7rem; font-weight: 700;
    padding: 2px 9px; border-radius: 99px;
  }
  .dv-role-badge.seller   { background: #fef2f2; color: #991b1b; }
  .dv-role-badge.buyer_2nd { background: #eff6ff; color: #1e40af; }
  .dv-role-badge.buyer_contractor { background: #f0fdf4; color: #166534; }
  .dv-card-actions { display: flex; gap: 8px; flex-shrink: 0; }
  .dv-btn-open {
    padding: 8px 18px; border-radius: 10px;
    background: var(--brand-light); color: #fff;
    font-family: 'Heebo', sans-serif; font-size: .8rem; font-weight: 700;
    border: none; cursor: pointer; transition: all .15s;
  }
  .dv-btn-open:hover { background: #1d4ed8; transform: translateY(-1px); }
  .dv-btn-del {
    width: 36px; height: 36px; border-radius: 10px;
    background: #fee2e2; color: #dc2626;
    border: none; cursor: pointer; font-size: .9rem;
    display: flex; align-items: center; justify-content: center;
    transition: all .15s;
  }
  .dv-btn-del:hover { background: #fca5a5; transform: translateY(-1px); }

  /* Back button in case view topbar */
  #back-to-dashboard {
    display: none;
    align-items: center; gap: 6px;
    padding: 7px 14px; border-radius: 10px;
    background: rgba(255,255,255,.1);
    color: #fff; border: 1.5px solid rgba(255,255,255,.2);
    font-family: 'Heebo', sans-serif; font-size: .8rem; font-weight: 700;
    cursor: pointer; transition: all .15s; white-space: nowrap;
  }
  #back-to-dashboard:hover { background: rgba(255,255,255,.18); }
  #save-case-btn {
    display: none;
    align-items: center; gap: 6px;
    padding: 7px 14px; border-radius: 10px;
    background: #22c55e; color: #fff; border: none;
    font-family: 'Heebo', sans-serif; font-size: .8rem; font-weight: 700;
    cursor: pointer; transition: all .15s;
  }
  #save-case-btn:hover { background: #16a34a; transform: translateY(-1px); }
  #save-case-btn.saved {
    background: #86efac; color: #166534;
    pointer-events: none;
  }

  /* ═══════════════════════════════════════════
     DEADLINES TAB
  ═══════════════════════════════════════════ */
  .dl-date-input {
    width: 100%;
    padding: 10px 14px;
    border: 1.5px solid var(--border);
    border-radius: 10px;
    font-family: 'Heebo', sans-serif; font-size: .9rem; color: var(--text);
    background: #fff;
    direction: ltr; text-align: right;
    transition: border-color .15s, box-shadow .15s;
  }
  .dl-date-input:focus {
    outline: none; border-color: var(--brand-light);
    box-shadow: 0 0 0 3px rgba(37,99,235,.1);
  }

  /* Deadline row */
  .dl-row {
    display: flex; align-items: center; gap: 14px;
    padding: 14px 18px;
    background: #f8fafc; border-radius: 14px;
    border: 1.5px solid var(--border);
    margin-bottom: 8px; transition: all .15s;
  }
  .dl-row:hover { border-color: #93c5fd; background: #f0f7ff; }
  .dl-row-icon { font-size: 1.5rem; flex-shrink: 0; }
  .dl-row-info { flex: 1; min-width: 0; }
  .dl-row-label { font-size: .82rem; font-weight: 700; color: var(--text); }
  .dl-row-date  { font-size: .78rem; color: var(--brand-light); font-weight: 600; margin-top: 2px; }
  .dl-countdown {
    padding: 5px 12px; border-radius: 99px;
    font-size: .73rem; font-weight: 800;
    white-space: nowrap; flex-shrink: 0;
  }
  .dl-countdown.urgent  { background: #fef2f2; color: #991b1b; }
  .dl-countdown.warning { background: #fffbeb; color: #92400e; }
  .dl-countdown.ok      { background: #f0fdf4; color: #166534; }
  .dl-countdown.past    { background: #f1f5f9; color: var(--muted); }

  /* ICS / Backup button styles */
  .action-btn {
    display: inline-flex; align-items: center; gap: 8px;
    padding: 11px 20px; border-radius: 12px;
    font-family: 'Heebo', sans-serif; font-size: .875rem; font-weight: 700;
    border: none; cursor: pointer; transition: all .18s;
  }
  .action-btn-blue   { background: #eff6ff; color: #1e40af; border: 1.5px solid #bfdbfe; }
  .action-btn-blue:hover   { background: #dbeafe; transform: translateY(-1px); }
  .action-btn-green  { background: #f0fdf4; color: #166534; border: 1.5px solid #bbf7d0; }
  .action-btn-green:hover  { background: #dcfce7; transform: translateY(-1px); }
  .action-btn-amber  { background: #fffbeb; color: #92400e; border: 1.5px solid #fde68a; }
  .action-btn-amber:hover  { background: #fef3c7; transform: translateY(-1px); }
  .action-btn-red    { background: #fef2f2; color: #991b1b; border: 1.5px solid #fecaca; }
  .action-btn-red:hover    { background: #fee2e2; transform: translateY(-1px); }

  /* Backup modal */
  #backup-modal-overlay {
    display: none; position: fixed; inset: 0;
    background: rgba(0,0,0,.5); z-index: 200;
    align-items: center; justify-content: center;
    padding: 20px;
  }
  #backup-modal-overlay.open { display: flex; }
  #backup-modal {
    background: #fff; border-radius: 20px;
    padding: 32px; max-width: 480px; width: 100%;
    box-shadow: 0 24px 64px rgba(0,0,0,.2);
    animation: modalPop .2s cubic-bezier(.25,.46,.45,.94);
  }
  @keyframes modalPop {
    from { opacity:0; transform: scale(.92) translateY(12px); }
    to   { opacity:1; transform: scale(1) translateY(0); }
  }
  #backup-modal h3 { font-size: 1.1rem; font-weight: 800; margin-bottom: 6px; color: var(--brand); }
  #backup-modal p  { font-size: .82rem; color: var(--muted); margin-bottom: 22px; }
  .backup-btn-row  { display: flex; flex-direction: column; gap: 10px; }

  /* Toast notification */
  #toast {
    position: fixed; bottom: 90px; left: 50%; transform: translateX(-50%);
    background: #1e293b; color: #fff;
    padding: 10px 20px; border-radius: 10px;
    font-size: .82rem; font-weight: 600;
    z-index: 500; opacity: 0;
    transition: opacity .2s;
    pointer-events: none;
    white-space: nowrap;
  }
  #toast.show { opacity: 1; }

  /* ═══════════════════════════════════════════
     Multi-party client list
  ═══════════════════════════════════════════ */
  .party-row {
    display: grid;
    grid-template-columns: 1fr 1fr auto;
    gap: 10px;
    align-items: end;
    padding: 14px;
    background: #f8fafc;
    border: 1.5px solid var(--border);
    border-radius: 12px;
    margin-bottom: 8px;
    position: relative;
    animation: partySlide .18s cubic-bezier(.25,.46,.45,.94);
    transition: border-color .15s, background .15s;
  }
  .party-row:hover   { border-color: #93c5fd; background: #f0f7ff; }
  .party-row:focus-within { border-color: var(--brand-light); background: #f0f7ff; box-shadow: 0 0 0 3px rgba(37,99,235,.08); }
  @keyframes partySlide {
    from { opacity:0; transform: translateY(-6px) scale(.98); }
    to   { opacity:1; transform: translateY(0) scale(1); }
  }

  /* Index badge */
  .party-idx {
    position: absolute;
    top: -9px; right: 14px;
    background: linear-gradient(135deg, var(--brand), var(--brand-light));
    color: #fff; font-size: .6rem; font-weight: 800;
    padding: 2px 9px; border-radius: 99px; letter-spacing: .06em;
  }

  /* Field label */
  .party-label {
    font-size: .68rem; font-weight: 700; color: var(--muted);
    text-transform: uppercase; letter-spacing: .04em;
    margin-bottom: 5px; display: block;
  }

  /* Shared input */
  .party-input {
    width: 100%;
    padding: 9px 12px;
    border: 1.5px solid var(--border);
    border-radius: 9px;
    font-family: 'Heebo', sans-serif; font-size: .875rem;
    color: var(--text); background: #fff;
    transition: border-color .15s, box-shadow .15s;
    box-sizing: border-box;
  }
  .party-input:focus {
    outline: none;
    border-color: var(--brand-light);
    box-shadow: 0 0 0 3px rgba(37,99,235,.1);
  }
  .party-input-id {
    direction: ltr; text-align: right;
    font-weight: 600; color: var(--brand);
    letter-spacing: .06em;
  }

  /* Delete button */
  .party-del {
    width: 36px; height: 36px; flex-shrink: 0;
    border-radius: 9px; border: none; cursor: pointer;
    background: #fee2e2; color: #dc2626;
    display: flex; align-items: center; justify-content: center;
    transition: all .15s; align-self: end;
  }
  .party-del:hover:not(:disabled) { background: #fca5a5; transform: scale(1.1); }
  .party-del:disabled { opacity: .2; cursor: default; }

  /* Add party button */
  #party-add-btn {
    width: 100%; margin-top: 4px;
    padding: 11px 0;
    border: 2px dashed #93c5fd; border-radius: 12px;
    background: transparent; color: var(--brand-light);
    font-family: 'Heebo', sans-serif; font-size: .875rem; font-weight: 700;
    cursor: pointer;
    display: flex; align-items: center; justify-content: center; gap: 8px;
    transition: all .18s;
  }
  #party-add-btn:hover {
    background: #eff6ff; border-color: var(--brand-light);
    transform: translateY(-1px);
  }

  /* Summary pills in sidebar */
  .party-pill {
    display: inline-flex; align-items: center; gap: 4px;
    font-size: .68rem; font-weight: 700;
    background: rgba(255,255,255,.1); color: rgba(255,255,255,.85);
    padding: 2px 8px; border-radius: 99px; margin: 2px 2px 0 0;
  }

  /* Mobile: stack to 1 col */
  @media (max-width: 560px) {
    .party-row {
      grid-template-columns: 1fr;
      grid-template-areas: "name" "id" "del";
    }
    .party-del { grid-area: del; width: 100%; border-radius: 8px; }
  }

  /* ═══════════════════════════════════════════════════════════
     GLOBAL BRAND HEADER
  ═══════════════════════════════════════════════════════════ */
  #global-header {
    position: fixed;
    top: 0; left: 0; right: 0;
    height: 56px;
    background: #fff;
    border-bottom: 1.5px solid #e2e8f0;
    box-shadow: 0 2px 16px rgba(15,39,68,.08);
    z-index: 150;          /* above sidebar(50), below modals(200) */
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 0 24px;
    gap: 16px;
  }

  /* Brand mark (right side — RTL) */
  .gh-brand {
    display: flex;
    align-items: center;
    gap: 12px;
    text-decoration: none;
    flex-shrink: 0;
  }
  .gh-logo {
    width: 59px; height: 59px;
    border-radius: 12px;
    object-fit: cover;
    flex-shrink: 0;
  }
  .gh-name {
    font-family: 'Alef', sans-serif;
    font-size: 1.05rem;
    font-weight: 700;
    color: var(--brand);
    line-height: 1.2;
    letter-spacing: -.01em;
  }
  .gh-name span {
    display: block;
    font-size: .62rem;
    font-weight: 400;
    color: var(--muted);
    letter-spacing: .06em;
    text-transform: uppercase;
  }

  /* Centre tagline (hidden on small screens) */
  .gh-tagline {
    flex: 1;
    text-align: center;
    font-size: .72rem;
    color: var(--muted);
    font-weight: 500;
    letter-spacing: .03em;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }

  /* Right side: version pill + dashboard button */
  .gh-actions {
    display: flex;
    align-items: center;
    gap: 10px;
    flex-shrink: 0;
  }
  .gh-version {
    font-size: .62rem;
    font-weight: 700;
    color: #1e40af;
    background: #eff6ff;
    border: 1px solid #bfdbfe;
    padding: 3px 10px;
    border-radius: 99px;
    letter-spacing: .04em;
  }
  .gh-dash-btn {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    padding: 6px 16px;
    background: var(--brand);
    color: #fff;
    font-family: 'Heebo', sans-serif;
    font-size: .78rem;
    font-weight: 700;
    border: none;
    border-radius: 9px;
    cursor: pointer;
    transition: all .15s;
    white-space: nowrap;
  }
  .gh-dash-btn:hover {
    background: #1e4080;
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(30,58,95,.25);
  }

  /* ─────────────────────────────────────────────────────────
     DESKTOP: sidebar must start below global header
  ───────────────────────────────────────────────────────── */
  #sidebar {
    top: 56px !important;
    min-height: calc(100dvh - 56px) !important;
  }
  #main {
    padding-top: calc(56px + 32px) !important;  /* header + original top pad */
  }

  /* ═══════════════════════════════════════════════════════════
     GLOBAL BRAND FOOTER
  ═══════════════════════════════════════════════════════════ */
  #global-footer {
    /* Sits below everything on desktop */
    background: #f8fafc;
    border-top: 1.5px solid #e2e8f0;
    padding: 10px 24px;
    text-align: center;
    font-size: .72rem;
    color: var(--muted);
    line-height: 1.6;
    /* NOT fixed — just static at bottom of flow on desktop */
  }
  #global-footer strong { color: var(--brand); font-weight: 700; }
  #global-footer a      { color: var(--brand-light); text-decoration: none; }
  #global-footer a:hover{ text-decoration: underline; }
  .gf-divider {
    display: inline-block;
    margin: 0 8px;
    color: #cbd5e1;
  }
  .gf-heart { color: #ef4444; }
  .gf-badge {
    display: inline-flex;
    align-items: center;
    gap: 4px;
    background: linear-gradient(135deg, #0f2744, #1e4080);
    color: #fff;
    font-size: .6rem;
    font-weight: 700;
    padding: 2px 8px;
    border-radius: 99px;
    letter-spacing: .05em;
    vertical-align: middle;
    margin-right: 4px;
  }

  /* ═══════════════════════════════════════════════════════════
     MOBILE overrides
  ═══════════════════════════════════════════════════════════ */
  @media (max-width: 640px) {
    /* Hide global header on mobile — mobile-topbar takes over */
    #global-header { display: none; }

    /* Footer also hidden on mobile (bottom-nav covers that area) */
    #global-footer { display: none; }

    /* Mobile topbar needs no extra adjustment — it's always top:0 */
    #sidebar { top: 0 !important; min-height: 100dvh !important; }
    #main    { padding-top: 70px !important; } /* mobile topbar = 56px */
  }

  @media (max-width: 900px) and (min-width: 641px) {
    /* Tablet: header visible, re-anchor sidebar below it */
    #sidebar { top: 56px !important; }
    #main    { padding-top: calc(56px + 24px) !important; }
    .gh-tagline { display: none; }
  }

  /* ══ Property Type Selector ══════════════════════════════ */
  .pt-grid {
    display: grid;
    grid-template-columns: repeat(5, 1fr);
    gap: 10px; margin-bottom: 4px;
  }
  @media (max-width: 860px) { .pt-grid { grid-template-columns: repeat(3, 1fr); } }
  @media (max-width: 520px) { .pt-grid { grid-template-columns: repeat(2, 1fr); } }
  .pt-tile {
    display: flex; flex-direction: column; align-items: center;
    justify-content: center; gap: 6px; padding: 14px 6px;
    border-radius: 14px; cursor: pointer;
    border: 2px solid var(--border); background: #f8fafc;
    transition: all .18s; user-select: none; text-align: center;
    font-family: 'Heebo', sans-serif;
  }
  .pt-tile:hover { border-color: #93c5fd; background: #eff6ff; transform: translateY(-2px); }
  .pt-tile.on {
    border-color: #1d4ed8; background: #eff6ff;
    box-shadow: 0 0 0 3px rgba(29,78,216,.15);
    transform: translateY(-2px);
  }
  .pt-emoji { font-size: 1.8rem; line-height: 1; }
  .pt-name  { font-size: .73rem; font-weight: 800; color: var(--text); line-height: 1.2; }
  .pt-tile.on .pt-name { color: #1d4ed8; }
  .pt-eng   { font-size: .6rem; color: var(--muted); }
  .pt-tile.on .pt-eng  { color: #3b82f6; }

  /* ══ Non-residential 6% notice ═══════════════════════════ */
  .tax-6pct-banner {
    display: flex; align-items: flex-start; gap: 16px;
    padding: 22px 24px; border-radius: 16px;
    background: linear-gradient(135deg,#fffbeb,#fef3c7);
    border: 2px solid #fcd34d; margin-bottom: 14px;
  }
  .tax-6pct-rate {
    font-size: 3.8rem; font-weight: 900;
    color: #b45309; line-height: 1; white-space: nowrap;
  }

  /* ══ Section 49Z toggle ═══════════════════════════════════ */
  .s49z-card {
    margin-top: 14px; border-radius: 14px;
    border: 2px solid #e2e8f0; overflow: hidden;
    transition: border-color .2s;
  }
  .s49z-card.on { border-color: #16a34a; }
  .s49z-head {
    display: flex; align-items: center; gap: 12px;
    padding: 14px 16px; cursor: pointer;
    background: #f8fafc; transition: background .15s;
    user-select: none;
  }
  .s49z-card.on .s49z-head { background: #f0fdf4; }
  .s49z-head:hover { background: #f0f9ff; }
  .s49z-track {
    width: 46px; height: 26px; border-radius: 13px;
    background: #cbd5e1; position: relative;
    flex-shrink: 0; transition: background .22s; margin-right: auto;
  }
  .s49z-card.on .s49z-track { background: #22c55e; }
  .s49z-knob {
    position: absolute; top: 3px; left: 3px;
    width: 20px; height: 20px; border-radius: 50%;
    background: #fff; box-shadow: 0 1px 4px rgba(0,0,0,.2);
    transition: all .22s;
  }
  .s49z-card.on .s49z-knob { left: 23px; }
  .s49z-body {
    display: none; padding: 18px 18px 16px;
    border-top: 1px solid #e2e8f0; background: #fff;
  }
  .s49z-card.on .s49z-body { display: block; }
  .tt-ico {
    display: inline-flex; align-items: center; justify-content: center;
    width: 16px; height: 16px; border-radius: 50%;
    background: #dbeafe; color: #1d4ed8;
    font-size: .6rem; font-weight: 900; cursor: help;
    position: relative; vertical-align: middle;
    flex-shrink: 0; margin-right: 4px;
  }
  .tt-ico::after {
    content: attr(data-tip); display: none;
    position: absolute; bottom: 140%; right: 50%; transform: translateX(50%);
    background: #1e293b; color: #e2e8f0; padding: 10px 14px;
    border-radius: 10px; font-size: .72rem; font-weight: 400;
    white-space: pre-wrap; width: 250px; line-height: 1.55;
    box-shadow: 0 4px 20px rgba(0,0,0,.3); z-index: 9999;
    pointer-events: none; direction: rtl; text-align: right;
  }
  .tt-ico:hover::after { display: block; }

  /* ══════════════════════════════════════════════════════
     CLIENT PORTAL — Premium styles
  ══════════════════════════════════════════════════════ */

  /* ── Login overlay ───────────────────────────────────── */
  #cp-overlay {
    display: none; position: fixed; inset: 0; z-index: 9800;
    background: linear-gradient(135deg,#080f1d 0%,#0f2744 55%,#1a3461 100%);
    align-items: center; justify-content: center;
  }
  #cp-overlay.active { display: flex; animation: fadeIn .3s ease; }
  .cpl-card {
    background: #fff; border-radius: 24px; padding: 48px 44px 40px;
    width: min(420px, 92vw); box-shadow: 0 32px 80px rgba(0,0,0,.5);
    text-align: center; position: relative;
  }
  .cpl-logo {
    width: 72px; height: 72px; border-radius: 18px;
    background: linear-gradient(135deg,#0f2744,#2563eb);
    display: flex; align-items: center; justify-content: center;
    font-size: 2rem; margin: 0 auto 20px;
    box-shadow: 0 8px 24px rgba(37,99,235,.35);
  }
  .cpl-title { font-size: 1.4rem; font-weight: 800; color: #0f2744; margin-bottom: 6px; }
  .cpl-sub   { font-size: .85rem; color: #64748b; margin-bottom: 28px; line-height: 1.55; }
  .cpl-inp {
    width: 100%; padding: 16px; font-size: 1.65rem; font-weight: 800;
    letter-spacing: .4em; text-align: center; border-radius: 14px;
    border: 2.5px solid #e2e8f0; background: #f8fafc;
    font-family: 'Heebo', monospace; color: #0f2744;
    direction: ltr; box-sizing: border-box;
    transition: border-color .2s, box-shadow .2s;
  }
  .cpl-inp:focus {
    outline: none; border-color: #2563eb;
    box-shadow: 0 0 0 4px rgba(37,99,235,.12); background: #fff;
  }
  .cpl-btn {
    width: 100%; margin-top: 16px; padding: 15px 20px;
    border-radius: 12px; background: linear-gradient(135deg,#0f2744,#2563eb);
    color: #fff; font-family: 'Heebo', sans-serif; font-size: 1rem; font-weight: 700;
    border: none; cursor: pointer; transition: all .2s;
    box-shadow: 0 4px 16px rgba(37,99,235,.3);
  }
  .cpl-btn:hover { transform: translateY(-2px); box-shadow: 0 8px 24px rgba(37,99,235,.45); }
  .cpl-err { color: #dc2626; font-size: .82rem; margin-top: 10px; min-height: 20px; font-weight: 600; }
  .cpl-x {
    position: absolute; top: 14px; left: 14px; width: 32px; height: 32px;
    border-radius: 8px; background: #f1f5f9; border: none; cursor: pointer;
    display: flex; align-items: center; justify-content: center;
    color: #64748b; font-size: 1rem; transition: all .15s;
  }
  .cpl-x:hover { background: #e2e8f0; color: #0f2744; }

  /* ── Client dashboard ────────────────────────────────── */
  #cd-dash {
    display: none; position: fixed; inset: 0; z-index: 9700;
    background: #eef2f7; overflow-y: auto; flex-direction: column;
  }
  #cd-dash.active { display: flex; animation: fadeIn .25s ease; }
  .cdh {
    background: linear-gradient(135deg,#0f2744 0%,#1a3461 100%);
    padding: 14px 28px; display: flex; align-items: center;
    justify-content: space-between; flex-shrink: 0;
    box-shadow: 0 4px 24px rgba(0,0,0,.3);
    position: sticky; top: 0; z-index: 10;
  }
  .cdh-brand { display: flex; align-items: center; gap: 12px; }
  .cdh-logo  {
    width: 38px; height: 38px; border-radius: 10px;
    background: #fff; display: flex; align-items: center;
    justify-content: center; font-size: 1.2rem;
  }
  .cdh-name { color: #fff; font-size: 1rem; font-weight: 700; line-height: 1.2; }
  .cdh-sub  { color: rgba(255,255,255,.45); font-size: .68rem; letter-spacing: .05em; }
  .cdh-out  {
    padding: 8px 18px; border-radius: 9px;
    border: 1px solid rgba(255,255,255,.2);
    background: rgba(255,255,255,.1); color: #fff;
    font-family: inherit; font-size: .82rem; font-weight: 600;
    cursor: pointer; transition: all .15s;
  }
  .cdh-out:hover { background: rgba(255,255,255,.22); }
  .cdb {
    padding: 28px; max-width: 860px; margin: 0 auto;
    width: 100%; box-sizing: border-box;
  }
  .cds {
    font-size: .7rem; font-weight: 800; color: #64748b;
    letter-spacing: .1em; text-transform: uppercase;
    margin: 26px 0 12px; display: flex; align-items: center; gap: 8px;
  }
  .cdc {
    background: #fff; border-radius: 16px; border: 1px solid #e2e8f0;
    padding: 22px 24px; box-shadow: 0 2px 12px rgba(0,0,0,.06);
  }

  /* Progress bar */
  .cdp-trk { height: 14px; border-radius: 99px; background: #e2e8f0; overflow: hidden; }
  .cdp-fill {
    height: 100%; border-radius: 99px;
    background: linear-gradient(90deg,#2563eb,#16a34a);
    transition: width 1s cubic-bezier(.4,0,.2,1);
  }
  .cdp-lbl {
    display: flex; justify-content: space-between;
    margin-top: 8px; font-size: .68rem; color: #94a3b8;
  }
  .cd-pills { display: flex; gap: 8px; flex-wrap: wrap; margin-top: 14px; }
  .cd-pill  {
    padding: 5px 14px; border-radius: 99px; font-size: .72rem; font-weight: 700;
    display: flex; align-items: center; gap: 5px;
  }
  .pil-done { background: #f0fdf4; color: #16a34a; border: 1px solid #bbf7d0; }
  .pil-now  { background: #eff6ff; color: #2563eb; border: 1px solid #bfdbfe; }
  .pil-wait { background: #f8fafc; color: #94a3b8; border: 1px solid #e2e8f0; }

  /* Payment rows */
  .cd-pay {
    display: grid; grid-template-columns: 1fr auto auto;
    align-items: center; gap: 12px; padding: 12px 14px;
    border-radius: 10px; border: 1px solid #e2e8f0;
    margin-bottom: 8px; font-size: .85rem;
  }
  .cd-pay:last-child { margin-bottom: 0; }
  .pay-done { background: #f0fdf4; border-color: #bbf7d0; }
  .pay-next { background: #fffbeb; border-color: #fde68a; }
  .pay-fut  { background: #f8fafc; }

  /* Deadline rows */
  .cd-dl {
    display: flex; align-items: center; gap: 14px; padding: 10px 14px;
    border-radius: 10px; border: 1px solid #e2e8f0; margin-bottom: 8px; font-size: .84rem;
  }
  .cd-dl:last-child { margin-bottom: 0; }
  .dl-name { font-weight: 600; color: #1e293b; }
  .dl-date { font-size: .73rem; color: #64748b; margin-top: 1px; }
  .dl-chip {
    margin-right: auto; padding: 3px 10px; border-radius: 99px;
    font-size: .68rem; font-weight: 700; white-space: nowrap;
  }
  .chip-r { background: #fef2f2; color: #dc2626; border: 1px solid #fecaca; }
  .chip-y { background: #fffbeb; color: #d97706; border: 1px solid #fde68a; }
  .chip-g { background: #f0fdf4; color: #16a34a; border: 1px solid #bbf7d0; }

  /* Document rows */
  .cd-doc {
    display: flex; align-items: center; gap: 12px; padding: 11px 14px;
    border-radius: 10px; border: 1px solid #e2e8f0; margin-bottom: 8px; font-size: .85rem;
  }
  .cd-doc:last-child { margin-bottom: 0; }
  .cd-doc-n { flex: 1; font-weight: 600; color: #1e293b; }
  .bdg-m {
    padding: 3px 10px; border-radius: 99px; font-size: .7rem; font-weight: 700;
    white-space: nowrap; background: #fef2f2; color: #dc2626; border: 1px solid #fecaca;
  }
  .bdg-r {
    padding: 3px 10px; border-radius: 99px; font-size: .7rem; font-weight: 700;
    white-space: nowrap; background: #f0fdf4; color: #16a34a; border: 1px solid #bbf7d0;
  }
  .cd-upbtn {
    padding: 6px 14px; border-radius: 8px;
    background: linear-gradient(135deg,#0f2744,#2563eb);
    color: #fff; font-family: inherit; font-size: .75rem; font-weight: 700;
    border: none; cursor: pointer; transition: all .15s; white-space: nowrap;
  }
  .cd-upbtn:hover { opacity: .85; }
  .cd-upbtn:disabled { opacity: .4; cursor: default; }

  /* ── Lawyer portal tab ────────────────────────────────── */
  .pt-hero {
    background: linear-gradient(135deg,#0f2744 0%,#1a3461 60%,#1e4080 100%);
    border-radius: 18px; padding: 30px 28px; color: #fff;
    margin-bottom: 20px; position: relative; overflow: hidden;
  }
  .pt-hero::before {
    content: ''; position: absolute; top: -50px; right: -50px;
    width: 220px; height: 220px; border-radius: 50%;
    background: rgba(255,255,255,.04); pointer-events: none;
  }
  .pt-hero::after {
    content: ''; position: absolute; bottom: -30px; left: 40px;
    width: 140px; height: 140px; border-radius: 50%;
    background: rgba(37,99,235,.12); pointer-events: none;
  }
  .pt-code-box {
    font-size: 2.4rem; font-weight: 900; letter-spacing: .32em;
    background: rgba(255,255,255,.1); border-radius: 14px;
    padding: 14px 24px; margin: 16px 0; text-align: center;
    font-family: 'Heebo', monospace; direction: ltr;
    border: 1.5px solid rgba(255,255,255,.18);
    position: relative; z-index: 1;
  }
  .pt-link-box {
    background: rgba(255,255,255,.07); border: 1px solid rgba(255,255,255,.15);
    border-radius: 10px; padding: 10px 14px; font-size: .76rem;
    color: rgba(255,255,255,.65); font-family: monospace;
    direction: ltr; word-break: break-all; margin-bottom: 14px;
    position: relative; z-index: 1;
  }
  .pt-actions { display: flex; gap: 10px; flex-wrap: wrap; position: relative; z-index: 1; }
  .pt-btn {
    padding: 9px 20px; border-radius: 9px;
    background: rgba(255,255,255,.13); border: 1px solid rgba(255,255,255,.22);
    color: #fff; font-family: inherit; font-size: .82rem; font-weight: 600;
    cursor: pointer; transition: all .15s;
  }
  .pt-btn:hover { background: rgba(255,255,255,.23); }
  .pt-btn-prev { background: rgba(245,158,11,.2); border-color: rgba(245,158,11,.4); }
  .pt-btn-prev:hover { background: rgba(245,158,11,.35); }
  .pt-ok { color: #86efac; font-size: .78rem; font-weight: 600; display: none; margin-top: 8px; position: relative; z-index: 1; }

  /* Portal doc table */
  .pt-tbl { width: 100%; border-collapse: collapse; }
  .pt-tbl th {
    font-size: .72rem; font-weight: 700; color: #64748b; text-align: right;
    padding: 8px 12px; border-bottom: 2px solid #e2e8f0; letter-spacing: .04em;
  }
  .pt-tbl td { padding: 10px 12px; border-bottom: 1px solid #f1f5f9; font-size: .85rem; }
  .pt-tbl tr:last-child td { border-bottom: none; }
  .pt-tbl tr:hover td { background: #f8fafc; }
  .pt-mark {
    padding: 5px 14px; border-radius: 7px;
    background: linear-gradient(135deg,#0f2744,#2563eb);
    color: #fff; font-family: inherit; font-size: .75rem; font-weight: 700;
    border: none; cursor: pointer; transition: all .15s;
  }
  .pt-mark:hover { opacity: .85; transform: translateY(-1px); }

  /* FAB */
  #cp-fab {
    position: fixed; bottom: 24px; left: 24px; z-index: 400;
    padding: 10px 20px; border-radius: 99px;
    background: linear-gradient(135deg,#0f2744,#2563eb);
    color: #fff; font-family: 'Heebo', sans-serif;
    font-size: .82rem; font-weight: 700; border: none; cursor: pointer;
    display: flex; align-items: center; gap: 8px;
    box-shadow: 0 4px 20px rgba(15,39,68,.45); transition: all .2s;
  }
  #cp-fab:hover { transform: translateY(-2px); box-shadow: 0 8px 28px rgba(15,39,68,.55); }
  @media (max-width: 640px) {
    #cp-fab { bottom: 80px; left: 10px; font-size: .75rem; padding: 8px 14px; }
    .cdb    { padding: 16px; }
    .cdh    { padding: 12px 16px; }
    .cpl-card { padding: 32px 20px 28px; }
    .cd-pay { grid-template-columns: 1fr auto; }
  }

</style>
  <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyACPfmFETktrWV4KNI-d8M9MB-ScD-L67Y&libraries=places,geometry"></script>
</head>
<body>

<!-- ═══════════════════════════════════════════════════════════
     GLOBAL BRAND HEADER — fixed top, z-index 150
═══════════════════════════════════════════════════════════ -->
<header id="global-header" role="banner">

  <!-- Brand (RTL: appears on right) -->
  <div class="gh-brand">
    <img
      src="logo.png"
      alt="LegalFlow OS Logo"
      class="gh-logo h-10 w-auto"
      onerror="this.style.display='none'"
    />
    <div class="gh-name">
      LegalFlow OS
      <span>Aharoni Legal Platform</span>
    </div>
  </div>

  <!-- Centre tagline -->
  <div class="gh-tagline" aria-hidden="true">
    ⚖️ מערכת ניהול עסקאות נדל"ן — מיסוי · מימון · הגנות משפטיות
  </div>

  <!-- Actions (RTL: appears on left) -->
  <div class="gh-actions">
    <span class="gh-version">v2.0 AI</span>
    <button class="gh-dash-btn" onclick="showDashboard()" title="חזרה לדשבורד">
      <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor"
        stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
        <rect x="3" y="3" width="7" height="7" rx="1"/>
        <rect x="14" y="3" width="7" height="7" rx="1"/>
        <rect x="3" y="14" width="7" height="7" rx="1"/>
        <rect x="14" y="14" width="7" height="7" rx="1"/>
      </svg>
      כל התיקים
    </button>
  </div>

</header>


<!-- MOBILE TOPBAR -->
<div id="mobile-topbar">
  <div style="display:flex;align-items:center;gap:10px;">
    <img src="logo.png"
      alt="LegalFlow OS Logo" style="width:32px;height:32px;border-radius:8px;object-fit:contain;"
      onerror="this.style.display='none'"/>
    <div>
      <div style="font-family:'Alef',sans-serif;font-size:.92rem;font-weight:700;color:#fff;line-height:1.1;">LegalFlow OS</div>
      <div style="font-size:.55rem;color:rgba(255,255,255,.5);letter-spacing:.06em;text-transform:uppercase;">Aharoni Legal</div>
    </div>
  </div>
  <button id="hamburger" onclick="toggleSidebar()" aria-label="תפריט">
    <span></span><span></span><span></span>
  </button>
</div>

<!-- SIDEBAR OVERLAY (tap to close) -->
<div id="sidebar-overlay" onclick="closeSidebar()"></div>

<!-- BOTTOM NAV -->
<div id="bottom-nav">
  <div class="bottom-nav-items">
    <button class="bnav-item active" id="bnav-onboarding" onclick="switchTab('onboarding')">
      <span class="bicon">📋</span>פתיחת תיק
    </button>
    <button class="bnav-item" id="bnav-planning" onclick="switchTab('planning')">
      <span class="bicon">🗺️</span>תכנון
    </button>
    <button class="bnav-item" id="bnav-finance" onclick="switchTab('finance')">
      <span class="bicon">🏦</span>מימון
    </button>
    <button class="bnav-item" id="bnav-tax" onclick="switchTab('tax')">
      <span class="bicon">🧮</span>מיסוי
    </button>
    <button class="bnav-item" id="bnav-deadlines" onclick="switchTab('deadlines')">
      <span class="bicon">📅</span>מועדים
    </button>
    <button class="bnav-item" id="bnav-legal" onclick="switchTab('legal')">
      <span class="bicon">🛡️</span>משפטי
      <span class="bnav-badge" id="bnav-legal-badge" style="display:none">!</span>
    </button>
    <button class="bnav-item" id="bnav-docs" onclick="switchTab('docs')">
      <span class="bicon">📁</span>מסמכים
    </button>
    <button class="bnav-item" id="bnav-portal" onclick="switchTab('portal')">
      <span class="bicon">🔑</span>פורטל
    </button>
  </div>
</div>

<nav id="sidebar">
  <div class="sidebar-logo" style="display:flex;align-items:center;gap:12px;padding:20px 16px;">
    <img src="logo.png"
      alt="LegalFlow OS Logo" style="width:36px;height:36px;border-radius:9px;flex-shrink:0;object-fit:contain;"
      onerror="this.style.display='none'"/>
    <div>
      <h1 style="font-size:1rem;font-weight:800;letter-spacing:-.01em;">LegalFlow OS</h1>
      <p style="margin-top:2px;">AHARONI LEGAL PLATFORM</p>
    </div>
  </div>

  <div class="nav-section">מודולים</div>

  <div class="nav-item active" onclick="switchTab('onboarding')" id="nav-onboarding">
    <span class="icon">📋</span>
    <span>פתיחת תיק</span>
  </div>
  <div class="nav-item" onclick="switchTab('planning')" id="nav-planning">
    <span class="icon">🗺️</span>
    <span>תכנון וקניין</span>
  </div>
  <div class="nav-item" onclick="switchTab('finance')" id="nav-finance">
    <span class="icon">🏦</span>
    <span>מימון</span>
  </div>
  <div class="nav-item" onclick="switchTab('tax')" id="nav-tax">
    <span class="icon">🧮</span>
    <span>מיסוי</span>
  </div>
  <div class="nav-item" onclick="switchTab('deadlines')" id="nav-deadlines">
    <span class="icon">📅</span>
    <span>מועדים ותזכורות</span>
  </div>
  <div class="nav-item" onclick="switchTab('legal')" id="nav-legal">
    <span class="icon">🛡️</span>
    <span>הגנות משפטיות</span>
    <span class="nav-badge" id="legal-badge" style="display:none">!</span>
  </div>
  <div class="nav-item" onclick="switchTab('docs')" id="nav-docs">
    <span class="icon">📁</span>
    <span>מרכז מסמכים</span>
  </div>
  <div class="nav-item" onclick="switchTab('portal')" id="nav-portal">
    <span class="icon">🔑</span>
    <span>פורטל לקוח</span>
  </div>

  <div class="divider" style="margin: 12px 16px; background: rgba(255,255,255,0.08);"></div>
  <div class="nav-section">כלים מהירים</div>
  <div class="nav-item" onclick="openGovmap()">
    <span class="icon">🌐</span>
    <span>Govmap</span>
  </div>
  <div class="nav-item" onclick="window.open('https://mavat.iplan.gov.il/SV1','_blank')">
    <span class="icon">📐</span>
    <span>מבא״ת</span>
  </div>

  <div class="sidebar-footer">
    <div class="status-pill" style="margin-bottom:10px;">
      <div class="dot" id="fee-dot" style="background:#ef4444;box-shadow:0 0 6px #ef4444;"></div>
      <div>
        <div style="color:#fff;font-size:0.78rem;font-weight:600;" id="fee-status-txt">שכ״ט לא נחתם</div>
        <div style="color:rgba(255,255,255,0.4);font-size:0.68rem;" id="client-name-mini">טרם הוזן לקוח</div>
      </div>
    </div>
    <div class="nav-item-settings" onclick="aiOpenSettings()">
      <span style="font-size:1rem;">⚙️</span>
      <span>הגדרות AI Copilot</span>
      <span id="ai-key-indicator" style="margin-right:auto;width:8px;height:8px;border-radius:50%;background:#ef4444;display:inline-block;flex-shrink:0;" title="מפתח API חסר"></span>
    </div>
  </div>
</nav>

<!-- MAIN CONTENT -->
<main id="main">

  <!-- TOP BAR -->
  <div class="topbar">
    <div>
      <div class="topbar-title" id="main-title">📋 פתיחת תיק</div>
      <div class="topbar-sub" id="main-sub">הגדרת עסקה חדשה ופרטי לקוח</div>
    </div>
    <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap;">
      <span class="summary-chip" id="role-chip" style="display:none"></span>
      <span class="summary-chip" id="price-chip" style="display:none"></span>
      <button id="save-case-btn" onclick="saveCase()" title="שמור תיק">
        <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round"><path d="M19 21H5a2 2 0 01-2-2V5a2 2 0 012-2h11l5 5v11a2 2 0 01-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></svg>
        שמור תיק
      </button>
      <button id="back-to-dashboard" onclick="showDashboard()" title="חזרה לדשבורד">
        ← כל התיקים
      </button>
    </div>
  </div>

  <!-- ═══════════════ DASHBOARD VIEW ═══════════════ -->
  <div id="dashboard-view" style="display:none;">

    <!-- Hero -->
    <div class="dv-hero">
      <div>
        <div style="display:flex;align-items:center;gap:14px;margin-bottom:6px;">
          <img src="logo.png"
            alt="LegalFlow OS Logo" class="h-20 w-auto mx-4"
            style="height:80px;width:auto;border-radius:16px;object-fit:contain;filter:drop-shadow(0 4px 16px rgba(0,0,0,0.25));"
            onerror="this.style.display='none'"/>
          <div>
            <h2 style="margin-bottom:2px;">LegalFlow OS</h2>
            <div style="font-size:.72rem;opacity:.6;font-weight:400;letter-spacing:.06em;text-transform:uppercase;">Aharoni Legal Platform</div>
          </div>
        </div>
        <p>ניהול תיקי עסקאות נדל"ן · מיסוי · מימון · הגנות משפטיות</p>
      </div>
      <button class="dv-new-btn" onclick="createNewCase()">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
        פתח תיק חדש
      </button>
    </div>

    <!-- Cases list -->
    <div class="dv-cases-wrap">
      <div class="dv-section-head">
        <span class="dv-section-title">תיקים פעילים</span>
        <span class="dv-case-count" id="dv-count">0 תיקים</span>
      </div>
      <div id="dv-cases-list"></div>
    </div>

    <!-- Backup row -->
    <div class="dv-cases-wrap" style="margin-top:24px;">
      <div class="dv-section-head">
        <span class="dv-section-title">גיבוי ושחזור</span>
      </div>
      <div style="display:flex;gap:10px;flex-wrap:wrap;">
        <button class="action-btn action-btn-green" onclick="exportBackup()">
          📥 גיבוי נתונים (Export JSON)
        </button>
        <label class="action-btn action-btn-amber" style="cursor:pointer;">
          📤 שחזור נתונים (Import JSON)
          <input type="file" accept=".json" id="import-file-input" style="display:none;"
            onchange="importBackup(this)"/>
        </label>
      </div>
    </div>

  </div>

  <!-- =========== TAB 1: ONBOARDING =========== -->
  <div id="tab-onboarding" class="tab-view">

    <div class="alert alert-blue">
      <span class="alert-icon">ℹ️</span>
      <span>מלא את כל פרטי העסקה כאן. <strong>הסכם שכר הטרחה</strong> הוא תנאי מוקדם להפעלת כל המודולים.</span>
    </div>

    <div class="card">
      <div class="card-title">👤 פרטי לקוח ועסקה</div>

      <!-- ★ Property Type Selector ★ -->
      <div class="form-group" style="margin-bottom:22px;">
        <label style="display:flex;align-items:center;gap:8px;margin-bottom:12px;font-weight:700;">
          🏗️ סוג הנכס
          <span style="background:#fef3c7;color:#b45309;font-size:.62rem;font-weight:800;
            padding:2px 8px;border-radius:99px;border:1px solid #fcd34d;">חובה</span>
        </label>
        <div class="pt-grid" id="pt-grid">
          <div class="pt-tile" data-pt="apartment" onclick="ptPick('apartment')">
            <span class="pt-emoji">🏢</span>
            <span class="pt-name">דירה</span>
            <span class="pt-eng">Apartment</span>
          </div>
          <div class="pt-tile" data-pt="house" onclick="ptPick('house')">
            <span class="pt-emoji">🏡</span>
            <span class="pt-name">בית פרטי</span>
            <span class="pt-eng">Private House</span>
          </div>
          <div class="pt-tile" data-pt="land" onclick="ptPick('land')">
            <span class="pt-emoji">🏞️</span>
            <span class="pt-name">מגרש</span>
            <span class="pt-eng">Plot / Land</span>
          </div>
          <div class="pt-tile" data-pt="commercial" onclick="ptPick('commercial')">
            <span class="pt-emoji">🏪</span>
            <span class="pt-name">נכס מסחרי</span>
            <span class="pt-eng">Commercial</span>
          </div>
          <div class="pt-tile" data-pt="building" onclick="ptPick('building')">
            <span class="pt-emoji">🏗️</span>
            <span class="pt-name">בניין</span>
            <span class="pt-eng">Building</span>
          </div>
        </div>
        <div id="pt-hint" style="font-size:.72rem;color:#3b82f6;margin-top:6px;font-weight:600;min-height:16px;"></div>
      </div>

      <!-- Role selector -->
      <div class="form-group" style="margin-bottom:18px;">
        <label>תפקיד בעסקה</label>
        <select id="clientRole" onchange="updateState()">
          <option value="">-- בחר תפקיד --</option>
          <option value="seller">מוכר</option>
          <option value="buyer_2nd">קונה יד שנייה</option>
          <option value="buyer_contractor">קונה מקבלן</option>
        </select>
      </div>

      <!-- Multi-party list -->
      <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:10px;flex-wrap:wrap;gap:6px;">
        <div style="font-size:.8rem;font-weight:700;color:var(--muted);display:flex;align-items:center;gap:6px;">
          <span>👥</span> צדדים לעסקה
          <span id="party-count-badge" style="background:#eff6ff;color:#1e40af;font-size:.65rem;font-weight:800;
            padding:1px 8px;border-radius:99px;">0</span>
        </div>
        <div style="font-size:.68rem;color:var(--muted);">שם מלא + תעודת זהות לכל צד</div>
      </div>

      <!-- Column hints (desktop) -->
      <div style="display:grid;grid-template-columns:1fr 1fr auto;gap:10px;padding:0 14px 6px;"
        class="party-col-heads" aria-hidden="true">
        <span style="font-size:.65rem;font-weight:700;color:var(--muted);text-transform:uppercase;letter-spacing:.05em;">שם מלא</span>
        <span style="font-size:.65rem;font-weight:700;color:var(--muted);text-transform:uppercase;letter-spacing:.05em;">תעודת זהות</span>
        <span></span>
      </div>

      <!-- Dynamic party rows container -->
      <div id="party-rows"></div>

      <!-- Add button -->
      <button id="party-add-btn" onclick="partyAdd()">
        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor"
          stroke-width="2.5" stroke-linecap="round">
          <line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/>
        </svg>
        הוסף לקוח
      </button>

      <!-- Hidden legacy input kept for backward-compat with updateState -->
      <input type="hidden" id="clientName" value=""/>

      <div class="divider"></div>
      <div style="font-size:0.8rem;font-weight:700;color:var(--muted);margin-bottom:12px;display:flex;align-items:center;gap:6px;">
        <span>📞</span> פרטי התקשרות
      </div>
      <div class="form-grid">
        <div class="form-group">
          <label>טלפון נייד</label>
          <div style="position:relative;">
            <span style="position:absolute;right:12px;top:50%;transform:translateY(-50%);color:var(--muted);font-size:0.85rem;pointer-events:none;">📱</span>
            <input type="tel" id="clientPhone" placeholder="050-0000000" oninput="updateState()"
              style="padding-right:34px;" dir="ltr"/>
          </div>
        </div>
        <div class="form-group">
          <label>דואר אלקטרוני</label>
          <div style="position:relative;">
            <span style="position:absolute;right:12px;top:50%;transform:translateY(-50%);color:var(--muted);font-size:0.85rem;pointer-events:none;">✉️</span>
            <input type="email" id="clientEmail" placeholder="israel@example.com" oninput="updateState()"
              style="padding-right:34px;" dir="ltr"/>
          </div>
        </div>
      </div>

      <div class="divider"></div>
      <div style="font-size:0.8rem;font-weight:700;color:var(--muted);margin-bottom:12px;display:flex;align-items:center;gap:6px;">
        <span>🏠</span> כתובת מגורים
      </div>
      <div class="form-grid-3">
        <div class="form-group" style="grid-column:span 1;">
          <label>עיר מגורים</label>
          <div class="ac-wrap">
            <input type="text" id="clientCity" class="ac-input" placeholder="התחל להקליד עיר..." autocomplete="off"
              oninput="acHandleInput('clientCity')" onkeydown="acHandleKey(event,'clientCity')" onblur="acHandleBlur('clientCity')"/>
            <div class="ac-dropdown" id="ac-dropdown-clientCity" style="display:none;"></div>
          </div>
          <div class="ac-hint" id="ac-hint-clientCity"></div>
        </div>
        <div class="form-group" style="grid-column:span 1;">
          <label>רחוב</label>
          <div class="ac-wrap">
            <input type="text" id="clientStreet" class="ac-input" placeholder="התחל להקליד רחוב..." autocomplete="off"
              oninput="acHandleInput('clientStreet')" onkeydown="acHandleKey(event,'clientStreet')" onblur="acHandleBlur('clientStreet')"/>
            <div class="ac-dropdown" id="ac-dropdown-clientStreet" style="display:none;"></div>
          </div>
          <div class="ac-hint" id="ac-hint-clientStreet"></div>
        </div>
        <div class="form-group" style="grid-column:span 1;">
          <label>מספר בית / דירה</label>
          <input type="text" id="clientHouseNum" placeholder="12 / 3" oninput="updateState()"/>
        </div>
        <div class="form-group" style="grid-column:span 1;">
          <label>מיקוד</label>
          <input type="text" id="clientZip" placeholder="6120001" oninput="updateState()" dir="ltr"/>
        </div>
        <div class="form-group" style="grid-column:span 2;">
          <label>כתובת מלאה (תיאור חופשי)</label>
          <input type="text" id="clientAddress" placeholder="לדוגמה: הרצל 12 דירה 3, תל אביב 6120001" oninput="updateState()"/>
        </div>
      </div>
    </div>

    <div class="card">
      <div class="card-title">💸 נתונים פיננסיים</div>
      <div class="form-grid">
        <div class="form-group">
          <label>מחיר העסקה (₪)</label>
          <div class="ils-input-wrap">
            <span class="ils-prefix">₪</span>
            <input type="number" id="price" placeholder="2000000" oninput="updateState()"/>
          </div>
        </div>
        <div class="form-group">
          <label>משכנתא קונה (₪)</label>
          <div class="ils-input-wrap">
            <span class="ils-prefix">₪</span>
            <input type="number" id="buyerMortgage" placeholder="0" oninput="updateState()"/>
          </div>
        </div>
        <div class="form-group">
          <label>משכנתא מוכר לסילוק (₪)</label>
          <div class="ils-input-wrap">
            <span class="ils-prefix">₪</span>
            <input type="number" id="sellerMortgage" placeholder="0" oninput="updateState()"/>
          </div>
        </div>
      </div>
    </div>

    <div class="card">
      <div class="card-title">🏠 מאפייני הנכס</div>
      <div class="toggle-row" style="background: #fffbeb; border-color: #fde68a;">
        <div>
          <div class="toggle-label" style="color:#92400e;">⚠️ הסכם שכר טרחה נחתם</div>
          <div style="font-size:0.75rem;color:#b45309;margin-top:2px;">חובה לפני הפעלת המודולים</div>
        </div>
        <label class="toggle-switch">
          <input type="checkbox" id="feeAgreement" onchange="updateState()"/>
          <span class="toggle-slider"></span>
        </label>
      </div>

      <div class="divider"></div>

      <div class="form-grid">
        <div class="toggle-row">
          <span class="toggle-label">תושב חוץ / Foreign Resident</span>
          <label class="toggle-switch">
            <input type="checkbox" id="foreignResident" onchange="updateState()"/>
            <span class="toggle-slider"></span>
          </label>
        </div>
        <div class="toggle-row">
          <span class="toggle-label">נכס מושכר / Rented</span>
          <label class="toggle-switch">
            <input type="checkbox" id="rented" onchange="updateState()"/>
            <span class="toggle-slider"></span>
          </label>
        </div>
        <div class="toggle-row">
          <span class="toggle-label">התחדשות עירונית / Urban Renewal</span>
          <label class="toggle-switch">
            <input type="checkbox" id="urbanRenewal" onchange="updateState()"/>
            <span class="toggle-slider"></span>
          </label>
        </div>
        <div class="toggle-row">
          <span class="toggle-label">משפר דיור / Upgrader</span>
          <label class="toggle-switch">
            <input type="checkbox" id="upgrader" onchange="updateState()"/>
            <span class="toggle-slider"></span>
          </label>
        </div>
      </div>
    </div>

    <div id="onboarding-summary" style="display:none;" class="card">
      <div class="card-title">✅ סיכום תיק פתוח</div>
      <div id="summary-content" style="font-size:0.875rem;line-height:2;"></div>
    </div>
  </div>

  <!-- =========== TAB 2: PLANNING =========== -->
  <div id="tab-planning" class="tab-view" style="display:none;">
    <div id="gate-planning"></div>

    <div class="card">
      <div class="card-title">📍 כתובת הנכס ואחזור גוש/חלקה</div>
      <div class="form-grid-3">
        <div class="form-group">
          <label>עיר</label>
          <div class="ac-wrap">
            <input type="text" id="propCity" class="ac-input" placeholder="התחל להקליד עיר..." autocomplete="off"
              oninput="acHandleInput('propCity')" onkeydown="acHandleKey(event,'propCity')" onblur="acHandleBlur('propCity')"/>
            <div class="ac-dropdown" id="ac-dropdown-propCity" style="display:none;"></div>
          </div>
          <div class="ac-hint" id="ac-hint-propCity"></div>
        </div>
        <div class="form-group">
          <label>רחוב</label>
          <div class="ac-wrap">
            <input type="text" id="propStreet" class="ac-input" placeholder="התחל להקליד רחוב..." autocomplete="off"
              oninput="acHandleInput('propStreet')" onkeydown="acHandleKey(event,'propStreet')" onblur="acHandleBlur('propStreet')"/>
            <div class="ac-dropdown" id="ac-dropdown-propStreet" style="display:none;"></div>
          </div>
          <div class="ac-hint" id="ac-hint-propStreet"></div>
        </div>
        <div class="form-group">
          <label>מספר בית</label>
          <input type="text" id="propNumber" placeholder="1" onblur="fetchGushChelka()"/>
        </div>
        <div class="form-group">
          <label>גוש</label>
          <input type="text" id="propGush" placeholder="אוטומטי" readonly/>
        </div>
        <div class="form-group">
          <label>חלקה</label>
          <input type="text" id="propChelka" placeholder="אוטומטי" readonly/>
        </div>
      </div>
      <div class="gis-status" id="gis-status">
        <span>הזן כתובת מלאה ולחץ Tab מחוץ לשדה מספר הבית לאחזור אוטומטי</span>
      </div>
    </div>

    <div class="card">
      <div class="card-title">🗂️ קישורי מידע מקרקעין</div>
      <div class="btn-group">
        <button class="btn btn-primary" onclick="openGovmap()">🌐 Govmap</button>
        <button class="btn btn-primary" id="agent-btn" onclick="agentFetchGushChelka()"
          style="background:linear-gradient(135deg,#1e3a5f,#2563eb);position:relative;overflow:hidden;">
          🔍 אתר גוש חלקה לכתובת
        </button>
        <button class="btn btn-secondary" onclick="window.open('https://mavat.iplan.gov.il/SV1','_blank')">📐 מבא״ת (Mavat)</button>
        <button class="btn btn-secondary" onclick="openBuildingFile()">🔍 תיק בניין בגוגל</button>
        <button class="btn btn-streetview" onclick="openStreetView()" id="sv-btn">
          <span class="sv-pegman">🧍</span> Street View
        </button>
      </div>
      <div style="margin-top:14px;font-size:0.8rem;color:var(--muted);">
        הגוש והחלקה יושלמו אוטומטית בקישור Govmap לאחר אחזור מוצלח.
      </div>
    </div>

    <!-- Street View Modal -->
    <div id="sv-modal" style="display:none;">
      <div id="sv-backdrop" onclick="closeStreetView()"></div>
      <div id="sv-panel">
        <div id="sv-header">
          <div id="sv-header-left">
            <span id="sv-pegman-icon">🧍</span>
            <div>
              <div id="sv-title">Google Street View</div>
              <div id="sv-address-label"></div>
            </div>
          </div>
          <div id="sv-header-right">
            <button class="sv-hbtn" id="sv-ext-btn" onclick="openStreetViewExternal()" title="פתח ב-Google Maps">↗</button>
            <button class="sv-hbtn" onclick="closeStreetView()">✕</button>
          </div>
        </div>
        <div id="sv-body">
          <div id="sv-pano"></div>
          <div id="sv-status">
            <div class="sv-spinner"></div>
            <div>טוען תצוגת רחוב…</div>
          </div>
        </div>
      </div>
    </div>

    <div class="card">
      <div class="card-title">📋 בדיקות תכנוניות מומלצות</div>
      <div id="planning-checks">
        <div class="checklist-item">
          <input type="checkbox" id="chk-zoning"/>
          <label for="chk-zoning"><span class="task-tag tag-blue">תב״ע</span> בדיקת תוכנית בניין עיר – ייעוד, זכויות בנייה ואחוזי בנייה מנוצלים</label>
        </div>
        <div class="checklist-item">
          <input type="checkbox" id="chk-permits"/>
          <label for="chk-permits"><span class="task-tag tag-blue">היתר</span> בדיקת היתרי בנייה קיימים ותאימותם לנכס בפועל</label>
        </div>
        <div class="checklist-item">
          <input type="checkbox" id="chk-liens"/>
          <label for="chk-liens"><span class="task-tag tag-red">עיקולים</span> נסח טאבו / רישום בית משותף / שעבודים ועיקולים</label>
        </div>
        <div class="checklist-item">
          <input type="checkbox" id="chk-munic"/>
          <label for="chk-munic"><span class="task-tag tag-yellow">עיריה</span> אישור היטל השבחה + אישור עירייה לדירה ללא חובות</label>
        </div>
      </div>
    </div>
  </div>

  <!-- =========== TAB 3: FINANCE =========== -->
  <div id="tab-finance" class="tab-view" style="display:none;">
    <div id="gate-finance"></div>

    <div class="card">
      <div class="card-title">📊 ניתוח מימוני</div>
      <div id="finance-stats" style="display:grid;grid-template-columns:repeat(3,1fr);gap:16px;margin-bottom:20px;" class="finance-stats-grid"></div>
      <div id="finance-alerts"></div>
    </div>

    <!-- ── Mortgage inputs ── -->
    <div class="card">
      <div class="card-title">🏦 נתוני משכנתא ומימון</div>
      <div class="form-grid">
        <div class="form-group">
          <label>מחיר העסקה (₪) — מעודכן מפתיחת תיק</label>
          <div class="ils-input-wrap">
            <span class="ils-prefix">₪</span>
            <input type="number" id="fin-price-mirror" placeholder="---" readonly
              style="background:#f1f5f9;color:var(--muted);" tabindex="-1"/>
          </div>
        </div>
        <div class="form-group">
          <label>משכנתא קונה (₪)</label>
          <div class="ils-input-wrap">
            <span class="ils-prefix">₪</span>
            <input type="number" id="fin-buyer-mort" placeholder="0"
              oninput="finSyncMortgage('buyerMortgage', this.value)"/>
          </div>
        </div>
        <div class="form-group">
          <label>משכנתא מוכר לסילוק (₪)</label>
          <div class="ils-input-wrap">
            <span class="ils-prefix">₪</span>
            <input type="number" id="fin-seller-mort" placeholder="0"
              oninput="finSyncMortgage('sellerMortgage', this.value)"/>
          </div>
        </div>
        <div class="form-group">
          <label>הון עצמי (₪) — מחושב</label>
          <div class="ils-input-wrap">
            <span class="ils-prefix">₪</span>
            <input type="number" id="fin-equity" placeholder="---" readonly
              style="background:#f1f5f9;color:var(--muted);" tabindex="-1"/>
          </div>
        </div>
      </div>
    </div>

    <div id="upgrader-section" style="display:none;" class="card">
      <div class="card-title">🏡 ספירת עצר – משפר דיור (18 חודש)</div>
      <div class="timer-block">
        <div style="font-size:0.9rem;color:rgba(255,255,255,0.7);text-align:center;">מניין ימים מהיום עד תום חלון 18 חודש</div>
        <div class="timer-digits" id="timer-digits"></div>
        <div style="text-align:center;font-size:0.78rem;color:rgba(255,255,255,0.5);">תאריך פתיחת תיק: <span id="timer-start-date"></span> | תאריך סיום: <span id="timer-end-date"></span></div>
        <div class="progress-bar-wrap">
          <div class="progress-bar-fill" id="timer-progress"></div>
        </div>
        <div style="display:flex;justify-content:space-between;margin-top:6px;font-size:0.72rem;color:rgba(255,255,255,0.4);">
          <span>התחלה</span><span>18 חודש</span>
        </div>
      </div>
      <div style="margin-top:14px;font-size:0.82rem;color:var(--muted);">
        ⚠️ על משפר דיור למכור את דירתו הקודמת בתוך 18 חודש ממועד רכישת הדירה החדשה על מנת ליהנות מפטור ממס רכישה מדרגה ראשונה.
      </div>
    </div>

    <!-- ═══ Payment Schedule Builder ═══ -->
    <div class="card" id="psch-card">

      <!-- Header -->
      <div class="psch-header">
        <div class="psch-header-title">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor"
            stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
            style="color:var(--brand-light)">
            <rect x="3" y="4" width="18" height="18" rx="2"/><line x1="16" y1="2" x2="16" y2="6"/>
            <line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/>
            <line x1="8" y1="14" x2="8" y2="14"/><line x1="12" y1="14" x2="12" y2="14"/>
            <line x1="16" y1="14" x2="16" y2="14"/>
          </svg>
          פריסת תשלומים
        </div>
        <div class="psch-header-meta">
          <span style="font-size:.75rem;color:var(--muted);">שווי עסקה:</span>
          <span class="psch-price-badge" id="psch-price-badge">---</span>
          <button class="psch-reset-btn" onclick="pschReset()">↺ אפס</button>
        </div>
      </div>

      <!-- Desktop column headers -->
      <div class="psch-col-heads" aria-hidden="true">
        <div class="psch-col-head">סכום (₪)</div>
        <div class="psch-col-head">מועד / תנאי</div>
        <div class="psch-col-head">הערות משפטיות</div>
        <div></div>
      </div>

      <!-- Dynamic rows -->
      <div id="psch-rows"></div>

      <!-- Add row button -->
      <button id="psch-add-btn" onclick="pschAddRow(null)">
        <svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor"
          stroke-width="2.5" stroke-linecap="round">
          <line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/>
        </svg>
        הוסף תשלום
      </button>

      <!-- Summary footer -->
      <div id="psch-footer" class="state-empty">
        <span class="psch-foot-icon" id="psch-foot-icon">📊</span>
        <div class="psch-foot-main">
          <div class="psch-foot-label" id="psch-foot-label">הזן סכומים כדי לבדוק פריסה</div>
          <div class="psch-foot-sub" id="psch-foot-sub"></div>
        </div>
        <div class="psch-prog-track">
          <div class="psch-prog-fill" id="psch-prog-fill" style="width:0%;background:#94a3b8;"></div>
        </div>
        <div class="psch-pct-lbl" id="psch-pct-lbl"></div>
      </div>

    </div>
  </div>

  <!-- ═══════════════════════════════════════════════════════
       TAB: מיסוי — Dynamic Engine
  ═══════════════════════════════════════════════════════ -->
  <div id="tab-tax" class="tab-view" style="display:none;">
    <div id="gate-tax"></div>
    <div id="tax-engine-root"></div>
  </div>

  <!-- ═══════════════ TAB: מועדים ═══════════════ -->
  <div id="tab-deadlines" class="tab-view" style="display:none;">
    <div id="gate-deadlines"></div>

    <!-- Date inputs card -->
    <div class="card">
      <div class="card-title">📅 תאריכי בסיס לחישוב מועדים</div>
      <div class="form-grid">
        <div class="form-group">
          <label>תאריך חתימת חוזה</label>
          <input type="date" class="dl-date-input" id="dl-contract-date"
            oninput="dlSaveAndRender()"/>
        </div>
        <div class="form-group">
          <label>תוקף אישור עירייה</label>
          <input type="date" class="dl-date-input" id="dl-municipality-date"
            oninput="dlSaveAndRender()"/>
        </div>
      </div>
    </div>

    <!-- Deadlines dashboard -->
    <div class="card">
      <div class="card-title">⏰ לוח מועדים מחושב</div>
      <div id="dl-rows-container">
        <div style="color:var(--muted);font-size:.875rem;padding:16px 0;">
          הזן תאריך חתימת חוזה כדי לחשב מועדים אוטומטית
        </div>
      </div>
    </div>

    <!-- ICS export + backup row -->
    <div class="card">
      <div class="card-title">🗓️ ייצוא ליומן</div>
      <p style="font-size:.82rem;color:var(--muted);margin-bottom:16px;">
        ייצא את כל המועדים — תשלומים, דיווח מס, אישור עירייה ומשפר דיור — לקובץ ICS שניתן לייבא ל-Outlook, Google Calendar ו-Apple Calendar.
      </p>
      <div style="display:flex;gap:10px;flex-wrap:wrap;">
        <button class="action-btn action-btn-blue" onclick="exportICS()">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><rect x="3" y="4" width="18" height="18" rx="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>
          הורד deal-deadlines.ics
        </button>
        <button class="action-btn action-btn-amber" onclick="openBackupModal()">
          🔧 גיבוי ושחזור נתונים
        </button>
      </div>
    </div>

  </div>

  <!-- =========== TAB 4: LEGAL =========== -->
  <div id="tab-legal" class="tab-view" style="display:none;">
    <div id="gate-legal"></div>

    <div id="legal-content">
      <div class="card">
        <div class="card-title">🛡️ משימות משפטיות דינמיות</div>
        <div id="dynamic-tasks">
          <div style="color:var(--muted);font-size:0.875rem;padding:16px 0;">
            ⬅️ מלא את פרטי התיק בטאב "פתיחת תיק" כדי לראות משימות רלוונטיות
          </div>
        </div>
      </div>

      <div class="card">
        <div class="card-title">📋 משימות בסיס – כל עסקה</div>
        <div class="checklist-item">
          <input type="checkbox" id="base1"/>
          <label for="base1"><span class="task-tag tag-blue">טאבו</span> הזמנת נסח טאבו עדכני (לא ישן מ-30 יום) / רישום בית משותף</label>
        </div>
        <div class="checklist-item">
          <input type="checkbox" id="base2"/>
          <label for="base2"><span class="task-tag tag-blue">ת״ח</span> בדיקת תוכניות חלות על הנכס במבא״ת ובוועדה המקומית</label>
        </div>
        <div class="checklist-item">
          <input type="checkbox" id="base3"/>
          <label for="base3"><span class="task-tag tag-yellow">מיסים</span> בירור שומות ארנונה, היטל השבחה, ומצב חשבונות ספקים</label>
        </div>
        <div class="checklist-item">
          <input type="checkbox" id="base4"/>
          <label for="base4"><span class="task-tag tag-blue">הסכם</span> בדיקת טיוטת הסכם מכר – סעיפי פיצוי, מסירה, ואחריות</label>
        </div>
        <div class="checklist-item">
          <input type="checkbox" id="base5"/>
          <label for="base5"><span class="task-tag tag-blue">הע"א</span> רישום הערת אזהרה בטאבו לאחר חתימת חוזה</label>
        </div>
        <div class="checklist-item">
          <input type="checkbox" id="base6"/>
          <label for="base6"><span class="task-tag tag-red">ביטוח</span> ביטוח מבנה ו/או מבנה+תכולה מתואם עם הלווי המשכנתאי</label>
        </div>
      </div>
    </div>
  </div>


  <!-- ══════════════════════════════════════════════════════
       TAB: DOCUMENT CENTER
  ══════════════════════════════════════════════════════ -->
  <div id="tab-docs" class="tab-view" style="display:none;">
    <div class="card" style="max-width:720px;margin:0 auto;">

      <!-- Header row -->
      <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:20px;flex-wrap:wrap;gap:10px;">
        <div>
          <div class="card-title" style="margin-bottom:4px;">📁 מרכז מסמכים</div>
          <div style="font-size:.8rem;color:var(--muted);">
            סמן ✓ כל מסמך שנאסף. ניתן לערוך שמות ולהוסיף מסמכים.
          </div>
        </div>
        <!-- Progress badge -->
        <div id="docs-progress-badge" style="
          background:linear-gradient(135deg,#1e3a5f,#2563eb);
          color:#fff;border-radius:20px;padding:6px 16px;
          font-size:.85rem;font-weight:700;white-space:nowrap;
          box-shadow:0 2px 8px rgba(37,99,235,.3);
        ">0 / 0 מסמכים</div>
      </div>

      <!-- Progress bar -->
      <div style="height:6px;background:#e2e8f0;border-radius:99px;margin-bottom:22px;overflow:hidden;">
        <div id="docs-progress-bar" style="
          height:100%;width:0%;
          background:linear-gradient(90deg,#2563eb,#16a34a);
          border-radius:99px;transition:width .4s cubic-bezier(.4,0,.2,1);
        "></div>
      </div>

      <!-- Checklist -->
      <div id="docs-list" style="display:flex;flex-direction:column;gap:6px;"></div>

      <!-- Add button -->
      <button onclick="docsAddRow()" style="
        margin-top:18px;width:100%;
        display:flex;align-items:center;justify-content:center;gap:8px;
        padding:11px;border-radius:10px;
        border:2px dashed #cbd5e1;
        background:transparent;color:var(--muted);
        font-family:inherit;font-size:.875rem;font-weight:600;
        cursor:pointer;transition:all .15s;
      "
      onmouseover="this.style.borderColor='#2563eb';this.style.color='#2563eb';this.style.background='#eff6ff'"
      onmouseout="this.style.borderColor='#cbd5e1';this.style.color='var(--muted)';this.style.background='transparent'">
        <span style="font-size:1.1rem;line-height:1">＋</span>
        הוספת מסמך
      </button>

    </div>
  </div>

  <!-- Backup/Restore Modal -->
  <div id="backup-modal-overlay" onclick="closeBackupModal()">
    <div id="backup-modal" onclick="event.stopPropagation()">
      <h3>🔧 גיבוי ושחזור נתונים</h3>
      <p>ייצא את כל התיקים לקובץ JSON לגיבוי, או ייבא קובץ גיבוי קיים.</p>
      <div class="backup-btn-row">
        <button class="action-btn action-btn-green" style="width:100%;justify-content:center;" onclick="exportBackup()">
          📥 גיבוי נתונים (Export JSON)
        </button>
        <label class="action-btn action-btn-amber" style="width:100%;justify-content:center;cursor:pointer;">
          📤 שחזור נתונים (Import JSON)
          <input type="file" accept=".json" id="import-file-input-modal" style="display:none;"
            onchange="importBackup(this)"/>
        </label>
        <button class="action-btn" style="width:100%;justify-content:center;background:#f1f5f9;color:var(--muted);border:1.5px solid var(--border);" onclick="closeBackupModal()">
          סגור
        </button>
      </div>
    </div>
  </div>

  <!-- ═══════════ LAWYER PORTAL TAB ═══════════════════════════ -->
  <div id="tab-portal" class="tab-view" style="display:none;">

    <!-- Hero: code generator -->
    <div class="pt-hero">
      <div style="display:flex;align-items:flex-start;justify-content:space-between;flex-wrap:wrap;gap:14px;position:relative;z-index:1;">
        <div>
          <div style="font-size:1.1rem;font-weight:800;margin-bottom:5px;">🔑 פורטל גישה ללקוח</div>
          <div style="font-size:.82rem;opacity:.6;line-height:1.5;">צור קוד ייחודי ושתף עם הלקוח — הוא יוכל לצפות בתיק שלו בזמן אמת</div>
        </div>
        <button onclick="ptGen()" style="padding:11px 24px;border-radius:11px;
          background:rgba(255,255,255,.15);border:1.5px solid rgba(255,255,255,.3);
          color:#fff;font-family:inherit;font-size:.88rem;font-weight:700;
          cursor:pointer;transition:all .15s;white-space:nowrap;position:relative;z-index:1;"
          onmouseover="this.style.background='rgba(255,255,255,.27)'"
          onmouseout="this.style.background='rgba(255,255,255,.15)'">
          ✨ צור קוד גישה ללקוח
        </button>
      </div>

      <div id="pt-code-sec" style="display:none;margin-top:22px;">
        <div style="font-size:.72rem;opacity:.55;margin-bottom:8px;letter-spacing:.05em;position:relative;z-index:1;">קוד הגישה של הלקוח:</div>
        <div class="pt-code-box" id="pt-code-disp">— — — — — —</div>
        <div style="font-size:.72rem;opacity:.55;margin-bottom:6px;position:relative;z-index:1;">קישור ישיר לפורטל:</div>
        <div class="pt-link-box" id="pt-link-disp">—</div>
        <div class="pt-actions">
          <button class="pt-btn" onclick="ptCopyLink()">📋 העתק קישור</button>
          <button class="pt-btn" onclick="ptCopyCode()">🔢 העתק קוד</button>
          <button class="pt-btn pt-btn-prev" onclick="ptPreview()">👁 תצוגת לקוח Preview</button>
        </div>
        <div class="pt-ok" id="pt-ok">✅ הועתק ללוח!</div>
      </div>
    </div>

    <!-- Document manager -->
    <div class="card">
      <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:18px;flex-wrap:wrap;gap:10px;">
        <div class="card-title" style="margin-bottom:0;">📋 ניהול מסמכים — תצוגת עו״ד</div>
        <div id="pt-badge" style="
          background:linear-gradient(135deg,#0f2744,#2563eb);
          color:#fff;border-radius:20px;padding:5px 16px;
          font-size:.78rem;font-weight:700;
        ">0 / 6 התקבלו</div>
      </div>
      <table class="pt-tbl">
        <thead>
          <tr>
            <th>מסמך נדרש</th>
            <th style="text-align:center;">סטטוס</th>
            <th style="text-align:center;">פעולה</th>
          </tr>
        </thead>
        <tbody id="pt-tbody"></tbody>
      </table>
    </div>

  </div>
  <!-- ═══════════ END PORTAL TAB ══════════════════════════════ -->
</main>

<script>
// ============================================================
// STATE
// ============================================================
const state = {
  clientName: '',  // kept for compat — primary display name
  parties: [],      // [{ name, idNum }]
  clientPhone: '',
  clientEmail: '',
  clientCity: '',
  clientStreet: '',
  clientHouseNum: '',
  clientZip: '',
  clientAddress: '',
  role: '',
  price: 0,
  buyerMortgage: 0,
  sellerMortgage: 0,
  feeAgreement: false,
  foreignResident: false,
  rented: false,
  urbanRenewal: false,
  upgrader: false,
  city: '',
  street: '',
  number: '',
  gush: '',
  chelka: '',
  propertyType: '',    // apartment|house|land|commercial|building
  openedAt: new Date()
};

// ============================================================
// MOBILE SIDEBAR TOGGLE
// ============================================================
function toggleSidebar() {
  const sidebar  = document.getElementById('sidebar');
  const overlay  = document.getElementById('sidebar-overlay');
  const burger   = document.getElementById('hamburger');
  const isOpen   = sidebar.classList.contains('open');
  if (isOpen) { closeSidebar(); } else {
    sidebar.classList.add('open');
    overlay.classList.add('active');
    burger.classList.add('open');
  }
}

function closeSidebar() {
  document.getElementById('sidebar').classList.remove('open');
  document.getElementById('sidebar-overlay').classList.remove('active');
  document.getElementById('hamburger').classList.remove('open');
}


const TABS = {
  onboarding: { title: '📋 פתיחת תיק',        sub: 'הגדרת עסקה חדשה ופרטי לקוח' },
  planning:   { title: '🗺️ תכנון וקניין',       sub: 'GIS, גוש/חלקה ובדיקות תכנוניות' },
  finance:    { title: '🏦 מימון',               sub: 'LTV, הון עצמי, משכנתאות ופריסת תשלומים' },
  tax:        { title: '🧮 מיסוי',               sub: 'מס רכישה ומס שבח — מחשבון דינמי לפי תפקיד' },
  deadlines:  { title: '📅 מועדים ותזכורות',     sub: 'לוח מועדים, ספירות לאחור וייצוא ליומן' },
  legal:      { title: '🛡️ הגנות משפטיות',      sub: 'רשימת משימות משפטיות דינמית' },
  docs:       { title: '📁 מרכז מסמכים',         sub: 'מעקב איסוף מסמכים לעסקה' },
  portal:     { title: '🔑 פורטל לקוח',           sub: 'ניהול גישת לקוח, מסמכים ושיתוף' },
};

function switchTab(tab) {
  // Hide dashboard, show case workspace
  const dv = document.getElementById('dashboard-view');
  if (dv) dv.style.display = 'none';
  const mainEl = document.querySelector('main');
  // Show the tab nav elements
  document.getElementById('bottom-nav').style.display = '';

  Object.keys(TABS).forEach(t => {
    const tabEl = document.getElementById('tab-' + t);
    if (tabEl) tabEl.style.display = (t === tab) ? '' : 'none';
    const nav = document.getElementById('nav-' + t);
    if (nav) nav.classList.toggle('active', t === tab);
    const bnav = document.getElementById('bnav-' + t);
    if (bnav) bnav.classList.toggle('active', t === tab);
  });
  document.getElementById('main-title').textContent = TABS[tab].title;
  document.getElementById('main-sub').textContent = TABS[tab].sub;

  // Show save+back buttons
  const saveBtn = document.getElementById('save-case-btn');
  const backBtn = document.getElementById('back-to-dashboard');
  if (saveBtn) saveBtn.style.display = 'inline-flex';
  if (backBtn) backBtn.style.display = 'inline-flex';

  closeSidebar();

  if (tab === 'finance')   { renderFinance(); setTimeout(function(){ pschInit(); pschCalc(); }, 0); }
  if (tab === 'tax')       renderTax();
  if (tab === 'legal')     renderLegal();
  if (tab === 'planning')  renderPlanningGate();
  if (tab === 'docs')      docsInit();
  if (tab === 'deadlines') { renderGate('gate-deadlines'); dlRender(); }
  if (tab === 'portal')    ptInit();
}

function showDashboard() {
  // Hide all tabs
  Object.keys(TABS).forEach(t => {
    const tabEl = document.getElementById('tab-' + t);
    if (tabEl) tabEl.style.display = 'none';
    const nav = document.getElementById('nav-' + t);
    if (nav) nav.classList.remove('active');
    const bnav = document.getElementById('bnav-' + t);
    if (bnav) bnav.classList.remove('active');
  });
  // Show dashboard
  const dv = document.getElementById('dashboard-view');
  if (dv) dv.style.display = 'flex';
  document.getElementById('main-title').textContent = '🏠 דשבורד תיקים';
  document.getElementById('main-sub').textContent = 'ניהול כל עסקאות הנדל"ן';
  // Hide save+back in dashboard
  const saveBtn = document.getElementById('save-case-btn');
  const backBtn = document.getElementById('back-to-dashboard');
  if (saveBtn) saveBtn.style.display = 'none';
  if (backBtn) backBtn.style.display = 'none';
  closeSidebar();
  renderDashboard();
}

// ============================================================
// STATE UPDATE
// ============================================================
function updateState() {
  // Collect multi-party list
  state.parties = partyCollect();
  // Keep legacy clientName = first party's name for compat
  state.clientName = state.parties.length ? state.parties[0].name : '';
  document.getElementById('clientName').value = state.clientName;
  state.clientPhone    = document.getElementById('clientPhone').value.trim();
  state.clientEmail    = document.getElementById('clientEmail').value.trim();
  state.clientCity     = document.getElementById('clientCity').value.trim();
  state.clientStreet   = document.getElementById('clientStreet').value.trim();
  state.clientHouseNum = document.getElementById('clientHouseNum').value.trim();
  state.clientZip      = document.getElementById('clientZip').value.trim();
  state.clientAddress  = document.getElementById('clientAddress').value.trim();
  state.propertyType   = (document.querySelector('#pt-grid .pt-tile.on') || {}).dataset?.pt || state.propertyType || '';
  state.role           = document.getElementById('clientRole').value;
  state.price          = parseFloat(document.getElementById('price').value) || 0;
  state.buyerMortgage  = parseFloat(document.getElementById('buyerMortgage').value) || 0;
  state.sellerMortgage = parseFloat(document.getElementById('sellerMortgage').value) || 0;
  state.feeAgreement   = document.getElementById('feeAgreement').checked;
  state.foreignResident= document.getElementById('foreignResident').checked;
  state.rented         = document.getElementById('rented').checked;
  state.urbanRenewal   = document.getElementById('urbanRenewal').checked;
  const prevUpgrader   = state.upgrader;
  state.upgrader       = document.getElementById('upgrader').checked;
  // Reset 18-month clock when upgrader is first enabled
  if (state.upgrader && !prevUpgrader) state.openedAt = new Date();
  state.city           = document.getElementById('propCity')?.value.trim() || state.city;
  state.street         = document.getElementById('propStreet')?.value.trim() || state.street;
  state.number         = document.getElementById('propNumber')?.value.trim() || state.number;

  updateSidebar();
  updateChips();
  updateSummary();
  updateLegalBadge();
  if (typeof pschCalc === 'function') pschCalc();
  const _ft = document.getElementById('tab-finance');
  if (_ft && _ft.style.display !== 'none') renderFinance();
  const _tt = document.getElementById('tab-tax');
  if (_tt && _tt.style.display !== 'none') renderTax();
  const _dt = document.getElementById('tab-deadlines');
  if (_dt && _dt.style.display !== 'none') dlRender();
}

function updateSidebar() {
  const dot = document.getElementById('fee-dot');
  const txt = document.getElementById('fee-status-txt');
  const mini = document.getElementById('client-name-mini');
  if (state.feeAgreement) {
    dot.style.background = '#22c55e';
    dot.style.boxShadow = '0 0 6px #22c55e';
    txt.textContent = 'שכ״ט נחתם ✓';
  } else {
    dot.style.background = '#ef4444';
    dot.style.boxShadow = '0 0 6px #ef4444';
    txt.textContent = 'שכ״ט לא נחתם';
  }
  // Show all party names in sidebar mini
  if (state.parties && state.parties.length) {
    var names = state.parties.map(function(p){ return p.name; }).filter(Boolean);
    var display = names.join(' · ') || 'טרם הוזן לקוח';
    mini.textContent = state.clientPhone ? display + ' · ' + state.clientPhone : display;
  } else {
    mini.textContent = 'טרם הוזן לקוח';
  }
}

function updateChips() {
  const roleChip = document.getElementById('role-chip');
  const priceChip = document.getElementById('price-chip');
  const roleLabels = { seller: 'מוכר', buyer_2nd: 'קונה יד שנייה', buyer_contractor: 'קונה מקבלן' };
  if (state.role) {
    roleChip.textContent = '👤 ' + roleLabels[state.role];
    roleChip.style.display = '';
  } else {
    roleChip.style.display = 'none';
  }
  if (state.price > 0) {
    priceChip.textContent = '₪ ' + state.price.toLocaleString('he-IL');
    priceChip.style.display = '';
  } else {
    priceChip.style.display = 'none';
  }
}

function updateSummary() {
  const el = document.getElementById('onboarding-summary');
  const content = document.getElementById('summary-content');
  if ((!state.parties || !state.parties.length) && !state.clientName && !state.role) { el.style.display = 'none'; return; }
  el.style.display = '';
  const roleLabels = { seller: 'מוכר', buyer_2nd: 'קונה יד שנייה', buyer_contractor: 'קונה מקבלן' };
  const flags = [];
  if (state.foreignResident) flags.push('🌍 תושב חוץ');
  if (state.rented) flags.push('🔑 נכס מושכר');
  if (state.urbanRenewal) flags.push('🏗️ התחדשות עירונית');
  if (state.upgrader) flags.push('🏡 משפר דיור');
  content.innerHTML = `
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px 24px;" id="summary-grid">
      ${(state.parties && state.parties.length) ? `
        <div style="grid-column:1/-1;">
          <strong>👥 צדדים:</strong>
          ${state.parties.map(function(p,i){ return '<span style="display:inline-flex;align-items:center;gap:4px;margin-left:10px;">' + (i+1) + '. ' + (p.name||'---') + (p.idNum ? ' <span style="font-size:.75rem;color:var(--muted);background:#f1f5f9;padding:1px 6px;border-radius:4px;">' + p.idNum + '</span>' : '') + '</span>'; }).join('')}
        </div>` : `<div>👤 <strong>לקוח:</strong> ${state.clientName || '---'}</div>`}
      <div>🎭 <strong>תפקיד:</strong> ${roleLabels[state.role] || '---'}</div>
      ${state.clientPhone ? `<div>📱 <strong>נייד:</strong> <a href="tel:${state.clientPhone}" style="color:var(--brand-light);">${state.clientPhone}</a></div>` : ''}
      ${state.clientEmail ? `<div>✉️ <strong>מייל:</strong> <a href="mailto:${state.clientEmail}" style="color:var(--brand-light);">${state.clientEmail}</a></div>` : ''}
      ${state.clientAddress || (state.clientStreet && state.clientCity) ? `<div style="grid-column:1/-1;">🏠 <strong>כתובת מגורים:</strong> ${state.clientAddress || (state.clientStreet + ' ' + state.clientHouseNum + ', ' + state.clientCity + (state.clientZip ? ' ' + state.clientZip : ''))}</div>` : ''}
      <div>💰 <strong>מחיר:</strong> ₪${state.price.toLocaleString('he-IL')}</div>
      <div>🏦 <strong>משכנתא קונה:</strong> ₪${state.buyerMortgage.toLocaleString('he-IL')}</div>
      <div>🏛️ <strong>משכנתא מוכר:</strong> ₪${state.sellerMortgage.toLocaleString('he-IL')}</div>
      <div>⚖️ <strong>שכ״ט:</strong> ${state.feeAgreement ? '✅ נחתם' : '❌ לא נחתם'}</div>
      ${flags.length ? `<div style="grid-column:1/-1">🚩 <strong>דגלים:</strong> ${flags.join(' · ')}</div>` : ''}
    </div>`;
}

function updateLegalBadge() {
  const count = [state.foreignResident, state.rented, state.urbanRenewal, state.role === 'buyer_contractor']
    .filter(Boolean).length;
  const badge = document.getElementById('legal-badge');
  badge.style.display = count > 0 ? '' : 'none';
  badge.textContent = count;
  // Sync bottom nav badge
  const bbadge = document.getElementById('bnav-legal-badge');
  if (bbadge) { bbadge.style.display = count > 0 ? '' : 'none'; bbadge.textContent = count; }
}

// ============================================================
// FEE GATE RENDERER
// ============================================================
function renderGate(containerId) {
  const el = document.getElementById(containerId);
  if (!el) return;
  if (!state.feeAgreement) {
    el.innerHTML = `
      <div class="alert alert-red" style="margin-bottom:20px;border-width:2px;">
        <span class="alert-icon">🔒</span>
        <div>
          <strong>הסכם שכר טרחה לא נחתם!</strong><br/>
          עד לחתימת הסכם שכ״ט, המודול הזה מוצג במצב קריאה בלבד. חזור ל"פתיחת תיק" ואפשר את הטוגל.
        </div>
      </div>`;
  } else {
    el.innerHTML = '';
  }
}

function renderPlanningGate() { renderGate('gate-planning'); }

// ============================================================
// FINANCE TAB
// ============================================================
// Sync mortgage inputs ↔ state ↔ onboarding fields
function finSyncMortgage(field, rawVal) {
  const val = parseFloat(rawVal) || 0;
  state[field] = val;
  const ob = document.getElementById(field);
  if (ob && document.activeElement !== ob) ob.value = val || '';
  renderFinance();
}

function renderFinance() {
  renderGate('gate-finance');

  const price  = state.price;
  const buyerM = state.buyerMortgage;
  const sellM  = state.sellerMortgage;
  const equity = price - buyerM;
  const ltvRaw = price > 0 ? (buyerM / price) * 100 : 0;
  const ltv    = ltvRaw.toFixed(1);

  // Sync mirror inputs (don't stomp while user is typing)
  const elM = document.getElementById('fin-price-mirror');
  if (elM) elM.value = price || '';
  const elB = document.getElementById('fin-buyer-mort');
  if (elB && document.activeElement !== elB) elB.value = buyerM || '';
  const elS = document.getElementById('fin-seller-mort');
  if (elS && document.activeElement !== elS) elS.value = sellM || '';
  const elE = document.getElementById('fin-equity');
  if (elE) elE.value = equity > 0 ? equity : '';

  // KPI strip
  const ltvColor = ltvRaw > 70 ? '#dc2626' : ltvRaw > 50 ? '#d97706' : '#16a34a';
  const ltvStyle = ltvRaw > 70 ? 'border-color:#fca5a5;background:#fef2f2;' : '';
  const priceDisp = price >= 1e6 ? (price/1e6).toFixed(2)+'M' : price.toLocaleString('he-IL');

  document.getElementById('finance-stats').innerHTML = `
    <div class="stat-card">
      <div class="stat-num" style="color:var(--brand);">₪${priceDisp}</div>
      <div class="stat-lbl">מחיר עסקה</div>
    </div>
    <div class="stat-card" style="${ltvStyle}">
      <div class="stat-num" style="color:${ltvColor};">${ltv}%</div>
      <div class="stat-lbl">LTV – יחס מימון</div>
    </div>
    <div class="stat-card">
      <div class="stat-num" style="color:${equity>=0?'#16a34a':'#dc2626'};">₪${Math.abs(equity).toLocaleString('he-IL')}</div>
      <div class="stat-lbl">הון עצמי</div>
    </div>`;

  // Alerts
  let alerts = '';
  if (ltvRaw > 70) {
    alerts += `
      <div class="alert alert-red">
        <span class="alert-icon">🚨</span>
        <div>
          <strong>נדרשת שמאות מוקדמת – אחוז מימון גבוה (LTV = ${ltv}%)</strong><br/>
          יחס מימון מעל 70% מחייב שמאות לפני חתימת חוזה. הבנק עשוי לסרב לאשר משכנתא.
        </div>
      </div>`;
  } else if (ltvRaw > 50) {
    alerts += `
      <div class="alert alert-yellow">
        <span class="alert-icon">⚠️</span>
        <div>LTV = ${ltv}% — בטווח סביר. מומלץ לוודא אישור עקרוני מהבנק טרם חתימה.</div>
      </div>`;
  }
  if (sellM > 0) {
    alerts += `
      <div class="alert alert-yellow">
        <span class="alert-icon">📋</span>
        <div>
          <strong>יש להזמין מכתב כוונות ולנתב כספים לסילוק משכנתא מוכר</strong><br/>
          סכום לסילוק: ₪${sellM.toLocaleString('he-IL')} — הכספים יינותבו ישירות לבנק המלווה, לא למוכר.
        </div>
      </div>`;
  }
  if (!alerts) {
    alerts = `<div class="alert alert-green"><span class="alert-icon">✅</span>כל פרמטרי המימון תקינים — LTV ${ltv}%</div>`;
  }
  document.getElementById('finance-alerts').innerHTML = alerts;

  // Upgrader timer
  const upgraderSection = document.getElementById('upgrader-section');
  if (upgraderSection) {
    upgraderSection.style.display = state.upgrader ? '' : 'none';
    if (state.upgrader) renderTimer();
  }
}

function renderTimer() {
  const start = state.openedAt;
  const end = new Date(start);
  end.setMonth(end.getMonth() + 18);
  const now = new Date();
  const totalMs = end - start;
  const remainMs = Math.max(0, end - now);
  const days = Math.floor(remainMs / 86400000);
  const months = Math.floor(days / 30);
  const remDays = days % 30;
  const pct = Math.max(0, Math.min(100, ((totalMs - remainMs) / totalMs) * 100));

  document.getElementById('timer-start-date').textContent = start.toLocaleDateString('he-IL');
  document.getElementById('timer-end-date').textContent = end.toLocaleDateString('he-IL');
  document.getElementById('timer-digits').innerHTML = `
    <div class="digit-box">
      <div class="digit-num">${months}</div>
      <div class="digit-lbl">חודשים</div>
    </div>
    <div class="digit-box">
      <div class="digit-num">${remDays}</div>
      <div class="digit-lbl">ימים</div>
    </div>
    <div class="digit-box">
      <div class="digit-num">${days}</div>
      <div class="digit-lbl">סה״כ ימים</div>
    </div>`;
  document.getElementById('timer-progress').style.width = pct + '%';
}


// ============================================================
// TAX TAB — Dynamic Engine
// ============================================================

// Purchase tax brackets Israel 2024
const TAX_BRACKETS_SINGLE = [
  { ceiling: 1978745,  rate: 0.000 },
  { ceiling: 2347226,  rate: 0.035 },
  { ceiling: 6055070,  rate: 0.050 },
  { ceiling: 20276842, rate: 0.080 },
  { ceiling: Infinity, rate: 0.100 },
];
const TAX_BRACKETS_INVEST = [
  { ceiling: 6055070,  rate: 0.080 },
  { ceiling: Infinity, rate: 0.100 },
];

function calculatePurchaseTax(price, isSingleApt) {
  const brackets = isSingleApt ? TAX_BRACKETS_SINGLE : TAX_BRACKETS_INVEST;
  let tax = 0, floor = 0;
  for (const b of brackets) {
    if (price <= floor) break;
    const slice = Math.min(price, b.ceiling === Infinity ? price : b.ceiling) - floor;
    tax += slice * b.rate;
    if (b.ceiling !== Infinity) floor = b.ceiling;
  }
  return Math.round(tax);
}

// Persistent UI state (survives re-renders)
window._taxBuyerType  = window._taxBuyerType  || 'single';
window._shabachState  = window._shabachState  || { onlyApt: false, held18: false, inherited: false };

function renderTax() {
  renderGate('gate-tax');
  const root  = document.getElementById('tax-engine-root');
  if (!root) return;
  const role    = state.role;
  const isBuyer = role === 'buyer_2nd' || role === 'buyer_contractor';
  const isSeller= role === 'seller';

  if (!role) {
    root.innerHTML = `
      <div class="alert alert-blue">
        <span class="alert-icon">ℹ️</span>
        <div>יש לבחור <strong>תפקיד בעסקה</strong> בלשונית "פתיחת תיק" כדי להפעיל את מחשבון המיסוי.</div>
      </div>`;
    return;
  }
  if (isBuyer)  { _taxRenderBuyer(root);  return; }
  if (isSeller) { _taxRenderSeller(root); return; }
}

// ── A. Buyer — Purchase Tax ───────────────────────────────────
function _taxRenderBuyer(root) {
  const price    = state.price;
  const propType = state.propertyType || '';
  const isNonRes = ['land','commercial','building'].includes(propType);
  const IL       = n => '₪' + Math.round(n).toLocaleString('he-IL');
  const fmtP     = price ? IL(price) : '---';

  // ── Non-residential: flat 6% ─────────────────────────────
  if (isNonRes) {
    const propLabels = { land:'מגרש', commercial:'נכס מסחרי', building:'בניין' };
    const tax6 = price ? Math.round(price * 0.06) : null;
    root.innerHTML = `
      <div class="alert alert-blue" style="margin-bottom:14px;">
        <span class="alert-icon">🏗️</span>
        <div>מחשבון <strong>מס רכישה</strong> — סוג נכס: <strong>${propLabels[propType]||propType}</strong> | מחיר: <strong>${fmtP}</strong></div>
      </div>

      <div class="tax-6pct-banner">
        <div class="tax-6pct-rate">6%</div>
        <div>
          <div style="font-size:.78rem;font-weight:800;color:#92400e;text-transform:uppercase;letter-spacing:.04em;margin-bottom:6px;">
            נכס שאינו דירת מגורים — שיעור אחיד
          </div>
          <div style="font-size:.95rem;font-weight:700;color:#78350f;margin-bottom:4px;">
            החישוב בוצע לפי 6% מס רכישה (נכס שאינו דירת מגורים)
          </div>
          <div style="font-size:.78rem;color:#92400e;">
            על-פי תקנות מיסוי מקרקעין — מגרש, נכס מסחרי ובניין חייבים ב-6% מס רכישה ללא מדרגות.
          </div>
        </div>
      </div>

      <div class="card" style="border-radius:16px 16px 0 0;border-bottom:none;margin-bottom:0;
        background:${tax6 ? '#f0fdf4' : '#f8fafc'};border-color:${tax6 ? '#86efac' : 'var(--border)'};">
        <div style="display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:16px;">
          <div>
            <div style="font-size:.73rem;font-weight:700;color:var(--muted);text-transform:uppercase;letter-spacing:.05em;margin-bottom:6px;">מס רכישה לתשלום</div>
            <div style="font-size:2.8rem;font-weight:800;line-height:1;color:${tax6 ? '#15803d' : 'var(--muted)'};">${tax6 ? IL(tax6) : '---'}</div>
            ${tax6 ? `<div style="font-size:.75rem;color:var(--muted);margin-top:5px;">6% × ${fmtP} | שיעור אחיד ללא מדרגות</div>` : ''}
          </div>
          <div style="text-align:center;padding:14px 20px;background:${tax6 ? '#dcfce7' : '#e2e8f0'};border-radius:14px;">
            <div style="font-size:.68rem;color:var(--muted);margin-bottom:3px;">מועד תשלום</div>
            <div style="font-size:1rem;font-weight:800;color:var(--text);">60 יום</div>
            <div style="font-size:.68rem;color:var(--muted);">מחתימת החוזה</div>
          </div>
        </div>
      </div>
      <div class="card" style="border-radius:0 0 16px 16px;border-top:none;padding:14px 20px;">
        <div style="font-size:.8rem;color:#92400e;display:flex;align-items:flex-start;gap:8px;">
          <span style="font-size:1rem;flex-shrink:0;">📌</span>
          <div>
            <strong>שינוי סוג הנכס</strong> — אם הנכס הוא דירת מגורים, עדכן את <em>סוג הנכס</em> בלשונית "פתיחת תיק" לדירה או בית פרטי לקבלת חישוב מדרגות.
          </div>
        </div>
      </div>`;
    return;
  }

  // ── Residential: standard brackets ──────────────────────
  const isSingle = window._taxBuyerType === 'single';
  const tax      = price ? calculatePurchaseTax(price, isSingle) : null;
  const eff      = (tax && price) ? ((tax / price) * 100).toFixed(2) : null;
  const fmtTax   = tax ? IL(tax) : '---';

  let floor2 = 0;
  const rows = (isSingle ? TAX_BRACKETS_SINGLE : TAX_BRACKETS_INVEST).map((b, i) => {
    const from     = floor2.toLocaleString('he-IL');
    const to       = b.ceiling === Infinity ? 'ומעלה' : IL(b.ceiling);
    const pct      = (b.rate * 100).toFixed(1) + '%';
    const inRange  = price > floor2;
    const sliceEnd = b.ceiling === Infinity ? (price || floor2) : b.ceiling;
    const slice    = inRange ? Math.min(price, sliceEnd) - floor2 : 0;
    const sliceTax = Math.round(slice * b.rate);
    if (b.ceiling !== Infinity) floor2 = b.ceiling;
    return `<tr style="background:${inRange ? '#eff6ff' : (i%2 ? '#f8fafc' : '#fff')}">
      <td style="padding:8px 12px;font-size:.8rem;color:var(--muted);">₪${from} – ${to}</td>
      <td style="padding:8px 12px;font-size:.8rem;font-weight:700;color:#1e40af;">${pct}</td>
      <td style="padding:8px 12px;font-size:.8rem;color:${inRange && sliceTax ? '#16a34a' : '#94a3b8'};">${inRange && sliceTax ? IL(sliceTax) : '—'}</td>
    </tr>`;
  }).join('');

  root.innerHTML = `
    <div class="alert alert-blue" style="margin-bottom:14px;">
      <span class="alert-icon">🛒</span>
      <div>מחשבון <strong>מס רכישה</strong> — מחיר עסקה: <strong>${fmtP}</strong></div>
    </div>

    <div class="card">
      <div class="card-title">🔘 סוג רוכש</div>
      <div style="display:flex;gap:10px;flex-wrap:wrap;">
        <label style="flex:1;min-width:180px;display:flex;align-items:center;gap:10px;cursor:pointer;
          padding:13px 16px;border-radius:12px;
          border:2px solid ${isSingle ? '#2563eb' : 'var(--border)'};
          background:${isSingle ? '#eff6ff' : '#f8fafc'};transition:all .15s;">
          <input type="radio" name="taxBuyerType" value="single" ${isSingle ? 'checked' : ''}
            onchange="window._taxBuyerType='single'; renderTax();"
            style="width:16px;height:16px;accent-color:#2563eb;flex-shrink:0;"/>
          <div>
            <div style="font-weight:700;font-size:.875rem;color:${isSingle ? '#1e40af' : 'var(--text)'};">דירה יחידה / משפר דיור</div>
            <div style="font-size:.7rem;color:var(--muted);margin-top:2px;">פטור עד ₪1,978,745 — מדרגות מופחתות</div>
          </div>
        </label>
        <label style="flex:1;min-width:180px;display:flex;align-items:center;gap:10px;cursor:pointer;
          padding:13px 16px;border-radius:12px;
          border:2px solid ${!isSingle ? '#2563eb' : 'var(--border)'};
          background:${!isSingle ? '#eff6ff' : '#f8fafc'};transition:all .15s;">
          <input type="radio" name="taxBuyerType" value="invest" ${!isSingle ? 'checked' : ''}
            onchange="window._taxBuyerType='invest'; renderTax();"
            style="width:16px;height:16px;accent-color:#2563eb;flex-shrink:0;"/>
          <div>
            <div style="font-weight:700;font-size:.875rem;color:${!isSingle ? '#1e40af' : 'var(--text)'};">דירה נוספת / השקעה / תושב חוץ</div>
            <div style="font-size:.7rem;color:var(--muted);margin-top:2px;">8% על כל הסכום עד ₪6M, 10% מעל</div>
          </div>
        </label>
      </div>
      ${state.upgrader ? `<div class="alert alert-yellow" style="margin-top:12px;margin-bottom:0;">
        <span class="alert-icon">🏡</span>
        <div><strong>משפר דיור מסומן</strong> — בחר "דירה יחידה / משפר דיור" לקבלת מדרגות מופחתות.</div>
      </div>` : ''}
    </div>

    <div class="card" style="margin-bottom:0;border-radius:16px 16px 0 0;border-bottom:none;
      background:${tax ? '#f0fdf4' : '#f8fafc'};border-color:${tax ? '#86efac' : 'var(--border)'};">
      <div style="display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:16px;">
        <div>
          <div style="font-size:.75rem;font-weight:700;color:var(--muted);margin-bottom:6px;text-transform:uppercase;letter-spacing:.05em;">מס רכישה לתשלום</div>
          <div style="font-size:2.8rem;font-weight:800;line-height:1;color:${tax ? '#15803d' : 'var(--muted)'};">${fmtTax}</div>
          ${eff ? `<div style="font-size:.78rem;color:var(--muted);margin-top:5px;">שיעור אפקטיבי <strong>${eff}%</strong></div>` : ''}
        </div>
        <div style="text-align:center;padding:14px 22px;background:${tax ? '#dcfce7' : '#e2e8f0'};border-radius:14px;">
          <div style="font-size:.68rem;color:var(--muted);margin-bottom:3px;">מועד תשלום</div>
          <div style="font-size:1rem;font-weight:800;color:var(--text);">60 יום</div>
          <div style="font-size:.68rem;color:var(--muted);">מחתימת החוזה</div>
        </div>
      </div>
    </div>

    <div class="card" style="border-radius:0 0 16px 16px;border-top:none;padding:0;">
      <div style="padding:14px 20px 10px;font-size:.875rem;font-weight:700;color:var(--brand);">📊 פירוט מדרגות מס</div>
      <div style="overflow-x:auto;">
        <table style="width:100%;border-collapse:collapse;">
          <thead>
            <tr style="background:#f1f5f9;">
              <th style="padding:8px 12px;text-align:right;font-size:.72rem;color:var(--muted);font-weight:600;border-bottom:2px solid var(--border);">טווח שווי</th>
              <th style="padding:8px 12px;text-align:right;font-size:.72rem;color:var(--muted);font-weight:600;border-bottom:2px solid var(--border);">שיעור</th>
              <th style="padding:8px 12px;text-align:right;font-size:.72rem;color:var(--muted);font-weight:600;border-bottom:2px solid var(--border);">מס בגין שלב</th>
            </tr>
          </thead>
          <tbody>${rows}</tbody>
        </table>
      </div>
    </div>`;
}

// ── B. Seller — Betterment Tax ────────────────────────────────
function _shabachToggle(key) {
  window._shabachState[key] = !window._shabachState[key];
  renderTax();
}

// ── Advance-payment rate logic ────────────────────────────────
// Cutoff: 07/11/2001  →  before = 15%, on/after = 7.5%
const _SHABACH_CUTOFF = new Date('2001-11-07');

function _shabachAdvanceRate(purchaseDateStr) {
  if (!purchaseDateStr) return null;           // unknown → don't decide
  const d = new Date(purchaseDateStr);
  if (isNaN(d)) return null;
  return d < _SHABACH_CUTOFF ? 0.15 : 0.075;
}

// Called from oninput of the purchase-date / purchase-price inputs
function _shabachInputChange() {
  const dateEl  = document.getElementById('shabach-purchase-date');
  const priceEl = document.getElementById('shabach-purchase-price');
  if (dateEl)  window._shabachState._purchaseDate  = dateEl.value;
  if (priceEl) window._shabachState._purchasePrice = priceEl.value;
  renderTax();
}

function _taxRenderSeller(root) {
  const s     = window._shabachState;
  const price = state.price;
  const exempt = (s.onlyApt && s.held18) || s.inherited;
  const IL    = n => '₪' + Math.round(n).toLocaleString('he-IL');
  const fmtP  = price ? IL(price) : '---';

  // ── Advance payment calculation ──────────────────────────
  const purchDateStr  = s._purchaseDate  || '';
  const purchPriceVal = parseFloat(s._purchasePrice) || 0;
  const rate          = _shabachAdvanceRate(purchDateStr);  // 0.075, 0.15, or null
  const advAmount     = (price && rate !== null) ? Math.round(price * rate) : null;
  const rateLabel     = rate === 0.075 ? '7.5%' : rate === 0.15 ? '15%' : null;
  const rateBasis     = rate === 0.075
    ? 'רכישה לאחר 07.11.2001'
    : rate === 0.15
    ? 'רכישה לפני 07.11.2001'
    : 'הזן תאריך רכישה לחישוב';

  // Linear appreciation hint (sale price − purchase price)
  const appreciationHint = (price && purchPriceVal && purchPriceVal < price)
    ? 'שבח משוער: ' + IL(price - purchPriceVal) + ' (הפרש מחירים — לפני אינדקס)'
    : '';

  const exemptReason = s.inherited
    ? 'פטור ירושה — סעיף 49ב(5) לחוק מיסוי מקרקעין'
    : 'פטור דירה יחידה — סעיף 49ב(1) לחוק מיסוי מקרקעין';

  // ── Toggle row builder ───────────────────────────────────
  function togRow(key, emoji, label, hint) {
    const on = s[key];
    return `
      <div onclick="_shabachToggle('${key}')" style="display:flex;align-items:center;gap:14px;
        padding:14px 16px;border-radius:12px;cursor:pointer;user-select:none;
        background:${on ? '#f0fdf4' : '#f8fafc'};
        border:1.5px solid ${on ? '#86efac' : 'var(--border)'};
        transition:all .15s;margin-bottom:8px;">
        <div style="font-size:1.5rem;line-height:1;">${emoji}</div>
        <div style="flex:1;">
          <div style="font-size:.875rem;font-weight:600;color:${on ? '#15803d' : 'var(--text)'};">${label}</div>
          ${hint ? `<div style="font-size:.7rem;color:var(--muted);margin-top:2px;">${hint}</div>` : ''}
        </div>
        <div style="width:44px;height:26px;border-radius:13px;flex-shrink:0;
          background:${on ? '#22c55e' : '#cbd5e1'};position:relative;transition:background .2s;">
          <div style="position:absolute;top:4px;${on ? 'right' : 'left'}:4px;
            width:18px;height:18px;border-radius:50%;background:#fff;
            box-shadow:0 1px 3px rgba(0,0,0,.2);transition:all .2s;"></div>
        </div>
      </div>`;
  }

  root.innerHTML = `

    <!-- ① Purchase details inputs -->
    <div class="card">
      <div class="card-title">🗓️ פרטי רכישת הנכס על ידי המוכר</div>
      <div class="form-grid">

        <div class="form-group">
          <label style="font-size:.8rem;font-weight:700;color:var(--muted);text-transform:uppercase;letter-spacing:.04em;display:block;margin-bottom:6px;">
            מועד רכישת הנכס
          </label>
          <input type="date"
            id="shabach-purchase-date"
            value="${s._purchaseDate || ''}"
            oninput="_shabachInputChange()"
            style="width:100%;padding:10px 14px;border:1.5px solid var(--border);
              border-radius:10px;font-family:'Heebo',sans-serif;font-size:.9rem;
              color:var(--text);background:#fff;direction:ltr;text-align:right;
              transition:border-color .15s;box-sizing:border-box;"
            onfocus="this.style.borderColor='var(--brand-light)';this.style.boxShadow='0 0 0 3px rgba(37,99,235,.1)'"
            onblur="this.style.borderColor='var(--border)';this.style.boxShadow='none'"/>
          ${purchDateStr ? `
            <div style="margin-top:6px;font-size:.72rem;font-weight:700;
              padding:3px 10px;border-radius:99px;display:inline-block;
              background:${rate === 0.075 ? '#eff6ff' : rate === 0.15 ? '#fef2f2' : '#f8fafc'};
              color:${rate === 0.075 ? '#1e40af' : rate === 0.15 ? '#991b1b' : 'var(--muted)'};">
              ${rateBasis} → שיעור מקדמה: <strong>${rateLabel || '---'}</strong>
            </div>` : ''}
        </div>

        <div class="form-group">
          <label style="font-size:.8rem;font-weight:700;color:var(--muted);text-transform:uppercase;letter-spacing:.04em;display:block;margin-bottom:6px;">
            שווי רכישה מקורי (₪)
          </label>
          <div style="position:relative;">
            <span style="position:absolute;right:12px;top:50%;transform:translateY(-50%);color:var(--muted);font-size:.82rem;pointer-events:none;font-weight:600;">₪</span>
            <input type="number" min="0" step="10000"
              id="shabach-purchase-price"
              value="${s._purchasePrice || ''}"
              placeholder="0"
              oninput="_shabachInputChange()"
              style="width:100%;padding:10px 28px 10px 12px;border:1.5px solid var(--border);
                border-radius:10px;font-family:'Heebo',sans-serif;font-size:.9rem;
                color:var(--brand);font-weight:700;background:#fff;
                direction:ltr;text-align:right;box-sizing:border-box;
                transition:border-color .15s;"
              onfocus="this.style.borderColor='var(--brand-light)';this.style.boxShadow='0 0 0 3px rgba(37,99,235,.1)'"
              onblur="this.style.borderColor='var(--border)';this.style.boxShadow='none'"/>
          </div>
          ${appreciationHint ? `<div style="margin-top:6px;font-size:.72rem;color:#92400e;background:#fffbeb;border-radius:6px;padding:3px 10px;display:inline-block;">${appreciationHint}</div>` : ''}
        </div>

      </div>
    </div>

    <!-- ② Questionnaire -->
    <div class="card">
      <div class="card-title">❓ שאלון זכאות לפטור ממס שבח</div>
      ${togRow('onlyApt',   '🏠', 'זוהי דירתו היחידה של המוכר?',        'כולל דירה שהתקבלה בירושה ומוחזקת כיחידה')}
      ${togRow('held18',    '📅', 'החזיק בדירה לפחות 18 חודשים?',       'ממועד הרכישה עד מועד המכירה')}
      ${togRow('inherited', '🕊️', 'הדירה התקבלה בירושה — פטור מיוחד?', 'סעיף 49ב(5): ירושה — פטור בתנאים מסוימים')}
    </div>


    <!-- ③‑A Section 49Z — בית פרטי only -->
    ${state.propertyType === 'house' ? `
    <div class="s49z-card ${window._s49zOn ? 'on' : ''}" id="s49z-card" onclick="s49zToggle(event)">
      <div class="s49z-head">
        <span style="font-size:1.3rem;">🏡</span>
        <div style="flex:1;">
          <div style="font-size:.875rem;font-weight:700;color:${window._s49zOn ? '#15803d' : 'var(--text)'};">
            החל סעיף 49ז׳
            <span class="tt-ico" data-tip="סעיף 49ז׳ לחוק מיסוי מקרקעין:&#10;בית פרטי שיש בו זכויות בנייה שלא מומשו&#10;עשוי להיות זכאי לפטור כפול — פטור על&#10;הדירה הקיימת ופטור נוסף על שווי&#10;זכויות הבנייה, עד לתקרה שנקבעה בחוק.&#10;יש להתייעץ עם שמאי מקרקעין לקביעת&#10;שווי הזכויות הפטורות.">?</span>
          </div>
          <div style="font-size:.72rem;color:var(--muted);margin-top:2px;">פטור כפול בגין זכויות בנייה לא ממומשות</div>
        </div>
        <div class="s49z-track"><div class="s49z-knob"></div></div>
      </div>
      ${window._s49zOn ? `
      <div class="s49z-body">
        <label style="font-size:.78rem;font-weight:700;color:var(--muted);text-transform:uppercase;letter-spacing:.04em;display:block;margin-bottom:8px;">
          שווי זכויות הבנייה הפטורות (עד התקרה) — ₪
        </label>
        <div style="position:relative;max-width:340px;">
          <span style="position:absolute;right:12px;top:50%;transform:translateY(-50%);color:var(--muted);font-size:.82rem;pointer-events:none;font-weight:600;">₪</span>
          <input type="number" min="0" step="10000"
            id="s49z-amount"
            value="${window._s49zAmount || ''}"
            placeholder="0"
            onclick="event.stopPropagation()"
            oninput="event.stopPropagation(); window._s49zAmount=parseFloat(this.value)||0; renderTax();"
            style="width:100%;padding:10px 28px 10px 12px;border:1.5px solid var(--border);
              border-radius:10px;font-family:'Heebo',sans-serif;font-size:.95rem;
              color:var(--brand);font-weight:700;background:#fff;
              direction:ltr;text-align:right;box-sizing:border-box;transition:border-color .15s;"
            onfocus="event.stopPropagation();this.style.borderColor='var(--brand-light)';this.style.boxShadow='0 0 0 3px rgba(37,99,235,.1)'"
            onblur="this.style.borderColor='var(--border)';this.style.boxShadow='none'"/>
        </div>
        ${(window._s49zAmount > 0) ? `
        <div style="margin-top:12px;padding:12px 16px;background:#f0fdf4;border-radius:10px;border:1px solid #86efac;">
          <div style="font-size:.72rem;font-weight:700;color:#15803d;text-transform:uppercase;letter-spacing:.04em;margin-bottom:4px;">ניכוי פטור 49ז׳</div>
          <div style="font-size:1.1rem;font-weight:800;color:#15803d;">−${IL(window._s49zAmount)}</div>
          <div style="font-size:.72rem;color:#166534;margin-top:2px;">סכום זה יקוזז מבסיס החישוב הלינארי</div>
        </div>` : ''}
        <div style="margin-top:10px;font-size:.72rem;color:#92400e;background:#fffbeb;border-radius:8px;padding:8px 12px;border:1px solid #fcd34d;">
          ⚠️ יש לוודא את שווי הזכויות עם שמאי מקרקעין מוסמך ולבחון עמידה בתנאי הסעיף מול רשות המיסים.
        </div>
      </div>` : ''}
    </div>` : ''}

    <!-- ③ Verdict banner -->
    <div class="card" style="margin-bottom:0;border-radius:16px 16px 0 0;border-bottom:none;
      background:${exempt ? '#f0fdf4' : '#fef2f2'};
      border-color:${exempt ? '#86efac' : '#fca5a5'};">
      <div style="display:flex;align-items:center;gap:16px;flex-wrap:wrap;">
        <div style="font-size:3rem;line-height:1;">${exempt ? '✅' : '❌'}</div>
        <div style="flex:1;min-width:200px;">
          <div style="font-size:1.05rem;font-weight:800;color:${exempt ? '#15803d' : '#991b1b'};">
            ${exempt ? 'זכאי לפטור ממס שבח' : 'חייב במס שבח – חישוב לינארי יחסי'}
          </div>
          <div style="font-size:.82rem;color:${exempt ? '#166534' : '#b91c1c'};margin-top:4px;">
            ${exempt
              ? exemptReason + ' — יש להגיש בקשת פטור טופס 7000 לרשות המיסים.'
              : 'לא עמד בתנאי הפטור. המס יחושב לפי שיטת החישוב הלינארי על השבח הריאלי.'}
          </div>
        </div>
      </div>
    </div>

    <!-- ④ Advance payment — shown only when NOT exempt -->
    ${!exempt ? `
    <div class="card" style="border-radius:0;border-top:none;border-bottom:none;margin-bottom:0;">

      <!-- Section label -->
      <div style="display:flex;align-items:center;gap:8px;margin-bottom:18px;">
        <span style="font-size:1.1rem;">💳</span>
        <span style="font-size:.95rem;font-weight:800;color:var(--brand);">גובה מקדמת מס שבח לתשלום</span>
      </div>

      <!-- Rate selector display -->
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:18px;">

        <!-- Card: before cutoff -->
        <div style="padding:14px 16px;border-radius:12px;
          border:2px solid ${rate === 0.15 ? '#fca5a5' : 'var(--border)'};
          background:${rate === 0.15 ? '#fef2f2' : '#f8fafc'};
          transition:all .15s;">
          <div style="font-size:.7rem;font-weight:700;color:${rate === 0.15 ? '#991b1b' : 'var(--muted)'};margin-bottom:4px;text-transform:uppercase;letter-spacing:.05em;">
            לפני 07.11.2001
          </div>
          <div style="font-size:1.6rem;font-weight:800;color:${rate === 0.15 ? '#dc2626' : '#94a3b8'};">15%</div>
          <div style="font-size:.7rem;color:${rate === 0.15 ? '#b91c1c' : 'var(--muted)'};margin-top:2px;">מסך התמורה</div>
          ${rate === 0.15 ? '<div style="margin-top:6px;font-size:.68rem;font-weight:800;background:#dc2626;color:#fff;border-radius:99px;padding:2px 8px;display:inline-block;">חל על עסקה זו ✓</div>' : ''}
        </div>

        <!-- Card: on/after cutoff -->
        <div style="padding:14px 16px;border-radius:12px;
          border:2px solid ${rate === 0.075 ? '#bfdbfe' : 'var(--border)'};
          background:${rate === 0.075 ? '#eff6ff' : '#f8fafc'};
          transition:all .15s;">
          <div style="font-size:.7rem;font-weight:700;color:${rate === 0.075 ? '#1e40af' : 'var(--muted)'};margin-bottom:4px;text-transform:uppercase;letter-spacing:.05em;">
            07.11.2001 ואילך
          </div>
          <div style="font-size:1.6rem;font-weight:800;color:${rate === 0.075 ? '#2563eb' : '#94a3b8'};">7.5%</div>
          <div style="font-size:.7rem;color:${rate === 0.075 ? '#1d4ed8' : 'var(--muted)'};margin-top:2px;">מסך התמורה</div>
          ${rate === 0.075 ? '<div style="margin-top:6px;font-size:.68rem;font-weight:800;background:#2563eb;color:#fff;border-radius:99px;padding:2px 8px;display:inline-block;">חל על עסקה זו ✓</div>' : ''}
        </div>
      </div>

      <!-- Hero result -->
      ${advAmount !== null ? `
      <div style="display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:16px;
        padding:20px;background:${rate === 0.15 ? '#fef2f2' : '#eff6ff'};border-radius:14px;
        border:2px solid ${rate === 0.15 ? '#fca5a5' : '#bfdbfe'};">
        <div>
          <div style="font-size:.72rem;font-weight:700;color:var(--muted);text-transform:uppercase;letter-spacing:.05em;margin-bottom:6px;">
            גובה מקדמת מס שבח לתשלום
          </div>
          <div style="font-size:2.8rem;font-weight:800;line-height:1;
            color:${rate === 0.15 ? '#dc2626' : '#2563eb'};">
            ${IL(advAmount)}
          </div>
          <div style="font-size:.73rem;color:var(--muted);margin-top:5px;">
            ${rateLabel} × ${fmtP} | מועד: עם קבלת 40% מהתמורה (טופס 15ב)
          </div>
        </div>
        <div style="text-align:center;padding:14px 18px;border-radius:12px;
          background:${rate === 0.15 ? '#fee2e2' : '#dbeafe'};">
          <div style="font-size:.68rem;color:var(--muted);margin-bottom:3px;">שיעור חל</div>
          <div style="font-size:1.4rem;font-weight:800;
            color:${rate === 0.15 ? '#dc2626' : '#2563eb'};">${rateLabel}</div>
          <div style="font-size:.68rem;color:var(--muted);margin-top:1px;">${rateBasis}</div>
        </div>
      </div>` : `
      <div class="alert alert-yellow" style="margin-bottom:0;">
        <span class="alert-icon">📅</span>
        <div>הזן <strong>מועד רכישת הנכס</strong> לעיל כדי לחשב את שיעור המקדמה (7.5% או 15%)</div>
      </div>`}

      <div class="alert alert-yellow" style="margin-top:12px;margin-bottom:0;">
        <span class="alert-icon">⚠️</span>
        <div>אי-תשלום המקדמה בזמן עלול לגרום לקנסות וריבית. חישוב המס הסופי ייקבע בשומה מרשות המיסים.</div>
      </div>
    </div>` : `
    <div class="card" style="border-radius:0;border-top:none;border-bottom:none;margin-bottom:0;background:#f0fdf4;">
      <div style="display:flex;align-items:center;gap:12px;color:#15803d;">
        <span style="font-size:1.5rem;">💡</span>
        <div style="font-size:.875rem;font-weight:600;">
          פטור ממס שבח — אין חובת תשלום מקדמה.<br/>
          <span style="font-weight:400;color:#166534;">יש להגיש בקשת פטור (טופס 7000) לרשות המיסים בתוך 30 יום מהעסקה.</span>
        </div>
      </div>
    </div>`}

    <!-- ⑤ Action buttons -->
    <div class="card" style="border-radius:0 0 16px 16px;border-top:none;">
      <div class="card-title">🔗 כלים רשמיים</div>
      <div class="btn-group" style="margin-top:0;">
        <a href="https://www.misim.gov.il/svtsvazmitnew/FrmHadrachaRashit.aspx" target="_blank" rel="noopener"
          class="btn btn-primary" style="text-decoration:none;justify-content:center;">
          🖥️ פתח סימולטור מס שבח רשמי
        </a>
        <a href="https://www.gov.il/he/departments/dynamiccollectors/form-7000" target="_blank" rel="noopener"
          class="btn btn-secondary" style="text-decoration:none;justify-content:center;">
          📄 טופס 7000 – בקשת פטור
        </a>
      </div>
    </div>`;
}

// ============================================================
// LEGAL TAB
// ============================================================
function renderLegal() {
  renderGate('gate-legal');

  const tasks = [];
  if (state.foreignResident) {
    tasks.push({
      tag: 'tag-red', tagLabel: 'תושב חוץ',
      text: 'אימות דרכון מול טאבו – קבלת ייפוי כוח נוטריוני/קונסולרי + אפוסטיל. בדיקה: האם נדרש אישור בנק ישראל לרכישה?'
    });
  }
  if (state.rented) {
    tasks.push({
      tag: 'tag-yellow', tagLabel: 'שוכר',
      text: 'קבלת מכתב פינוי חתום מהשוכר / בחינת המחאת זכויות שכירות לקונה. בדיקת תנאי חוזה שכירות קיים – האם קיימת זכות סירוב?'
    });
  }
  if (state.urbanRenewal) {
    tasks.push({
      tag: 'tag-purple', tagLabel: 'פינוי-בינוי',
      text: 'בדיקת התניה להסכם יזם פינוי-בינוי. האם חלות חובות להוועדה המקומית? האם יש החלטת מוסד תכנון? בדיקת מפרט טכני ותנאי הצמדות.'
    });
  }
  if (state.role === 'buyer_contractor') {
    tasks.push({
      tag: 'tag-blue', tagLabel: 'קבלן',
      text: 'וידוא פנקס שוברים ותשלומים. בדיקת החרגת משכנתא יזמית מהנכס הנרכש. בדיקת מדד תשומות הבנייה – מוגבל ל-40% מהתמורה בלבד.'
    }, {
      tag: 'tag-blue', tagLabel: 'קבלן',
      text: 'בדיקת ערבות חוק מכר (חוק 5734) – אחריות לקיום ערבות בנקאית או פוליסת ביטוח לכספי הרוכש.'
    });
  }

  const container = document.getElementById('dynamic-tasks');
  if (tasks.length === 0) {
    container.innerHTML = `<div class="alert alert-green"><span class="alert-icon">✅</span>אין משימות מיוחדות על בסיס הפרמטרים הנוכחיים. בדוק את "פתיחת תיק" אם ציפית לראות משימות.</div>`;
    return;
  }
  container.innerHTML = tasks.map((t, i) => `
    <div class="checklist-item">
      <input type="checkbox" id="dyn-task-${i}"/>
      <label for="dyn-task-${i}">
        <span class="task-tag ${t.tag}">${t.tagLabel}</span>
        ${t.text}
      </label>
    </div>`).join('');
}

// ============================================================
// גוש / חלקה — data.gov.il (מינהל מקרקעי ישראל)
// ============================================================
// Dataset: כתובות + גוש/חלקה — resource_id: be5b7935-3922-45d4-9638-08871b17ec95
// Fields: STREET_NAME, HOUSE_NUM, CITY_NAME, GUSH, HELKA
// API: CKAN datastore_search_sql (פתוח, ללא Token)
// ============================================================

const RES_GUSH_CHELKA = 'be5b7935-3922-45d4-9638-08871b17ec95';

async function fetchGushChelka() {
  const city   = document.getElementById('propCity').value.trim();
  const street = document.getElementById('propStreet').value.trim();
  const num    = document.getElementById('propNumber').value.trim();

  const statusEl = document.getElementById('gis-status');

  if (!city || !street || !num) {
    statusEl.innerHTML = `<span style="color:#d97706;">⚠️ יש למלא עיר, רחוב ומספר בית לפני החיפוש.</span>`;
    return;
  }

  statusEl.innerHTML = `<span class="spinner"></span> <span>מחפש גוש/חלקה עבור ${street} ${num}, ${city}…</span>`;

  // ── שלב 1: SQL מדויק — שם רחוב + מספר בית + עיר ──────────
  const tryExact = async () => {
    const sql = `SELECT "GUSH","HELKA","STREET_NAME","HOUSE_NUM","CITY_NAME"
      FROM "${RES_GUSH_CHELKA}"
      WHERE "CITY_NAME" LIKE '${sqlEsc(city)}%'
        AND "STREET_NAME" LIKE '${sqlEsc(street)}%'
        AND "HOUSE_NUM"='${sqlEsc(num)}'
      LIMIT 5`;
    const url = `https://data.gov.il/api/3/action/datastore_search_sql?sql=${encodeURIComponent(sql)}`;
    const data = await fetchGovDataRaw(url);
    return data?.result?.records || [];
  };

  // ── שלב 2: fallback — ללא מספר בית ───────────────────────
  const tryStreetOnly = async () => {
    const sql = `SELECT "GUSH","HELKA","STREET_NAME","HOUSE_NUM","CITY_NAME"
      FROM "${RES_GUSH_CHELKA}"
      WHERE "CITY_NAME" LIKE '${sqlEsc(city)}%'
        AND "STREET_NAME" LIKE '${sqlEsc(street)}%'
      ORDER BY "HOUSE_NUM"
      LIMIT 10`;
    const url = `https://data.gov.il/api/3/action/datastore_search_sql?sql=${encodeURIComponent(sql)}`;
    const data = await fetchGovDataRaw(url);
    return data?.result?.records || [];
  };

  // ── שלב 3: fallback — datastore_search רגיל ───────────────
  const tryPlain = async () => {
    const url = `https://data.gov.il/api/3/action/datastore_search`
      + `?resource_id=${RES_GUSH_CHELKA}`
      + `&q=${encodeURIComponent(street + ' ' + num + ' ' + city)}`
      + `&limit=5`;
    const data = await fetchGovDataRaw(url);
    return data?.result?.records || [];
  };

  try {
    let records = [];
    let matchType = 'exact';

    try { records = await tryExact(); } catch(_) {}
    if (!records.length) {
      matchType = 'street';
      try { records = await tryStreetOnly(); } catch(_) {}
    }
    if (!records.length) {
      matchType = 'text';
      try { records = await tryPlain(); } catch(_) {}
    }

    if (!records.length) {
      // ── לא נמצא — הצג קישור ידני לGovmap ──────────────────
      const govmapUrl = `https://www.govmap.gov.il/?q=${encodeURIComponent(street + ' ' + num + ', ' + city)}&zoom=7&app=app04`;
      statusEl.innerHTML = `
        <span style="color:#d97706;font-weight:600;">⚠️ לא נמצאו נתונים אוטומטיים עבור כתובת זו.</span>
        <div style="margin-top:8px;font-size:0.82rem;color:var(--muted);">
          ניתן לאתר גוש/חלקה ידנית ב-
          <a href="${govmapUrl}" target="_blank" style="color:var(--brand-light);text-decoration:underline;">
            GovMap — מחשבון גוש/חלקה 🗺️
          </a>
          ולהזין ידנית בשדות למטה.
        </div>`;
      return;
    }

    // ── בחר רשומה הכי קרובה למספר הבית ─────────────────────
    const best = records.reduce((prev, cur) => {
      const pDiff = Math.abs(Number(prev.HOUSE_NUM) - Number(num));
      const cDiff = Math.abs(Number(cur.HOUSE_NUM) - Number(num));
      return cDiff < pDiff ? cur : prev;
    }, records[0]);

    const gush  = String(best.GUSH  || '').trim();
    const chelka = String(best.HELKA || '').trim();

    if (!gush || !chelka) {
      statusEl.innerHTML = `<span style="color:#d97706;">⚠️ נמצאה כתובת אך שדות גוש/חלקה ריקים במאגר.</span>`;
      return;
    }

    document.getElementById('propGush').value   = gush;
    document.getElementById('propChelka').value  = chelka;
    state.gush   = gush;
    state.chelka = chelka;

    const note = matchType !== 'exact'
      ? ` <span style="color:#d97706;font-size:0.78rem;">(התאמה חלקית — אמת ב-GovMap)</span>`
      : '';

    statusEl.innerHTML = `
      <span style="color:#16a34a;font-weight:600;">✅ נמצא! גוש: ${gush} | חלקה: ${chelka}</span>${note}
      <span style="font-size:0.78rem;color:var(--muted);margin-right:8px;">
        (${best.STREET_NAME} ${best.HOUSE_NUM}, ${best.CITY_NAME})
      </span>`;

  } catch (err) {
    const govmapUrl = `https://www.govmap.gov.il/?q=${encodeURIComponent(street + ' ' + num + ', ' + city)}&zoom=7&app=app04`;
    statusEl.innerHTML = `
      <span style="color:#dc2626;">❌ שגיאת חיבור ל-data.gov.il</span>
      <div style="margin-top:6px;font-size:0.82rem;">
        אתר ידנית ב-<a href="${govmapUrl}" target="_blank" style="color:var(--brand-light);text-decoration:underline;">GovMap 🗺️</a>
      </div>`;
    console.warn('fetchGushChelka error:', err);
  }
}

// ============================================================
// QUICK LINKS
// ============================================================
// ============================================================
// GOVMAP PLAYWRIGHT AGENT — קריאה לשרת Flask
// ============================================================
async function agentFetchGushChelka() {
  const city   = (document.getElementById('propCity')?.value   || '').trim();
  const street = (document.getElementById('propStreet')?.value || '').trim();
  const number = (document.getElementById('propNumber')?.value || '').trim();
  const statusEl = document.getElementById('gis-status');

  if (!city || !street) {
    statusEl.innerHTML = '<span style="color:#d97706;">⚠️ נא למלא עיר ורחוב לפני הפעלת הסוכן</span>';
    return;
  }

  // ── UI: loading state ─────────────────────────────────────
  const btn = document.getElementById('agent-btn');
  const origLabel = btn ? btn.innerHTML : '';
  if (btn) {
    btn.disabled = true;
    btn.innerHTML = '<span style="display:inline-block;animation:spin .7s linear infinite;">⏳</span> הסוכן עובד...';
  }
  statusEl.innerHTML = `
    <span style="color:#2563eb;font-weight:600;">
      🤖 הסוכן פותח דפדפן ומחפש ב-GOVMAP...
    </span>
    <span style="font-size:.78rem;color:var(--muted);margin-right:8px;">
      (${street} ${number}, ${city})
    </span>`;

  try {
    const res = await fetch('/api/govmap', {
      method:  'POST',
      headers: { 'Content-Type': 'application/json' },
      body:    JSON.stringify({ city, street, number }),
    });

    const data = await res.json();

    if (data.gush && data.chelka) {
      // ── הצלחה ────────────────────────────────────────────
      document.getElementById('propGush').value   = data.gush;
      document.getElementById('propChelka').value = data.chelka;
      state.gush   = data.gush;
      state.chelka = data.chelka;

      const srcLabel = { text:'טקסט', url:'URL', json:'JSON', attr:'attr' }[data.source] || data.source;
      statusEl.innerHTML = `
        <span style="color:#16a34a;font-weight:600;">
          ✅ הסוכן מצא! גוש: ${data.gush} | חלקה: ${data.chelka}
        </span>
        <span style="font-size:.75rem;color:var(--muted);margin-right:8px;">
          (מקור: ${srcLabel})
        </span>`;

    } else {
      // ── כישלון ───────────────────────────────────────────
      const govmapUrl = `https://www.govmap.gov.il/?q=${encodeURIComponent(street+' '+number+', '+city)}&zoom=7&app=app04`;
      statusEl.innerHTML = `
        <span style="color:#dc2626;font-weight:600;">
          ❌ ${data.error || 'הסוכן לא הצליח לאחזר נתונים'}
        </span>
        <div style="margin-top:6px;font-size:.8rem;">
          נסה לאתר ידנית ב-
          <a href="${govmapUrl}" target="_blank"
            style="color:var(--brand-light);text-decoration:underline;">GovMap 🗺️</a>
        </div>`;
    }

  } catch (err) {
    statusEl.innerHTML = `
      <span style="color:#dc2626;font-weight:600;">❌ שגיאת חיבור לשרת</span>
      <div style="font-size:.78rem;color:var(--muted);margin-top:4px;">
        ודא ש-app.py פועל על פורט 5000 (python app.py)
      </div>`;
    console.error('agentFetchGushChelka:', err);
  } finally {
    if (btn) { btn.disabled = false; btn.innerHTML = origLabel; }
  }
}

/* CSS spin animation (injected once) */
if (!document.getElementById('agent-spin-style')) {
  const s = document.createElement('style');
  s.id = 'agent-spin-style';
  s.textContent = '@keyframes spin { to { transform: rotate(360deg); } }';
  document.head.appendChild(s);
}

function openGovmap() {
  const gush   = state.gush   || document.getElementById('propGush')?.value  || '';
  const chelka = state.chelka || document.getElementById('propChelka')?.value || '';
  const q = (gush && chelka) ? `${gush}/${chelka}` : '';
  window.open(`https://www.govmap.gov.il/?q=${encodeURIComponent(q)}&zoom=9`, '_blank');
}

function openBuildingFile() {
  const city = state.city || document.getElementById('propCity')?.value || '';
  const query = `תיק בניין הוועדה המקומית ${city}`;
  window.open(`https://www.google.com/search?q=${encodeURIComponent(query)}`, '_blank');
}

// ============================================================
// GOOGLE STREET VIEW
// ============================================================
let svPanorama = null;

function openStreetView() {
  const city   = document.getElementById('propCity').value.trim();
  const street = document.getElementById('propStreet').value.trim();
  const num    = document.getElementById('propNumber').value.trim();

  if (!city && !street) {
    svSetStatus('<div style="font-size:2.5rem">⚠️</div><div>יש למלא עיר ורחוב תחילה</div>');
    svShowModal();
    return;
  }

  const addr = [street, num, city].filter(Boolean).join(', ');
  document.getElementById('sv-address-label').textContent = addr;
  svSetStatus('<div class="sv-spinner"></div><div>טוען תצוגת רחוב…</div>');
  svShowModal();

  // Init panorama once
  if (!svPanorama) {
    svPanorama = new google.maps.StreetViewPanorama(
      document.getElementById('sv-pano'),
      {
        pov:   { heading: 0, pitch: 0 },
        zoom:  1,
        addressControl:       false,
        fullscreenControl:    false,
        motionTracking:       false,
        motionTrackingControl:false,
        showRoadLabels:       true,
        linksControl:         true,
        clickToGo:            true,
      }
    );
    // Hide overlay when SV loads successfully
    svPanorama.addListener('status_changed', () => {
      if (svPanorama.getStatus() === 'OK') {
        const st = document.getElementById('sv-status');
        st.classList.add('sv-hidden');
        setTimeout(() => { st.style.display = 'none'; }, 350);
      } else {
        svSetStatus(
          '<div style="font-size:2.5rem">📷</div>'
          + '<div>Street View אינו זמין בכתובת זו</div>',
          true
        );
      }
    });
  }

  // Geocode → find nearest panorama → aim camera at building
  new google.maps.Geocoder().geocode(
    { address: addr, region: 'IL' },
    (results, status) => {
      if (status !== 'OK' || !results.length) {
        svSetStatus(
          '<div style="font-size:2.5rem">🚫</div>'
          + '<div>לא נמצאה כתובת במפה</div>'
          + '<div style="font-size:.78rem;opacity:.5;margin-top:4px">' + addr + '</div>'
        );
        return;
      }
      const houseLocation = results[0].geometry.location;

      new google.maps.StreetViewService().getPanorama(
        { location: houseLocation, radius: 50 },
        (data, svStatus) => {
          if (svStatus === 'OK') {
            const panoLocation = data.location.latLng;
            const heading = google.maps.geometry.spherical.computeHeading(
              panoLocation, houseLocation
            );
            svPanorama.setPano(data.location.pano);
            svPanorama.setPov({ heading: heading, pitch: 10 });
          } else {
            // No coverage within 50m — fall back to wider search
            new google.maps.StreetViewService().getPanorama(
              { location: houseLocation, radius: 200 },
              (data2, svStatus2) => {
                if (svStatus2 === 'OK') {
                  const panoLocation2 = data2.location.latLng;
                  const heading2 = google.maps.geometry.spherical.computeHeading(
                    panoLocation2, houseLocation
                  );
                  svPanorama.setPano(data2.location.pano);
                  svPanorama.setPov({ heading: heading2, pitch: 10 });
                } else {
                  svSetStatus(
                    '<div style="font-size:2.5rem">📷</div>'
                    + '<div>Street View אינו זמין בכתובת זו</div>'
                    + '<div style="font-size:.78rem;opacity:.5;margin-top:4px">' + addr + '</div>',
                    true
                  );
                }
              }
            );
          }
        }
      );
    }
  );
}

function svShowModal() {
  document.getElementById('sv-modal').style.display = '';
  document.body.style.overflow = 'hidden';
}

function svSetStatus(html, interactive) {
  const st = document.getElementById('sv-status');
  st.style.display    = 'flex';
  st.style.opacity    = '1';
  st.style.pointerEvents = interactive ? 'auto' : 'none';
  st.classList.remove('sv-hidden');
  st.innerHTML = html;
}

function openStreetViewExternal() {
  if (!svPanorama) return;
  const pos = svPanorama.getPosition();
  if (!pos) return;
  window.open(
    'https://www.google.com/maps/@'
    + pos.lat() + ',' + pos.lng()
    + ',3a,75y,0h,90t/data=!3m1!1e3',
    '_blank'
  );
}

function closeStreetView() {
  document.getElementById('sv-modal').style.display = 'none';
  document.body.style.overflow = '';
  // Reset status overlay for next open
  const st = document.getElementById('sv-status');
  st.style.display    = 'flex';
  st.style.opacity    = '1';
  st.style.pointerEvents = 'none';
  st.classList.remove('sv-hidden');
  st.innerHTML = '<div class="sv-spinner"></div><div>טוען תצוגת רחוב…</div>';
}

document.addEventListener('keydown', e => {
  if (document.getElementById('sv-modal').style.display === 'none') return;
  if (e.key === 'Escape') closeStreetView();
});

// ============================================================
// DOCUMENT CENTER
// ============================================================
const DOCS_DEFAULTS = [
  'נסח טאבו',
  'גרמושקה / היתר בנייה',
  'טופס 4',
  'טופס ארנונה / אישור עירייה',
  'מסמכי בית משותף',
  'הסכם רכישה של המוכר',
  'אישור זכויות',
  'חוזה חכירה',
];

let docsData   = null; // lazy-init once
let docsNextId = 0;

function docsInit() {
  if (docsData !== null) return; // already initialised
  docsData = DOCS_DEFAULTS.map(name => ({ id: docsNextId++, name, done: false }));
  docsRender();
}

function docsRender() {
  const list = document.getElementById('docs-list');
  list.innerHTML = '';
  docsData.forEach(doc => list.appendChild(docsRow(doc)));
  docsUpdateProgress();
}

function docsRow(doc) {
  const wrap = document.createElement('div');
  wrap.id = 'doc-row-' + doc.id;
  wrap.style.cssText = `
    display:flex; align-items:center; gap:10px;
    padding:10px 14px; border-radius:10px;
    border:1.5px solid ${doc.done ? '#bbf7d0' : '#e2e8f0'};
    background:${doc.done ? '#f0fdf4' : '#fff'};
    transition:background .2s,border-color .2s;
  `;

  // ── Checkbox ──
  const cb = document.createElement('input');
  cb.type    = 'checkbox';
  cb.checked = doc.done;
  cb.style.cssText = `
    width:20px; height:20px; flex-shrink:0;
    accent-color:#16a34a; cursor:pointer;
    border-radius:5px;
  `;
  cb.addEventListener('change', () => {
    doc.done = cb.checked;
    // Update row styling without full re-render
    wrap.style.background   = doc.done ? '#f0fdf4' : '#fff';
    wrap.style.borderColor  = doc.done ? '#bbf7d0' : '#e2e8f0';
    inp.style.color         = doc.done ? '#16a34a' : 'var(--text)';
    inp.style.textDecoration= doc.done ? 'line-through' : 'none';
    inp.style.opacity       = doc.done ? '0.6' : '1';
    docsUpdateProgress();
  });

  // ── Text input ──
  const inp = document.createElement('input');
  inp.type  = 'text';
  inp.value = doc.name;
  inp.placeholder = 'שם המסמך…';
  inp.style.cssText = `
    flex:1; border:none; outline:none; background:transparent;
    font-family:inherit; font-size:.9rem; font-weight:500;
    color:${doc.done ? '#16a34a' : 'var(--text)'};
    text-decoration:${doc.done ? 'line-through' : 'none'};
    opacity:${doc.done ? '0.6' : '1'};
    transition:color .2s,text-decoration .2s;
    direction:rtl;
    min-width:0;
  `;
  inp.addEventListener('input', () => { doc.name = inp.value; });

  // ── Delete button ──
  const del = document.createElement('button');
  del.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"/><path d="M19 6l-1 14a2 2 0 0 1-2 2H8a2 2 0 0 1-2-2L5 6"/><path d="M10 11v6"/><path d="M14 11v6"/><path d="M9 6V4h6v2"/></svg>`;
  del.title = 'הסר מסמך';
  del.style.cssText = `
    flex-shrink:0; background:none; border:none; cursor:pointer;
    color:#94a3b8; padding:4px; border-radius:6px;
    display:flex; align-items:center; justify-content:center;
    transition:color .15s,background .15s;
  `;
  del.onmouseover = () => { del.style.color='#ef4444'; del.style.background='#fef2f2'; };
  del.onmouseout  = () => { del.style.color='#94a3b8'; del.style.background='none'; };
  del.addEventListener('click', () => {
    docsData = docsData.filter(d => d.id !== doc.id);
    wrap.style.opacity    = '0';
    wrap.style.transform  = 'translateX(12px)';
    wrap.style.transition = 'opacity .2s,transform .2s';
    setTimeout(() => { wrap.remove(); docsUpdateProgress(); }, 200);
  });

  wrap.append(cb, inp, del);
  return wrap;
}

function docsAddRow() {
  const doc = { id: docsNextId++, name: '', done: false };
  docsData.push(doc);
  const list = document.getElementById('docs-list');
  const row  = docsRow(doc);
  row.style.opacity   = '0';
  row.style.transform = 'translateX(-10px)';
  row.style.transition= 'opacity .25s,transform .25s';
  list.appendChild(row);
  requestAnimationFrame(() => {
    row.style.opacity   = '1';
    row.style.transform = 'none';
  });
  // Focus the new input
  row.querySelector('input[type="text"]').focus();
  docsUpdateProgress();
}

function docsUpdateProgress() {
  if (!docsData) return;
  const total = docsData.length;
  const done  = docsData.filter(d => d.done).length;
  const pct   = total ? Math.round(done / total * 100) : 0;

  document.getElementById('docs-progress-bar').style.width   = pct + '%';
  document.getElementById('docs-progress-badge').textContent = done + ' / ' + total + ' מסמכים';

  // Badge colour: green when complete
  const badge = document.getElementById('docs-progress-badge');
  badge.style.background = done === total && total > 0
    ? 'linear-gradient(135deg,#15803d,#16a34a)'
    : 'linear-gradient(135deg,#1e3a5f,#2563eb)';
}

// ============================================================
// SYNC PLANNING STATE  (propNumber only — city/street handled by acHandleInput)
// ============================================================
document.getElementById('propNumber').addEventListener('input', () => {
  state.number = document.getElementById('propNumber').value.trim();
});

// ============================================================
// AUTOCOMPLETE ENGINE – data.gov.il
// ============================================================

// Resource IDs — data.gov.il
const RES_SETTLE  = '5c78e9fa-c2e2-4771-93ff-7f400a12f7ba'; // ישובים  → שם_ישוב, סמל_ישוב
const RES_STREETS = '9ad3862c-8391-4b2f-84a4-2d4c68625f4b'; // רחובות  → שם_רחוב, סמל_ישוב, שם_ישוב

// Which fields link to which
const AC_CONFIG = {
  clientCity:   { type: 'city',   streetPeer: 'clientStreet' },
  propCity:     { type: 'city',   streetPeer: 'propStreet'   },
  clientStreet: { type: 'street', cityPeer: 'clientCity'     },
  propStreet:   { type: 'street', cityPeer: 'propCity'       },
};

// Runtime state per field
const acState = {};
['clientCity','propCity','clientStreet','propStreet'].forEach(id => {
  acState[id] = { timer: null, results: [], selectedIdx: -1, cityCode: null, _onSelect: null };
});

// City code cache: cityName -> סמל_ישוב
const cityCodeCache = {};

// Escape single quotes in SQL strings to prevent broken queries
function sqlEsc(str) { return String(str).replace(/'/g, "''"); }

// ── Debounced input handler ──────────────────────────────────
function acHandleInput(fieldId) {
  const cfg = AC_CONFIG[fieldId];
  const val = document.getElementById(fieldId).value.trim();
  clearTimeout(acState[fieldId].timer);
  // Also sync planning state fields
  if (fieldId === 'propCity')   state.city   = val;
  if (fieldId === 'propStreet') state.street = val;
  if (val.length < 2) { acHide(fieldId); setHint(fieldId, ''); return; }
  acState[fieldId].timer = setTimeout(() => acFetch(fieldId, val, cfg), 280);
  updateState();
}

// ── Fetch dispatcher ─────────────────────────────────────────
async function acFetch(fieldId, query, cfg) {
  const input = document.getElementById(fieldId);
  input.classList.add('loading');
  setHint(fieldId, '');

  try {
    if (cfg.type === 'city') {
      await acFetchCity(fieldId, query);
    } else {
      const cityCode = acState[fieldId].cityCode
        || cityCodeCache[document.getElementById(cfg.cityPeer).value.trim()];
      if (!cityCode) {
        setHint(fieldId, '⚠️ בחר תחילה עיר מהרשימה כדי לסנן רחובות');
        acHide(fieldId);
        input.classList.remove('loading');
        return;
      }
      await acFetchStreet(fieldId, query, cityCode);
    }
    if (acState[fieldId].results.length === 0) {
      setHint(fieldId, `🔍 לא נמצאו תוצאות עבור "${query}"`);
    }
  } catch(e) {
    setHint(fieldId, '❌ שגיאת חיבור ל-data.gov.il — נסה שוב');
    acHide(fieldId);
    console.warn('AC fetch error:', fieldId, e);
  }
  input.classList.remove('loading');
}

// ── Fetch cities/settlements ─────────────────────────────────
// RES_SETTLE (5c78e9fa): שם_ישוב, סמל_ישוב, מחוז, נפה
async function acFetchCity(fieldId, query) {
  const q = sqlEsc(query);
  const base = 'https://data.gov.il/api/3/action/';

  // Primary: SQL starts-with on settlements resource
  const sql = `SELECT "שם_ישוב","סמל_ישוב" FROM "${RES_SETTLE}" WHERE "שם_ישוב" LIKE '${q}%' ORDER BY "שם_ישוב" LIMIT 12`;
  const sqlRes = await Promise.allSettled([
    fetchGovDataRaw(base + 'datastore_search_sql?sql=' + encodeURIComponent(sql))
  ]);

  let items = [];

  if (sqlRes[0].status === 'fulfilled' && sqlRes[0].value?.result?.records?.length) {
    sqlRes[0].value.result.records.forEach(r => {
      const name = (r['שם_ישוב'] || '').trim();
      const code = String(r['סמל_ישוב'] || '');
      if (name) items.push({ label: name, code, type: 'settlement' });
    });
  }

  // Fallback: plain q= search (less precise but always works)
  if (items.length === 0) {
    try {
      const data = await fetchGovDataRaw(
        `${base}datastore_search?resource_id=${RES_SETTLE}&q=${encodeURIComponent(query)}&limit=12`
      );
      (data?.result?.records || []).forEach(r => {
        const name = (r['שם_ישוב'] || '').trim();
        const code = String(r['סמל_ישוב'] || r['_id'] || '');
        if (name && !items.find(i => i.label === name))
          items.push({ label: name, code, type: 'settlement' });
      });
    } catch(_) {}
  }

  items.sort((a, b) => {
    const aS = a.label.startsWith(query) ? 0 : 1;
    const bS = b.label.startsWith(query) ? 0 : 1;
    return aS - bS || a.label.localeCompare(b.label, 'he');
  });
  items = items.slice(0, 10);

  acState[fieldId].results = items;
  acState[fieldId].selectedIdx = -1;
  acRender(fieldId, items, (item) => {
    document.getElementById(fieldId).value = item.label;
    cityCodeCache[item.label] = item.code;
    const streetId = AC_CONFIG[fieldId].streetPeer;
    acState[streetId].cityCode = item.code;
    acState[streetId].results = [];
    document.getElementById(streetId).value = '';
    setHint(streetId, '');
    acHide(fieldId);
    setHint(fieldId, `✅ ישוב: ${item.label}${item.code ? ' (סמל ' + item.code + ')' : ''}`);
    updateState();
  }, '🏙️', '🏘️');
}

// ── Fetch streets ─────────────────────────────────────────────
// RES_STREETS (9ad3862c): שם_רחוב, סמל_ישוב, שם_ישוב, סמל_רחוב
async function acFetchStreet(fieldId, query, cityCode) {
  const q = sqlEsc(query);
  const c = sqlEsc(cityCode);
  const base = 'https://data.gov.il/api/3/action/';
  let items = [];

  // Primary: SQL with city code filter + starts-with on street name
  try {
    const sql = `SELECT DISTINCT "שם_רחוב" FROM "${RES_STREETS}" WHERE "סמל_ישוב"='${c}' AND "שם_רחוב" LIKE '${q}%' ORDER BY "שם_רחוב" LIMIT 15`;
    const data = await fetchGovDataRaw(base + 'datastore_search_sql?sql=' + encodeURIComponent(sql));
    (data?.result?.records || []).forEach(r => {
      const name = (r['שם_רחוב'] || '').trim();
      if (name && !items.find(i => i.label === name)) items.push({ label: name });
    });
  } catch(_) {}

  // Fallback A: datastore_search with filters object + q
  if (items.length === 0) {
    try {
      const filters = encodeURIComponent(JSON.stringify({ 'סמל_ישוב': cityCode }));
      const data = await fetchGovDataRaw(
        `${base}datastore_search?resource_id=${RES_STREETS}&q=${encodeURIComponent(query)}&filters=${filters}&limit=15`
      );
      (data?.result?.records || []).forEach(r => {
        const name = (r['שם_רחוב'] || '').trim();
        if (name && !items.find(i => i.label === name)) items.push({ label: name });
      });
    } catch(_) {}
  }

  // Fallback B: no city filter — at least show something
  if (items.length === 0) {
    try {
      const sql2 = `SELECT DISTINCT "שם_רחוב" FROM "${RES_STREETS}" WHERE "שם_רחוב" LIKE '${q}%' ORDER BY "שם_רחוב" LIMIT 12`;
      const data = await fetchGovDataRaw(base + 'datastore_search_sql?sql=' + encodeURIComponent(sql2));
      (data?.result?.records || []).forEach(r => {
        const name = (r['שם_רחוב'] || '').trim();
        if (name && !items.find(i => i.label === name)) items.push({ label: name });
      });
    } catch(_) {}
  }

  items.sort((a, b) => {
    const aS = a.label.startsWith(query) ? 0 : 1;
    const bS = b.label.startsWith(query) ? 0 : 1;
    return aS - bS || a.label.localeCompare(b.label, 'he');
  });

  acState[fieldId].results = items;
  acState[fieldId].selectedIdx = -1;
  acRender(fieldId, items, (item) => {
    document.getElementById(fieldId).value = item.label;
    acHide(fieldId);
    setHint(fieldId, `✅ רחוב נבחר: ${item.label}`);
    updateState();
  }, '🛣️', '🛣️');
}


// ── Generic fetch helper ─────────────────────────────────────
async function fetchGovDataRaw(url) {
  const res = await fetch(url, { signal: AbortSignal.timeout(8000) });
  if (!res.ok) throw new Error('HTTP ' + res.status);
  return res.json();
}

// ── Render dropdown ──────────────────────────────────────────
function acRender(fieldId, items, onSelect, iconA, iconB) {
  acState[fieldId]._onSelect = onSelect;
  const dropdown = document.getElementById('ac-dropdown-' + fieldId);
  if (!dropdown) return;
  if (!items.length) {
    dropdown.innerHTML = `<div class="ac-empty">לא נמצאו תוצאות</div>`;
    dropdown.style.display = '';
    return;
  }
  dropdown.innerHTML = items.map((item, i) => `
    <div class="ac-item" id="ac-item-${fieldId}-${i}"
      onmousedown="acSelect('${fieldId}', ${i})"
      onmouseover="acHighlight('${fieldId}', ${i})">
      <span class="ac-icon">${item.type === 'settlement' ? iconB : iconA}</span>
      ${item.label}
    </div>`).join('');
  dropdown.style.display = '';
}

function acHighlight(fieldId, idx) {
  acState[fieldId].selectedIdx = idx;
  document.querySelectorAll(`[id^="ac-item-${fieldId}-"]`).forEach((el, i) => {
    el.classList.toggle('selected', i === idx);
  });
}

function acSelect(fieldId, idx) {
  const items = acState[fieldId].results;
  if (!items[idx]) return;
  const cb = acState[fieldId]._onSelect;
  if (cb) cb(items[idx]);
}

function acHandleKey(event, fieldId) {
  const items = acState[fieldId].results;
  let idx = acState[fieldId].selectedIdx;

  if (event.key === 'ArrowDown') {
    event.preventDefault();
    idx = Math.min(idx + 1, items.length - 1);
    acState[fieldId].selectedIdx = idx;
    acHighlight(fieldId, idx);
  } else if (event.key === 'ArrowUp') {
    event.preventDefault();
    idx = Math.max(idx - 1, 0);
    acState[fieldId].selectedIdx = idx;
    acHighlight(fieldId, idx);
  } else if (event.key === 'Enter') {
    event.preventDefault();
    if (idx >= 0 && items[idx]) acSelect(fieldId, idx);
  } else if (event.key === 'Escape') {
    acHide(fieldId);
  }
}

function acHandleBlur(fieldId) {
  setTimeout(() => acHide(fieldId), 200); // allow mousedown to fire first
  updateState();
}

function acHide(fieldId) {
  const dropdown = document.getElementById('ac-dropdown-' + fieldId);
  if (dropdown) dropdown.style.display = 'none';
}

function setHint(fieldId, msg) {
  const el = document.getElementById('ac-hint-' + fieldId);
  if (el) el.innerHTML = msg;
}


// ============================================================
// CHECKLIST COMPLETED TOGGLE
// ============================================================
document.addEventListener('change', (e) => {
  if (e.target.type === 'checkbox' && e.target.closest('.checklist-item')) {
    e.target.closest('.checklist-item').classList.toggle('completed', e.target.checked);
  }
});

// ============================================================
// MOBILE KEYBOARD — scroll focused input into view
// ============================================================
(function() {
  if (!window.visualViewport) return;

  const bottomNav   = document.getElementById('bottom-nav');
  const mobileTopbar = document.getElementById('mobile-topbar');
  let keyboardOpen = false;
  const THRESHOLD = 120; // px: keyboard is open if viewport shrinks by more than this

  const initialHeight = window.visualViewport.height;

  function onViewportResize() {
    const current = window.visualViewport.height;
    const shrinkage = initialHeight - current;
    const isOpen = shrinkage > THRESHOLD;

    if (isOpen !== keyboardOpen) {
      keyboardOpen = isOpen;
      bottomNav.classList.toggle('keyboard-open', isOpen);
      mobileTopbar.classList.toggle('keyboard-open', isOpen);

      if (isOpen) {
        // Give browser a tick, then scroll focused element into view
        setTimeout(() => {
          const el = document.activeElement;
          if (el && el !== document.body) {
            el.scrollIntoView({ behavior: 'smooth', block: 'center' });
          }
        }, 100);
      }
    }
  }

  window.visualViewport.addEventListener('resize', onViewportResize);
  window.visualViewport.addEventListener('scroll', onViewportResize);

  // Also scroll into view on every focus event
  document.addEventListener('focus', (e) => {
    const tag = e.target.tagName;
    if (tag === 'INPUT' || tag === 'SELECT' || tag === 'TEXTAREA') {
      setTimeout(() => {
        e.target.scrollIntoView({ behavior: 'smooth', block: 'center' });
      }, 350); // wait for keyboard animation
    }
  }, true);
})();



// ============================================================
// CASE ID helpers
// ============================================================
const LS_CASES_KEY = 'realestateOS_cases_v1';

function _genId() {
  return 'case_' + Date.now() + '_' + Math.random().toString(36).slice(2,7);
}

function _getAllCases() {
  try { return JSON.parse(localStorage.getItem(LS_CASES_KEY) || '{}'); }
  catch(e) { return {}; }
}

function _setAllCases(obj) {
  localStorage.setItem(LS_CASES_KEY, JSON.stringify(obj));
}

// ============================================================
// SAVE / LOAD / DELETE
// ============================================================
let _activeCaseId = null;

function saveCase() {
  // Gather deadlines dates
  const contractDateEl    = document.getElementById('dl-contract-date');
  const municipalDateEl   = document.getElementById('dl-municipality-date');

  const snapshot = {
    // core state
    clientName:     state.clientName,
    parties:        state.parties || [],
    clientPhone:    state.clientPhone,
    clientEmail:    state.clientEmail,
    clientCity:     state.clientCity,
    clientStreet:   state.clientStreet,
    clientHouseNum: state.clientHouseNum,
    clientZip:      state.clientZip,
    clientAddress:  state.clientAddress,
    role:           state.role,
    price:          state.price,
    buyerMortgage:  state.buyerMortgage,
    sellerMortgage: state.sellerMortgage,
    feeAgreement:   state.feeAgreement,
    foreignResident:state.foreignResident,
    rented:         state.rented,
    urbanRenewal:   state.urbanRenewal,
    upgrader:       state.upgrader,
    city:           state.city,
    street:         state.street,
    number:         state.number,
    gush:           state.gush,
    chelka:         state.chelka,
    propertyType:   state.propertyType,
    openedAt:       state.openedAt instanceof Date ? state.openedAt.toISOString() : state.openedAt,
    // deadlines
    contractDate:   contractDateEl   ? contractDateEl.value   : '',
    municipalDate:  municipalDateEl  ? municipalDateEl.value  : '',
    // payment rows
    pschRows:       (window._pschRows || []).map(function(r) {
      // capture live DOM values
      var a = document.getElementById('pschr-amt-'  + r.id);
      var c = document.getElementById('pschr-cnd-'  + r.id);
      var n = document.getElementById('pschr-nte-'  + r.id);
      return {
        amount:    a ? a.value    : r.amount,
        condition: c ? c.value    : r.condition,
        notes:     n ? n.value    : r.notes
      };
    }),
    // tax state
    taxBuyerType:   window._taxBuyerType  || 'single',
    shabachState:   window._shabachState  || {},
    // meta
    savedAt: new Date().toISOString()
  };

  const all = _getAllCases();
  if (!_activeCaseId) _activeCaseId = _genId();
  all[_activeCaseId] = snapshot;
  _setAllCases(all);

  // Flash save button
  var btn = document.getElementById('save-case-btn');
  if (btn) {
    var orig = btn.innerHTML;
    btn.classList.add('saved');
    btn.innerHTML = '✓ נשמר!';
    setTimeout(function() {
      btn.classList.remove('saved');
      btn.innerHTML = orig;
    }, 1800);
  }
  showToast('✅ התיק נשמר בהצלחה');
}

function loadCase(id) {
  const all  = _getAllCases();
  const snap = all[id];
  if (!snap) return;
  _activeCaseId = id;

  // Restore form fields
  var set = function(elId, val) {
    var el = document.getElementById(elId);
    if (!el) return;
    if (el.type === 'checkbox') el.checked = !!val;
    else el.value = val !== undefined && val !== null ? val : '';
  };

  // Restore parties list
  if (snap.parties && snap.parties.length) {
    window._partyRows = [];
    window._partyNextId = 1;
    snap.parties.forEach(function(p) {
      window._partyRows.push({ id: window._partyNextId++, name: p.name || '', idNum: p.idNum || '' });
    });
  } else if (snap.clientName) {
    // Migrate legacy single-name cases
    window._partyRows = [{ id: 1, name: snap.clientName, idNum: '' }];
    window._partyNextId = 2;
  } else {
    window._partyRows = [];
    window._partyNextId = 1;
  }
  partyRender();
  set('clientName',     snap.clientName);
  set('clientPhone',    snap.clientPhone);
  set('clientEmail',    snap.clientEmail);
  set('clientCity',     snap.clientCity);
  set('clientStreet',   snap.clientStreet);
  set('clientHouseNum', snap.clientHouseNum);
  set('clientZip',      snap.clientZip);
  set('clientAddress',  snap.clientAddress);
  set('clientRole',     snap.role);
  set('price',          snap.price);
  set('buyerMortgage',  snap.buyerMortgage);
  set('sellerMortgage', snap.sellerMortgage);
  set('feeAgreement',   snap.feeAgreement);
  set('foreignResident',snap.foreignResident);
  set('rented',         snap.rented);
  set('urbanRenewal',   snap.urbanRenewal);
  set('upgrader',       snap.upgrader);

  // Restore deadline dates
  set('dl-contract-date',   snap.contractDate  || '');
  set('dl-municipality-date', snap.municipalDate || '');

  // Restore payment rows
  if (snap.pschRows && snap.pschRows.length) {
    window._pschRows = [];
    window._pschIdCounter = 0; // let pschInit re-seed from restored rows
    // We directly push into the engine via the exposed seed path
    snap.pschRows.forEach(function(r) {
      window._pschRows.push({ id: ++window._pschIdCounter, amount: r.amount, condition: r.condition, notes: r.notes });
    });
  }

  // Restore tax state
  if (snap.taxBuyerType) window._taxBuyerType = snap.taxBuyerType;
  if (snap.shabachState) window._shabachState  = snap.shabachState;

  // Restore core state object
  Object.assign(state, {
    clientName:     snap.clientName     || '',
    parties:        snap.parties        || [],
    clientPhone:    snap.clientPhone    || '',
    clientEmail:    snap.clientEmail    || '',
    clientCity:     snap.clientCity     || '',
    clientStreet:   snap.clientStreet   || '',
    clientHouseNum: snap.clientHouseNum || '',
    clientZip:      snap.clientZip      || '',
    clientAddress:  snap.clientAddress  || '',
    role:           snap.role           || '',
    price:          snap.price          || 0,
    buyerMortgage:  snap.buyerMortgage  || 0,
    sellerMortgage: snap.sellerMortgage || 0,
    feeAgreement:   !!snap.feeAgreement,
    foreignResident:!!snap.foreignResident,
    rented:         !!snap.rented,
    urbanRenewal:   !!snap.urbanRenewal,
    upgrader:       !!snap.upgrader,
    city:           snap.city           || '',
    street:         snap.street         || '',
    number:         snap.number         || '',
    gush:           snap.gush           || '',
    chelka:         snap.chelka         || '',
    propertyType:   snap.propertyType   || '',
    openedAt:       snap.openedAt ? new Date(snap.openedAt) : new Date(),
  });

  updateSidebar();
  updateChips();
  updateSummary();
  updateLegalBadge();
  if (typeof pschCalc === 'function') pschCalc();

  // Switch to onboarding tab to show the loaded case
  switchTab('onboarding');
  // Restore property type UI
  if (snap.propertyType) { ptPick(snap.propertyType, true); }
  showToast('📂 תיק נטען: ' + (snap.clientName || 'ללא שם'));
}

function deleteCase(id) {
  const all  = _getAllCases();
  const name = (all[id] && all[id].clientName) ? all[id].clientName : 'תיק זה';
  if (!confirm('למחוק את ' + name + '? לא ניתן לשחזר.')) return;
  delete all[id];
  _setAllCases(all);
  if (_activeCaseId === id) _activeCaseId = null;
  renderDashboard();
  showToast('🗑️ התיק נמחק');
}

function createNewCase() {
  // Reset state
  _activeCaseId = null;
  window._partyRows   = [];
  window._partyNextId = 1;
  window._pschRows = [];
  window._pschIdCounter = 0;
  window._taxBuyerType = 'single';
  window._shabachState = { onlyApt: false, held18: false, inherited: false };

  // Clear all form fields
  // Reset party rows UI
  partyReset();
  var fields = ['clientPhone','clientEmail','clientCity','clientStreet',
    'clientHouseNum','clientZip','clientAddress','price','buyerMortgage','sellerMortgage'];
  fields.forEach(function(id) {
    var el = document.getElementById(id);
    if (el) el.value = '';
  });
  var checks = ['feeAgreement','foreignResident','rented','urbanRenewal','upgrader'];
  checks.forEach(function(id) {
    var el = document.getElementById(id);
    if (el) el.checked = false;
  });
  var roleEl = document.getElementById('clientRole');
  if (roleEl) roleEl.value = '';

  // Reset deadline inputs
  var cd = document.getElementById('dl-contract-date');
  var md = document.getElementById('dl-municipality-date');
  if (cd) cd.value = '';
  if (md) md.value = '';

  Object.assign(state, {
    clientName:'',parties:[],clientPhone:'',clientEmail:'',clientCity:'',clientStreet:'',
    clientHouseNum:'',clientZip:'',clientAddress:'',role:'',price:0,
    buyerMortgage:0,sellerMortgage:0,feeAgreement:false,foreignResident:false,
    rented:false,urbanRenewal:false,upgrader:false,
    city:'',street:'',number:'',gush:'',chelka:'',propertyType:'',openedAt:new Date()
  });

  // Clear property type UI
  document.querySelectorAll('#pt-grid .pt-tile').forEach(function(t){ t.classList.remove('on'); });
  updateSidebar(); updateChips(); updateSummary(); updateLegalBadge();
  switchTab('onboarding');
  showToast('📋 תיק חדש נפתח');
}

// ============================================================
// DASHBOARD RENDERER
// ============================================================
const ROLE_LABELS = { seller: 'מוכר', buyer_2nd: 'קונה יד שנייה', buyer_contractor: 'קונה מקבלן' };
const ROLE_EMOJIS = { seller: '🏷️', buyer_2nd: '🛒', buyer_contractor: '🏗️' };

function renderDashboard() {
  const all   = _getAllCases();
  const ids   = Object.keys(all).sort(function(a,b) {
    return new Date(all[b].savedAt||0) - new Date(all[a].savedAt||0);
  });
  const list  = document.getElementById('dv-cases-list');
  const count = document.getElementById('dv-count');
  if (!list) return;

  if (count) count.textContent = ids.length + ' תיקים';

  if (ids.length === 0) {
    list.innerHTML = '<div class="dv-empty"><div class="dv-empty-icon">📂</div>אין תיקים שמורים עדיין.<br/>לחץ "פתח תיק חדש" כדי להתחיל.</div>';
    return;
  }

  list.innerHTML = ids.map(function(id) {
    var c       = all[id];
    // Show all party names (multi-party support)
    var name;
    if (c.parties && c.parties.length) {
      name = c.parties.map(function(p){ return p.name; }).filter(Boolean).join(' + ') || 'ללא שם';
    } else {
      name = c.clientName || 'ללא שם';
    }
    var role    = c.role || '';
    var roleL   = ROLE_LABELS[role] || 'לא הוגדר';
    var roleE   = ROLE_EMOJIS[role] || '📄';
    var price   = c.price ? '₪' + Number(c.price).toLocaleString('he-IL') : '';
    var saved   = c.savedAt ? new Date(c.savedAt).toLocaleDateString('he-IL') : '';
    var roleClass = role || 'none';
    var badgeClass = role || '';

    return (
      '<div class="dv-card">' +
        '<div class="dv-card-avatar role-' + roleClass + '">' + roleE + '</div>' +
        '<div class="dv-card-info">' +
          '<div class="dv-card-name">' + _dvEsc(name) + '</div>' +
          '<div class="dv-card-meta">' +
            (role ? '<span class="dv-role-badge ' + badgeClass + '">' + roleL + '</span>' : '') +
            (price  ? '<span>' + price  + '</span>' : '') +
            (saved  ? '<span>נשמר: ' + saved + '</span>' : '') +
          '</div>' +
        '</div>' +
        '<div class="dv-card-actions">' +
          '<button class="dv-btn-open" onclick="loadCase(\'' + id + '\')">פתח</button>' +
          '<button class="dv-btn-del" onclick="deleteCase(\'' + id + '\')" title="מחק">🗑️</button>' +
        '</div>' +
      '</div>'
    );
  }).join('');
}

function _dvEsc(s) {
  return (s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}

// ============================================================
// BACKUP — EXPORT / IMPORT
// ============================================================
function exportBackup() {
  var all  = _getAllCases();
  var json = JSON.stringify({ version: 1, exportedAt: new Date().toISOString(), cases: all }, null, 2);
  var blob = new Blob([json], { type: 'application/json' });
  var url  = URL.createObjectURL(blob);
  var a    = document.createElement('a');
  a.href   = url;
  a.download = 'realestateOS_backup_' + new Date().toISOString().slice(0,10) + '.json';
  a.click();
  URL.revokeObjectURL(url);
  showToast('📥 גיבוי יוצא בהצלחה');
}

function importBackup(inputEl) {
  var file = inputEl.files[0];
  if (!file) return;
  var reader = new FileReader();
  reader.onload = function(e) {
    try {
      var data = JSON.parse(e.target.result);
      var cases = data.cases || data; // support both wrapped and raw
      if (typeof cases !== 'object') throw new Error('Invalid format');
      if (!confirm('זה ידרוס את כל התיקים הקיימים. להמשיך?')) return;
      _setAllCases(cases);
      renderDashboard();
      showToast('📤 גיבוי שוחזר בהצלחה — ' + Object.keys(cases).length + ' תיקים');
      closeBackupModal();
    } catch(err) {
      alert('שגיאה בקובץ הגיבוי: ' + err.message);
    }
  };
  reader.readAsText(file);
  inputEl.value = '';
}

function openBackupModal()  { document.getElementById('backup-modal-overlay').classList.add('open'); }
function closeBackupModal() { document.getElementById('backup-modal-overlay').classList.remove('open'); }

// ============================================================
// DEADLINES ENGINE
// ============================================================

// Persist deadline dates in state
function dlSaveAndRender() {
  var cd = document.getElementById('dl-contract-date');
  var md = document.getElementById('dl-municipality-date');
  state._contractDate   = cd ? cd.value : '';
  state._municipalDate  = md ? md.value : '';
  dlRender();
}

function dlRender() {
  var gate = document.getElementById('gate-deadlines');
  if (gate) renderGate('gate-deadlines');

  // Sync input values from state (in case loaded from saved case)
  var cdEl = document.getElementById('dl-contract-date');
  var mdEl = document.getElementById('dl-municipality-date');
  if (cdEl && state._contractDate && !cdEl.value) cdEl.value = state._contractDate;
  if (mdEl && state._municipalDate && !mdEl.value) mdEl.value = state._municipalDate;

  var cdVal = cdEl ? cdEl.value : (state._contractDate || '');
  var mdVal = mdEl ? mdEl.value : (state._municipalDate || '');

  var container = document.getElementById('dl-rows-container');
  if (!container) return;

  if (!cdVal && !mdVal) {
    container.innerHTML = '<div style="color:var(--muted);font-size:.875rem;padding:16px 0;">הזן תאריך חתימת חוזה כדי לחשב מועדים אוטומטית</div>';
    return;
  }

  var rows = [];
  var today = new Date(); today.setHours(0,0,0,0);

  if (cdVal) {
    var cd = new Date(cdVal);

    // Tax Reporting: +30 days
    var taxReport = new Date(cd); taxReport.setDate(taxReport.getDate() + 30);
    rows.push({ icon:'📋', label:'דיווח מס', hint:'30 יום מחתימת חוזה', date: taxReport, countdown: false });

    // Tax Payment: +60 days
    var taxPay = new Date(cd); taxPay.setDate(taxPay.getDate() + 60);
    rows.push({ icon:'💳', label:'תשלום מס', hint:'60 יום מחתימת חוזה', date: taxPay, countdown: false });

    // Upgrader: +18 months (only if upgrader flag)
    if (state.upgrader) {
      var upgrader18 = new Date(cd); upgrader18.setMonth(upgrader18.getMonth() + 18);
      rows.push({ icon:'🏡', label:'תום חלון משפר דיור', hint:'18 חודש מחתימת חוזה', date: upgrader18, countdown: true });
    }
  }

  if (mdVal) {
    var md = new Date(mdVal);
    rows.push({ icon:'🏛️', label:'תפוגת אישור עירייה', hint:'תאריך שהוזן ידנית', date: md, countdown: true });
  }

  if (rows.length === 0) {
    container.innerHTML = '<div style="color:var(--muted);font-size:.875rem;padding:16px 0;">אין מועדים לתצוגה</div>';
    return;
  }

  container.innerHTML = rows.map(function(row) {
    var dateStr = row.date.toLocaleDateString('he-IL', { year:'numeric', month:'long', day:'numeric', weekday:'long' });
    var countdownHtml = '';
    if (row.countdown) {
      var diffMs   = row.date - today;
      var diffDays = Math.ceil(diffMs / 86400000);
      var cls      = diffDays < 0 ? 'past' : diffDays <= 14 ? 'urgent' : diffDays <= 60 ? 'warning' : 'ok';
      var txt      = diffDays < 0 ? 'עבר לפני ' + Math.abs(diffDays) + ' ימים'
                   : diffDays === 0 ? 'היום!'
                   : 'נותרו ' + diffDays + ' ימים';
      countdownHtml = '<span class="dl-countdown ' + cls + '">' + txt + '</span>';
    } else {
      var diffMs2  = row.date - today;
      var daysLeft = Math.ceil(diffMs2 / 86400000);
      var cls2     = daysLeft < 0 ? 'past' : daysLeft <= 7 ? 'urgent' : daysLeft <= 30 ? 'warning' : 'ok';
      var txt2     = daysLeft < 0 ? '⚠️ עבר' : daysLeft === 0 ? '🔴 היום!' : daysLeft + ' ימים';
      countdownHtml = '<span class="dl-countdown ' + cls2 + '">' + txt2 + '</span>';
    }
    return (
      '<div class="dl-row">' +
        '<div class="dl-row-icon">' + row.icon + '</div>' +
        '<div class="dl-row-info">' +
          '<div class="dl-row-label">' + row.label + '</div>' +
          '<div style="font-size:.72rem;color:var(--muted);">' + row.hint + '</div>' +
          '<div class="dl-row-date">' + dateStr + '</div>' +
        '</div>' +
        countdownHtml +
      '</div>'
    );
  }).join('');
}

// ============================================================
// ICS GENERATOR
// ============================================================
function _icsDate(d) {
  // Format: YYYYMMDD
  var y = d.getFullYear();
  var m = String(d.getMonth()+1).padStart(2,'0');
  var day = String(d.getDate()).padStart(2,'0');
  return y + m + day;
}

function _icsEscape(s) {
  return (s||'').replace(/\\/g,'\\\\').replace(/;/g,'\\;').replace(/,/g,'\\,').replace(/\n/g,'\\n');
}

function _icsEvent(uid, summary, dateVal, description) {
  var stamp = _icsDate(new Date());
  return [
    'BEGIN:VEVENT',
    'UID:' + uid + '@realestateOS',
    'DTSTAMP:' + stamp + 'T000000Z',
    'DTSTART;VALUE=DATE:' + _icsDate(dateVal),
    'DTEND;VALUE=DATE:' + _icsDate(new Date(dateVal.getTime() + 86400000)),
    'SUMMARY:' + _icsEscape(summary),
    'DESCRIPTION:' + _icsEscape(description || ''),
    'END:VEVENT'
  ].join('\r\n');
}

function exportICS() {
  var events = [];
  var client = state.clientName || 'לקוח';
  var cdVal  = (document.getElementById('dl-contract-date') || {}).value || state._contractDate || '';
  var mdVal  = (document.getElementById('dl-municipality-date') || {}).value || state._municipalDate || '';

  // ── Deadlines from contract date
  if (cdVal) {
    var cd = new Date(cdVal);

    var taxReport = new Date(cd); taxReport.setDate(taxReport.getDate() + 30);
    events.push(_icsEvent('taxreport', '📋 דיווח מס — ' + client, taxReport, 'דיווח מס לרשות המיסים · 30 יום מחתימת חוזה'));

    var taxPay = new Date(cd); taxPay.setDate(taxPay.getDate() + 60);
    events.push(_icsEvent('taxpay', '💳 תשלום מס — ' + client, taxPay, 'תשלום מס לרשות המיסים · 60 יום מחתימת חוזה'));

    if (state.upgrader) {
      var upg = new Date(cd); upg.setMonth(upg.getMonth() + 18);
      events.push(_icsEvent('upgrader18', '🏡 תום חלון משפר דיור — ' + client, upg, 'על משפר דיור למכור דירה קודמת תוך 18 חודש'));
    }
  }

  // ── Municipality clearance
  if (mdVal) {
    var md = new Date(mdVal);
    events.push(_icsEvent('municipal', '🏛️ תפוגת אישור עירייה — ' + client, md, 'תאריך תפוגת אישור עירייה לעסקה'));
  }

  // ── Payment schedule rows
  var rows = window._pschRows || [];
  rows.forEach(function(row, idx) {
    var amtEl  = document.getElementById('pschr-amt-'  + row.id);
    var condEl = document.getElementById('pschr-cnd-'  + row.id);
    var amt    = amtEl  ? amtEl.value  : row.amount;
    var cond   = condEl ? condEl.value : row.condition;
    if (!amt && !cond) return;
    // Try to parse a date from condition field (ISO or DD/MM/YYYY)
    var dateMatch = (cond||'').match(/(\d{4}-\d{2}-\d{2})|(\d{1,2}[\/\.]\d{1,2}[\/\.]\d{2,4})/);
    var evDate = null;
    if (dateMatch) {
      var raw = dateMatch[0];
      if (raw.includes('-')) {
        evDate = new Date(raw);
      } else {
        var parts = raw.split(/[\/\.]/);
        evDate = new Date(parts[2] + '-' + parts[1].padStart(2,'0') + '-' + parts[0].padStart(2,'0'));
      }
    } else if (cdVal) {
      // Fallback: spread evenly after contract date (2 weeks * index)
      evDate = new Date(cdVal);
      evDate.setDate(evDate.getDate() + (idx+1)*14);
    }
    if (!evDate || isNaN(evDate)) return;
    var summary = '💰 תשלום ' + (idx+1) + ' — ' + (amt ? '₪'+Number(amt).toLocaleString('he-IL') : '') + ' — ' + client;
    var desc    = (cond || '') + (row.notes ? ' | ' + row.notes : '');
    events.push(_icsEvent('psch' + (row.id || idx), summary, evDate, desc));
  });

  if (events.length === 0) {
    alert('אין מועדים לייצוא. הזן תאריך חתימת חוזה כדי לחשב מועדים.');
    return;
  }

  var ics = [
    'BEGIN:VCALENDAR',
    'VERSION:2.0',
    'PRODID:-//RealEstateOS//Gemini Legal//HE',
    'CALSCALE:GREGORIAN',
    'METHOD:PUBLISH',
    'X-WR-CALNAME:עסקת נדל"ן — ' + _icsEscape(client),
    'X-WR-TIMEZONE:Asia/Jerusalem',
    events.join('\r\n'),
    'END:VCALENDAR'
  ].join('\r\n');

  var blob = new Blob([ics], { type: 'text/calendar;charset=utf-8' });
  var url  = URL.createObjectURL(blob);
  var a    = document.createElement('a');
  a.href   = url;
  a.download = 'deal-deadlines.ics';
  a.click();
  URL.revokeObjectURL(url);
  showToast('🗓️ קובץ ICS הורד בהצלחה — ' + events.length + ' אירועים');
}

// ============================================================
// TOAST
// ============================================================
var _toastTimer = null;
function showToast(msg) {
  var el = document.getElementById('toast');
  if (!el) return;
  el.textContent = msg;
  el.classList.add('show');
  if (_toastTimer) clearTimeout(_toastTimer);
  _toastTimer = setTimeout(function() { el.classList.remove('show'); }, 2800);
}

// ============================================================
// BOOTSTRAP — show dashboard on first load
// ============================================================
(function() {
  // Start on dashboard
  document.addEventListener('DOMContentLoaded', function() {
    showDashboard();
  });
  // Also fire if DOM already ready (script runs after parse)
  if (document.readyState !== 'loading') {
    setTimeout(showDashboard, 0);
  }
})();

// ============================================================
// MULTI-PARTY CLIENT ENGINE
// ============================================================
(function() {

  window._partyRows   = window._partyRows   || [];
  window._partyNextId = window._partyNextId || 1;

  // ── Public API
  window.partyAdd     = partyAdd;
  window.partyDelete  = partyDelete;
  window.partyRender  = partyRender;
  window.partyCollect = partyCollect;
  window.partyReset   = partyReset;

  // ── Seed one empty row on first init
  function partyInit() {
    if (!window._partyRows || window._partyRows.length === 0) {
      window._partyRows = [{ id: window._partyNextId++, name: '', idNum: '' }];
    }
    partyRender();
  }

  // ── Add a blank row
  function partyAdd() {
    _collectLive();
    window._partyRows.push({ id: window._partyNextId++, name: '', idNum: '' });
    partyRender();
    // Focus new row's name field
    setTimeout(function() {
      var last = window._partyRows[window._partyRows.length - 1];
      var el   = document.getElementById('party-name-' + last.id);
      if (el) el.focus();
    }, 40);
  }

  // ── Delete a row
  function partyDelete(id) {
    if (window._partyRows.length <= 1) return;
    _collectLive();
    window._partyRows = window._partyRows.filter(function(r) { return r.id !== id; });
    partyRender();
    updateState();
  }

  // ── Reset to one empty row
  function partyReset() {
    window._partyRows   = [];
    window._partyNextId = 1;
    partyAdd();
  }

  // ── Collect live DOM values into _partyRows
  function _collectLive() {
    window._partyRows.forEach(function(row) {
      var n = document.getElementById('party-name-'  + row.id);
      var i = document.getElementById('party-idnum-' + row.id);
      if (n) row.name  = n.value.trim();
      if (i) row.idNum = i.value.trim();
    });
  }

  // ── Return clean array for state.parties
  function partyCollect() {
    _collectLive();
    return window._partyRows.map(function(r) {
      return { name: r.name, idNum: r.idNum };
    });
  }

  // ── Re-render all rows
  function partyRender() {
    var container = document.getElementById('party-rows');
    if (!container) return;

    var rows  = window._partyRows;
    var count = rows.length;

    // Update count badge
    var badge = document.getElementById('party-count-badge');
    if (badge) badge.textContent = count + (count === 1 ? ' צד' : ' צדדים');

    container.innerHTML = rows.map(function(row, idx) {
      var canDel = count > 1;
      return (
        '<div class="party-row" id="party-row-' + row.id + '">' +
          '<span class="party-idx">צד ' + (idx + 1) + '</span>' +

          // Name field
          '<div>' +
            '<span class="party-label">שם מלא</span>' +
            '<input type="text"' +
              ' class="party-input"' +
              ' id="party-name-' + row.id + '"' +
              ' value="' + _esc(row.name) + '"' +
              ' placeholder="ישראל ישראלי"' +
              ' oninput="updateState()"' +
              ' onblur="updateState()" />' +
          '</div>' +

          // ID number field
          '<div>' +
            '<span class="party-label">תעודת זהות</span>' +
            '<input type="text" inputmode="numeric" maxlength="9"' +
              ' class="party-input party-input-id"' +
              ' id="party-idnum-' + row.id + '"' +
              ' value="' + _esc(row.idNum) + '"' +
              ' placeholder="000000000"' +
              ' oninput="updateState()"' +
              ' onblur="updateState()" />' +
          '</div>' +

          // Delete button
          '<button class="party-del"' +
            ' onclick="partyDelete(' + row.id + ')"' +
            (canDel ? '' : ' disabled') +
            ' title="הסר צד">' +
            '<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor"' +
              ' stroke-width="2.5" stroke-linecap="round">' +
              '<polyline points="3 6 5 6 21 6"/>' +
              '<path d="M19 6l-1 14H6L5 6"/>' +
              '<path d="M10 11v6M14 11v6"/>' +
              '<path d="M9 6V4h6v2"/>' +
            '</svg>' +
          '</button>' +
        '</div>'
      );
    }).join('');
  }

  function _esc(s) {
    return (s || '').replace(/&/g,'&amp;').replace(/"/g,'&quot;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
  }

  // ── Init on DOMContentLoaded
  document.addEventListener('DOMContentLoaded', function() {
    // Only init if no rows were restored from a loaded case
    if (!window._partyRows || window._partyRows.length === 0) {
      partyInit();
    } else {
      partyRender();
    }
  });
  if (document.readyState !== 'loading') {
    setTimeout(function() {
      if (!window._partyRows || window._partyRows.length === 0) partyInit();
      else partyRender();
    }, 0);
  }

})();
// ── end party engine ────────────────────────────────────────────

</script>

<!-- ══════════════════════════════════════════════════════
     AI COPILOT — floating chat widget
══════════════════════════════════════════════════════ -->

<!-- Floating bubble -->
<button id="ai-bubble" onclick="aiTogglePanel()" title="עוזר AI משפטי">
  🤖
  <span id="ai-bubble-badge"></span>
</button>

<!-- Chat panel -->
<div id="ai-panel" class="ai-hidden">

  <!-- Header -->
  <div id="ai-header">
    <div id="ai-header-avatar">⚖️</div>
    <div id="ai-header-info">
      <strong>עוזר משפטי AI</strong>
      <span id="ai-online-dot">● מוכן לסיוע</span>
    </div>
    <div id="ai-header-btns">
      <button class="ai-hbtn" onclick="aiOpenSettings()" title="הגדרות API">⚙️</button>
      <button class="ai-hbtn" onclick="aiClearChat()" title="נקה שיחה">🗑️</button>
      <button class="ai-hbtn" onclick="aiTogglePanel()" title="סגור">✕</button>
    </div>
  </div>

  <!-- Context bar -->
  <div id="ai-context-bar">
    <span>📎</span>
    <span id="ai-context-text">אין עסקה פעילה</span>
  </div>

  <!-- Messages -->
  <div id="ai-messages">
    <!-- Welcome message injected by JS -->
  </div>

  <!-- Typing indicator (lives inside messages) -->

  <!-- Input row -->
  <div id="ai-input-row">
    <textarea id="ai-input" rows="1"
      placeholder="שאל שאלה משפטית..."
      onkeydown="aiInputKeydown(event)"
      oninput="aiInputResize(this)"></textarea>
    <button id="ai-send-btn" onclick="aiSend()" title="שלח">
      ➤
    </button>
  </div>
</div>

<!-- Settings modal -->
<div id="ai-settings-modal" class="ai-hidden">
  <div id="ai-settings-box">
    <div id="ai-settings-hdr">
      <h3>⚙️ הגדרות AI Copilot</h3>
      <p>הכנס את מפתח ה-API של Google Gemini להפעלת העוזר החכם</p>
    </div>
    <div id="ai-settings-body">
      <label for="ai-key-input">מפתח Gemini API Key</label>
      <input type="password" id="ai-key-input"
        placeholder="AIza..."
        autocomplete="off" spellcheck="false"/>
      <div id="ai-key-hint">
        ניתן להשיג מפתח חינמי בכתובת:
        <a href="https://aistudio.google.com/app/apikey" target="_blank"
          style="color:#6366f1;text-decoration:underline;">
          aistudio.google.com/app/apikey
        </a>
        <br/>המפתח נשמר מקומית בדפדפן בלבד ואינו נשלח לשרת.
      </div>
    </div>
    <div id="ai-settings-footer">
      <button class="ai-settings-btn ai-settings-btn-cancel" onclick="aiCloseSettings()">ביטול</button>
      <button class="ai-settings-btn ai-settings-btn-save" onclick="aiSaveKey()">שמור מפתח</button>
    </div>
  </div>
</div>

<script>

// ============================================================
// AI COPILOT  —  Gemini BYOK Chat Assistant
// ============================================================
const AI_GEMINI_URL =
  'https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=';
const AI_LS_KEY   = 'gemini_api_key_v1';
const AI_ROLE_MAP = { seller: 'מוכר', buyer_2nd: 'קונה יד שנייה', buyer_contractor: 'קונה מקבלן' };

let aiPanelOpen  = false;
let aiTypingEl   = null;
let aiUnread     = 0;

/* ── Init ─────────────────────────────────────────────── */
(function aiInit() {
  aiRefreshKeyIndicator();
  aiUpdateContext();
  aiAppendWelcome();
})();

function aiAppendWelcome() {
  const hasKey = !!localStorage.getItem(AI_LS_KEY);
  const msg = hasKey
    ? '👋 שלום! אני עוזר ה-AI המשפטי שלך.\n\nאני מודע לפרטי העסקה הפעילה ויכול לענות על שאלות בנושאי נדל"ן, מיסוי, וחוזים.'
    : '👋 שלום! אני עוזר ה-AI המשפטי שלך.\n\n⚠️ כדי להפעיל אותי, לחץ על ⚙️ והכנס מפתח Gemini API. קבל מפתח חינמי בכתובת: aistudio.google.com/app/apikey';
  aiAppendMsg('bot', msg);
}

/* ── Panel toggle ──────────────────────────────────────── */
function aiTogglePanel() {
  aiPanelOpen = !aiPanelOpen;
  const panel = document.getElementById('ai-panel');
  panel.classList.toggle('ai-hidden', !aiPanelOpen);
  if (aiPanelOpen) {
    aiUnread = 0;
    const badge = document.getElementById('ai-bubble-badge');
    badge.style.display = 'none';
    aiUpdateContext();
    setTimeout(() => {
      const msgs = document.getElementById('ai-messages');
      msgs.scrollTop = msgs.scrollHeight;
      document.getElementById('ai-input').focus();
    }, 100);
  }
}

/* ── Context builder ───────────────────────────────────── */
function aiGetContext() {
  const role  = AI_ROLE_MAP[state.role] || '---';
  const price = state.price ? '₪' + state.price.toLocaleString('he-IL') : '---';
  const city  = (document.getElementById('propCity')  ? document.getElementById('propCity').value  : state.city  || '').trim()  || (state.city   || '---');
  const street= (document.getElementById('propStreet')? document.getElementById('propStreet').value: state.street|| '').trim() || (state.street || '---');
  const gush  = (document.getElementById('propGush')  ? document.getElementById('propGush').value  : '') || '---';
  const chelka= (document.getElementById('propChelka')? document.getElementById('propChelka').value: '') || '---';
  const client= state.clientName || '---';
  return { role, price, city, street, gush, chelka, client };
}

function aiUpdateContext() {
  const c = aiGetContext();
  const parts = [];
  if (c.client !== '---') parts.push('👤 ' + c.client);
  if (c.role   !== '---') parts.push('🎭 ' + c.role);
  if (c.price  !== '---') parts.push('💰 ' + c.price);
  if (c.city   !== '---') parts.push('📍 ' + c.city);
  if (c.gush   !== '---') parts.push('גוש ' + c.gush + '/' + c.chelka);
  const el = document.getElementById('ai-context-text');
  if (el) el.textContent = parts.length
    ? parts.join(' · ')
    : 'אין עסקה פעילה — מלא פרטים בפתיחת תיק';
}

/* ── System prompt ─────────────────────────────────────── */
function aiSystemPrompt() {
  const c = aiGetContext();
  return 'אתה עוזר AI מומחה בדיני מקרקעין ונדל"ן בישראל. אתה מסייע לעורך דין בניהול עסקת מקרקעין.\n\n' +
    'פרטי העסקה הפעילה:\n' +
    '- לקוח: ' + c.client + '\n' +
    '- תפקיד: ' + c.role + '\n' +
    '- מחיר: ' + c.price + '\n' +
    '- עיר: ' + c.city + ' | רחוב: ' + c.street + '\n' +
    '- גוש: ' + c.gush + ' | חלקה: ' + c.chelka + '\n' +
    '- שכ"ט נחתם: ' + (state.feeAgreement ? 'כן' : 'לא') + '\n' +
    '- תושב חוץ: ' + (state.foreignResident ? 'כן' : 'לא') + '\n' +
    '- נכס מושכר: ' + (state.rented ? 'כן' : 'לא') + '\n' +
    '- התחדשות עירונית: ' + (state.urbanRenewal ? 'כן' : 'לא') + '\n' +
    '- משפר דיור: ' + (state.upgrader ? 'כן' : 'לא') + '\n\n' +
    'הנחיות:\n' +
    '1. ענה תמיד בעברית בלבד.\n' +
    '2. היה תמציתי, מקצועי ומדויק.\n' +
    '3. בסיום תשובות ארוכות ציין: "⚠️ זו אינה ייעוץ משפטי — יש להיוועץ בעורך דין."\n' +
    '4. אם חסר מידע רלוונטי, שאל שאלת הבהרה אחת.';
}

/* ── Main send ─────────────────────────────────────────── */
async function aiSend() {
  const input   = document.getElementById('ai-input');
  const userMsg = input.value.trim();
  if (!userMsg) return;

  const apiKey = localStorage.getItem(AI_LS_KEY);
  if (!apiKey) {
    aiAppendMsg('system', '⚙️ מפתח API חסר — לחץ על כפתור ⚙️ כדי להכניס מפתח Gemini.');
    aiOpenSettings();
    return;
  }

  aiAppendMsg('user', userMsg);
  input.value = '';
  aiInputResize(input);
  document.getElementById('ai-send-btn').disabled = true;
  aiShowTyping();

  try {
    const body = {
      system_instruction: { parts: [{ text: aiSystemPrompt() }] },
      contents: [{ role: 'user', parts: [{ text: userMsg }] }],
      generationConfig: { temperature: 0.7, maxOutputTokens: 1024 }
    };

    const res = await fetch(AI_GEMINI_URL + apiKey, {
      method:  'POST',
      headers: { 'Content-Type': 'application/json' },
      body:    JSON.stringify(body),
    });

    aiHideTyping();

    if (!res.ok) {
      const err = await res.json().catch(() => ({}));
      const msg = err && err.error && err.error.message ? err.error.message : 'שגיאה לא ידועה';
      if (res.status === 400 && msg.includes('API_KEY'))
        aiAppendMsg('system', '🔑 מפתח API לא תקין — בדוק ב-⚙️ הגדרות.');
      else if (res.status === 429)
        aiAppendMsg('system', '⏳ הגעת למגבלת הקריאות. המתן דקה ונסה שוב.');
      else
        aiAppendMsg('system', '❌ שגיאה: ' + msg);
      return;
    }

    const data = await res.json();
    const text = data && data.candidates && data.candidates[0] &&
                 data.candidates[0].content && data.candidates[0].content.parts &&
                 data.candidates[0].content.parts[0] && data.candidates[0].content.parts[0].text;
    if (text) {
      aiAppendMsg('bot', text.trim());
    } else {
      aiAppendMsg('system', '⚠️ לא התקבלה תשובה. נסה שוב.');
    }
  } catch (e) {
    aiHideTyping();
    aiAppendMsg('system', '🌐 שגיאת רשת — בדוק חיבור אינטרנט.');
  } finally {
    document.getElementById('ai-send-btn').disabled = false;
    document.getElementById('ai-input').focus();
  }
}

/* ── Message rendering ─────────────────────────────────── */
function aiAppendMsg(type, text) {
  const msgs = document.getElementById('ai-messages');
  const div  = document.createElement('div');
  div.className = 'ai-msg ai-msg-' + type;
  div.textContent = text;
  msgs.appendChild(div);
  msgs.scrollTop = msgs.scrollHeight;

  if (!aiPanelOpen && type === 'bot') {
    aiUnread++;
    const badge = document.getElementById('ai-bubble-badge');
    badge.textContent = aiUnread;
    badge.style.display = 'flex';
  }
}

/* ── Typing indicator ──────────────────────────────────── */
function aiShowTyping() {
  const msgs = document.getElementById('ai-messages');
  if (aiTypingEl) aiTypingEl.remove();
  aiTypingEl = document.createElement('div');
  aiTypingEl.style.cssText = 'display:flex;gap:5px;align-items:center;padding:10px 14px;' +
    'background:#f3f4f6;border-radius:16px;border-bottom-left-radius:4px;align-self:flex-start;';
  aiTypingEl.innerHTML =
    '<span style="width:7px;height:7px;border-radius:50%;background:#9ca3af;animation:aiTypingDot 1.2s ease-in-out infinite;display:inline-block"></span>' +
    '<span style="width:7px;height:7px;border-radius:50%;background:#9ca3af;animation:aiTypingDot 1.2s ease-in-out .2s infinite;display:inline-block"></span>' +
    '<span style="width:7px;height:7px;border-radius:50%;background:#9ca3af;animation:aiTypingDot 1.2s ease-in-out .4s infinite;display:inline-block"></span>';
  msgs.appendChild(aiTypingEl);
  msgs.scrollTop = msgs.scrollHeight;
}
function aiHideTyping() {
  if (aiTypingEl) { aiTypingEl.remove(); aiTypingEl = null; }
}

/* ── Input helpers ─────────────────────────────────────── */
function aiInputKeydown(e) {
  if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); aiSend(); }
}
function aiInputResize(el) {
  el.style.height = 'auto';
  el.style.height = Math.min(el.scrollHeight, 100) + 'px';
}

/* ── Clear chat ────────────────────────────────────────── */
function aiClearChat() {
  document.getElementById('ai-messages').innerHTML = '';
  aiTypingEl = null;
  aiAppendWelcome();
}

/* ── Settings ──────────────────────────────────────────── */
function aiOpenSettings() {
  const modal = document.getElementById('ai-settings-modal');
  const inp   = document.getElementById('ai-key-input');
  inp.value   = localStorage.getItem(AI_LS_KEY) || '';
  modal.classList.remove('ai-hidden');
  setTimeout(function() { inp.focus(); }, 80);
}
function aiCloseSettings() {
  document.getElementById('ai-settings-modal').classList.add('ai-hidden');
}
function aiSaveKey() {
  const key = document.getElementById('ai-key-input').value.trim();
  if (key) {
    localStorage.setItem(AI_LS_KEY, key);
    aiAppendMsg('system', '✅ מפתח API נשמר. מוכן לענות על שאלות!');
  } else {
    localStorage.removeItem(AI_LS_KEY);
    aiAppendMsg('system', 'ℹ️ מפתח API הוסר.');
  }
  aiRefreshKeyIndicator();
  aiCloseSettings();
  if (!aiPanelOpen) aiTogglePanel();
}
function aiRefreshKeyIndicator() {
  const dot = document.getElementById('ai-key-indicator');
  if (!dot) return;
  const hasKey = !!localStorage.getItem(AI_LS_KEY);
  dot.style.background = hasKey ? '#22c55e' : '#ef4444';
  dot.title = hasKey ? 'מפתח API מוגדר' : 'מפתח API חסר';
}

// Close settings modal on backdrop click
document.getElementById('ai-settings-modal').addEventListener('click', function(e) {
  if (e.target === this) aiCloseSettings();
});

// Wrap updateState to keep AI context in sync
(function() {
  const _orig = updateState;
  updateState = function() {
    _orig();
    aiUpdateContext();
  };
})();


// ════════════════════════════════════════════════════════════════
// PAYMENT SCHEDULE BUILDER — engine
// ════════════════════════════════════════════════════════════════

(function() {

  // ── Internal state ────────────────────────────────────────────
  let _rows   = [];   // [{ id, amount, condition, notes }]
  let _nextId = 1;

  // ── Public API ────────────────────────────────────────────────
  window.pschInit    = pschInit;
  window.pschAddRow  = pschAddRow;
  window.pschDelRow  = pschDelRow;
  window.pschOnInput = pschOnInput;
  window.pschCalc    = pschCalc;
  window.pschReset   = pschReset;

  // ── pschInit: called when Finance tab opens ───────────────────
  function pschInit() {
    const container = document.getElementById('psch-rows');
    if (!container) return;
    if (_rows.length === 0) {
      // Seed with one default row that maps to typical Israeli RE payments
      _addRowData({ amount: '', condition: 'במעמד החתימה', notes: 'שיק בנקאי / העברה בנקאית' });
    }
    _render();
    pschCalc();
  }

  // ── Add a row (optionally pre-filled) ─────────────────────────
  function pschAddRow(data) {
    const id = _addRowData(data || {});
    _render();
    pschCalc();
    // Auto-focus the amount field of the new row
    setTimeout(function() {
      const el = document.getElementById('pschr-amt-' + id);
      if (el) { el.focus(); el.select(); }
    }, 40);
  }

  function _addRowData(data) {
    const id = _nextId++;
    _rows.push({
      id:        id,
      amount:    data.amount    !== undefined ? data.amount    : '',
      condition: data.condition !== undefined ? data.condition : '',
      notes:     data.notes     !== undefined ? data.notes     : '',
    });
    return id;
  }

  // ── Delete row ─────────────────────────────────────────────────
  function pschDelRow(id) {
    if (_rows.length <= 1) return;
    _collect();           // save current values before splice
    _rows = _rows.filter(function(r) { return r.id !== id; });
    _render();
    pschCalc();
  }

  // ── Collect current DOM values → _rows ────────────────────────
  function _collect() {
    _rows.forEach(function(row) {
      var a = document.getElementById('pschr-amt-'  + row.id);
      var c = document.getElementById('pschr-cnd-'  + row.id);
      var n = document.getElementById('pschr-nte-'  + row.id);
      if (a) row.amount    = a.value;
      if (c) row.condition = c.value;
      if (n) row.notes     = n.value;
    });
  }

  // ── Re-render all rows ─────────────────────────────────────────
  function _render() {
    var container = document.getElementById('psch-rows');
    if (!container) return;

    container.innerHTML = _rows.map(function(row, idx) {
      var canDelete = _rows.length > 1;
      var escAmt  = _esc(String(row.amount));
      var escCond = _esc(String(row.condition));
      var escNote = _esc(String(row.notes));

      return (
        '<div class="psch-row" id="pschr-' + row.id + '">' +
          '<span class="psch-row-idx">תשלום ' + (idx + 1) + '</span>' +

          // ── Amount ──
          '<div class="psch-field">' +
            '<div class="psch-field-label">סכום</div>' +
            '<div class="psch-amt-wrap">' +
              '<span class="psch-ils-sign">₪</span>' +
              '<input type="number" min="0" step="1000" inputmode="numeric"' +
                ' class="psch-input psch-input-amount"' +
                ' id="pschr-amt-' + row.id + '"' +
                ' value="' + escAmt + '"' +
                ' placeholder="0"' +
                ' oninput="pschOnInput()"' +
                ' onblur="_pschCollectProxy()" />' +
            '</div>' +
          '</div>' +

          // ── Condition ──
          '<div class="psch-field">' +
            '<div class="psch-field-label">מועד / תנאי</div>' +
            '<input type="text"' +
              ' class="psch-input"' +
              ' id="pschr-cnd-' + row.id + '"' +
              ' value="' + escCond + '"' +
              ' placeholder="במעמד החתימה / לאחר רישום הע&quot;א..."' +
              ' onblur="_pschCollectProxy()" />' +
          '</div>' +

          // ── Notes ──
          '<div class="psch-field">' +
            '<div class="psch-field-label">הערות משפטיות</div>' +
            '<input type="text"' +
              ' class="psch-input"' +
              ' id="pschr-nte-' + row.id + '"' +
              ' value="' + escNote + '"' +
              ' placeholder="שיק בנקאי / כנגד מסמכי העברה..."' +
              ' onblur="_pschCollectProxy()" />' +
          '</div>' +

          // ── Delete ──
          '<button class="psch-del" ' +
            'onclick="pschDelRow(' + row.id + ')" ' +
            (canDelete ? '' : 'disabled ') +
            'title="הסר תשלום">' +
            '<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor"' +
              ' stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">' +
              '<polyline points="3 6 5 6 21 6"/>' +
              '<path d="M19 6l-1 14H6L5 6"/>' +
              '<path d="M10 11v6M14 11v6"/>' +
              '<path d="M9 6V4h6v2"/>' +
            '</svg>' +
          '</button>' +
        '</div>'
      );
    }).join('');
  }

  // Expose _collect for blur handlers
  window._pschCollectProxy = function() { _collect(); };

  // ── Input handler (fires on every keystroke in amount fields) ─
  function pschOnInput() {
    pschCalc();
  }

  // ── THE VALIDATION ENGINE ──────────────────────────────────────
  function pschCalc() {
    var price  = (typeof state !== 'undefined' && state.price) ? state.price : 0;
    var priceBadge = document.getElementById('psch-price-badge');
    if (priceBadge) {
      priceBadge.textContent = price ? '\u20aa' + price.toLocaleString('he-IL') : '---';
    }

    // Sum live DOM values
    var sum = 0;
    _rows.forEach(function(row) {
      var el = document.getElementById('pschr-amt-' + row.id);
      var v  = el ? parseFloat(el.value) : parseFloat(row.amount);
      if (!isNaN(v) && v > 0) sum += v;
    });

    // Elements
    var footer  = document.getElementById('psch-footer');
    var icon    = document.getElementById('psch-foot-icon');
    var label   = document.getElementById('psch-foot-label');
    var sub     = document.getElementById('psch-foot-sub');
    var fill    = document.getElementById('psch-prog-fill');
    var pctLbl  = document.getElementById('psch-pct-lbl');
    if (!footer) return;

    // Helper
    var IL = function(n) { return '\u20aa' + Math.round(n).toLocaleString('he-IL'); };

    // Progress pct (cap at 100 for bar, show real for label)
    var fillPct   = price > 0 ? Math.min(100, (sum / price) * 100) : 0;
    var displayPct= price > 0 ? Math.round((sum / price) * 100) : 0;

    // Remove all state classes
    footer.classList.remove('state-empty','state-under','state-exact','state-over');

    if (sum === 0 || !price) {
      // ── Empty / no price
      footer.classList.add('state-empty');
      icon.textContent   = '📊';
      label.textContent  = price ? 'הזן סכומים כדי לבדוק פריסה' : 'הזן מחיר עסקה בלשונית פתיחת תיק';
      sub.textContent    = '';
      fill.style.width   = '0%';
      fill.style.background = '#94a3b8';
      pctLbl.textContent = '';

    } else if (Math.abs(sum - price) < 1) {
      // ── ✓ Exact match
      footer.classList.add('state-exact');
      icon.textContent   = '✅';
      label.textContent  = '✓ פריסת התשלומים תואמת בדיוק לשווי העסקה';
      sub.textContent    = 'סה״כ: ' + IL(sum);
      fill.style.width   = '100%';
      fill.style.background = '#22c55e';
      pctLbl.textContent = '100%';

    } else if (sum < price) {
      // ── Under — show remainder
      var remainder = price - sum;
      footer.classList.add('state-under');
      icon.textContent   = '⚖️';
      label.textContent  = 'יתרה לחלוקה: ' + IL(remainder);
      sub.textContent    = 'מחולק ' + IL(sum) + ' מתוך ' + IL(price);
      fill.style.width   = fillPct + '%';
      fill.style.background = '#f59e0b';
      pctLbl.textContent = displayPct + '%';

    } else {
      // ── Over — show excess
      var excess = sum - price;
      footer.classList.add('state-over');
      icon.textContent   = '⚠️';
      label.textContent  = '⚠ שגיאה: סך התשלומים חורג ב-' + IL(excess) + ' משווי העסקה!';
      sub.textContent    = 'סה״כ: ' + IL(sum) + ' | מחיר: ' + IL(price);
      fill.style.width   = '100%';
      fill.style.background = '#ef4444';
      pctLbl.textContent = displayPct + '%';
    }
  }

  // ── Reset ──────────────────────────────────────────────────────
  function pschReset() {
    if (!confirm('לאפס את לוח התשלומים? הפעולה תמחק את כל השורות.')) return;
    _rows   = [];
    _nextId = 1;
    pschAddRow(null);
  }

  // ── Tiny XSS-safe escape for attribute values ─────────────────
  function _esc(s) {
    return (s || '').replace(/&/g,'&amp;').replace(/"/g,'&quot;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
  }

})();
// ── end Payment Schedule engine ──────────────────────────────────


// ════════════════════════════════════════════════════════════════
// PROPERTY TYPE ENGINE
// ════════════════════════════════════════════════════════════════

// 49Z persistent state
window._s49zOn     = window._s49zOn     || false;
window._s49zAmount = window._s49zAmount || 0;

/**
 * ptPick(val, silent)
 * val    — 'apartment'|'house'|'land'|'commercial'|'building'
 * silent — true = don't call updateState (used during load)
 */
function ptPick(val, silent) {
  // Update tile styles
  document.querySelectorAll('#pt-grid .pt-tile').forEach(function(t) {
    t.classList.toggle('on', t.dataset.pt === val);
  });

  // Update state
  state.propertyType = val || '';

  // Hint text
  const hints = {
    apartment:  '✅ דירת מגורים — חישוב מדרגות מס רכישה סטנדרטי',
    house:      '✅ בית פרטי — מדרגות סטנדרטיות + סעיף 49ז׳ בשבח',
    land:       '⚠️ מגרש — מס רכישה בשיעור אחיד 6%',
    commercial: '⚠️ נכס מסחרי — מס רכישה בשיעור אחיד 6%',
    building:   '⚠️ בניין — מס רכישה בשיעור אחיד 6%',
  };
  var hint = document.getElementById('pt-hint');
  if (hint) hint.textContent = hints[val] || '';

  // Reset 49Z if switching away from house
  if (val !== 'house') {
    window._s49zOn = false;
    window._s49zAmount = 0;
  }

  if (!silent) {
    updateState();
    // If tax tab is visible, re-render immediately
    var tt = document.getElementById('tab-tax');
    if (tt && tt.style.display !== 'none') renderTax();
  }
}

/**
 * s49zToggle(event) — toggle Section 49Z
 * Called from onclick on the .s49z-card div
 */
function s49zToggle(event) {
  // Don't toggle when clicking inside the input
  if (event && event.target && (event.target.tagName === 'INPUT' || event.target.tagName === 'LABEL')) return;
  window._s49zOn = !window._s49zOn;
  if (!window._s49zOn) window._s49zAmount = 0;
  renderTax();
}



// ════════════════════════════════════════════════════════════════
// CLIENT PORTAL ENGINE
// ════════════════════════════════════════════════════════════════

// Shared document list (lawyer + client both reference this)
const PORTAL_DOCS = [
  { id: 'arnona',    name: 'טופס ארנונה',                  recv: false },
  { id: 'mortgage',  name: 'דוח יתרות לסילוק משכנתא',     recv: false },
  { id: 'intent',    name: 'מכתב כוונות מהבנק',           recv: false },
  { id: 'tabu',      name: 'נסח טאבו',                     recv: false },
  { id: 'rent',      name: 'הסכם שכירות',                  recv: false },
  { id: 'taxes',     name: 'אישורי מיסים (שבח/רכישה)',     recv: false },
];

let _ptCode = null;   // current 6-digit access code

// ── ptInit: called when portal tab opens ─────────────────────
function ptInit() {
  ptRender();
  if (_ptCode) document.getElementById('pt-code-sec').style.display = '';
}

// ── ptGen: generate a random 6-digit code ────────────────────
function ptGen() {
  _ptCode = String(Math.floor(100000 + Math.random() * 900000));

  const dispEl = document.getElementById('pt-code-disp');
  const linkEl = document.getElementById('pt-link-disp');
  const secEl  = document.getElementById('pt-code-sec');

  if (dispEl) dispEl.textContent = _ptCode.split('').join('  ');
  const link = location.href.split('?')[0] + '?client=' + _ptCode;
  if (linkEl) linkEl.textContent = link;
  if (secEl)  secEl.style.display = '';
}

// ── Copy helpers ──────────────────────────────────────────────
function ptCopyLink() {
  const link = location.href.split('?')[0] + '?client=' + _ptCode;
  navigator.clipboard.writeText(link).catch(() => {});
  _ptToast();
}
function ptCopyCode() {
  if (_ptCode) navigator.clipboard.writeText(_ptCode).catch(() => {});
  _ptToast();
}
function _ptToast() {
  const el = document.getElementById('pt-ok');
  if (!el) return;
  el.style.display = '';
  clearTimeout(_ptToast._t);
  _ptToast._t = setTimeout(() => { el.style.display = 'none'; }, 2400);
}
function ptPreview() {
  if (_ptCode) _openClientDash(_ptCode);
}

// ── ptRender: lawyer doc management table ────────────────────
function ptRender() {
  const tbody = document.getElementById('pt-tbody');
  const badge = document.getElementById('pt-badge');
  if (!tbody) return;

  const recvN = PORTAL_DOCS.filter(d => d.recv).length;
  if (badge) badge.textContent = recvN + ' / ' + PORTAL_DOCS.length + ' התקבלו';

  tbody.innerHTML = PORTAL_DOCS.map(d => `
    <tr id="ptrow-${d.id}">
      <td style="font-weight:600;">${d.name}</td>
      <td style="text-align:center;">
        ${d.recv
          ? '<span style="color:#16a34a;font-weight:700;">✅ התקבל</span>'
          : '<span style="color:#dc2626;font-weight:700;">🔴 חסר</span>'}
      </td>
      <td style="text-align:center;">
        ${d.recv
          ? '<span style="font-size:.75rem;color:#16a34a;font-weight:600;">מסמך בתיק</span>'
          : `<button class="pt-mark" onclick="ptMarkRecv('${d.id}')">✓ סמן כהתקבל</button>`}
      </td>
    </tr>`).join('');
}

// ── ptMarkRecv: lawyer marks a doc received ───────────────────
function ptMarkRecv(docId) {
  const doc = PORTAL_DOCS.find(d => d.id === docId);
  if (!doc) return;
  const btn = document.querySelector('#ptrow-' + docId + ' button');
  if (btn) { btn.disabled = true; btn.textContent = '⏳...'; }
  setTimeout(() => {
    doc.recv = true;
    ptRender();
    _refreshCdDocs();   // sync client view if open
  }, 800);
}

// ════════════════════════════════════════════════════════════════
// CLIENT LOGIN / LOGOUT
// ════════════════════════════════════════════════════════════════
function cpOpen() {
  const ov  = document.getElementById('cp-overlay');
  const inp = document.getElementById('cp-inp');
  const err = document.getElementById('cp-err');
  if (ov)  ov.classList.add('active');
  if (inp) { inp.value = ''; setTimeout(() => inp.focus(), 200); }
  if (err) err.textContent = '';
}
function cpClose() {
  const ov = document.getElementById('cp-overlay');
  if (ov) ov.classList.remove('active');
}
function cpLogout() {
  const dash = document.getElementById('cd-dash');
  if (dash) dash.classList.remove('active');
}

function cpLogin() {
  const inp  = document.getElementById('cp-inp');
  const err  = document.getElementById('cp-err');
  const code = inp ? inp.value.trim() : '';

  if (!/^\d{6}$/.test(code)) {
    if (err) err.textContent = 'קוד גישה חייב להיות 6 ספרות';
    return;
  }
  // Accept: exact match to generated code, OR any 6-digit if no code set (demo mode)
  if (_ptCode && code !== _ptCode) {
    if (err) err.textContent = '❌ קוד גישה שגוי — בדוק עם עורך הדין';
    return;
  }
  cpClose();
  _openClientDash(code);
}

// ════════════════════════════════════════════════════════════════
// BUILD CLIENT DASHBOARD
// ════════════════════════════════════════════════════════════════
function _openClientDash(code) {
  const IL = n => (typeof n === 'number' && n > 0) ? '₪' + Math.round(n).toLocaleString('he-IL') : '—';

  // ── Client name ──────────────────────────────────────────
  const name = (state.parties && state.parties[0] && state.parties[0].name)
    ? state.parties[0].name : (state.clientName || 'לקוח יקר');
  const nameEl = document.getElementById('cd-uname');
  if (nameEl) nameEl.textContent = 'שלום, ' + name;

  // ── Progress ─────────────────────────────────────────────
  const steps = [
    { lbl: '📋 פתיחת תיק', done: !!(state.clientName || (state.parties && state.parties.length)) },
    { lbl: '📁 מסמכים',    done: PORTAL_DOCS.filter(d => d.recv).length >= 2 },
    { lbl: '✍️ חתימות',    done: !!state.feeAgreement },
    { lbl: '🧮 מיסים',     done: !!(state.price && state.role) },
    { lbl: '🏛️ רישום',     done: false },
  ];
  const doneN  = steps.filter(s => s.done).length;
  const pct    = Math.round(doneN / steps.length * 100);
  const actIdx = steps.findIndex(s => !s.done);
  const actLbl = actIdx >= 0 ? steps[actIdx].lbl.replace(/^\S+\s*/, '') : 'הושלם';

  const fillEl  = document.getElementById('cd-prog-fill');
  const pctEl   = document.getElementById('cd-prog-pct');
  const lblEl   = document.getElementById('cd-prog-lbl');
  const pillsEl = document.getElementById('cd-pills');

  if (fillEl)  setTimeout(() => { fillEl.style.width = pct + '%'; }, 100);
  if (pctEl)   pctEl.textContent = pct + '%';
  if (lblEl)   lblEl.textContent = 'שלב ' + (doneN + 1) + ' מתוך ' + steps.length + ' — ' + actLbl;
  if (pillsEl) pillsEl.innerHTML = steps.map((s, i) => {
    const cls = s.done ? 'pil-done' : (i === actIdx ? 'pil-now' : 'pil-wait');
    const ico = s.done ? '✓' : (i === actIdx ? '▶' : '○');
    return '<div class="cd-pill ' + cls + '">' + ico + ' ' + s.lbl + '</div>';
  }).join('');

  // ── Payments ─────────────────────────────────────────────
  const paysEl = document.getElementById('cd-pays');
  if (paysEl) {
    const price = state.price || 0;
    // Try to use live payment rows from finance tab
    const rows = (window._pschRows && window._pschRows.length)
      ? window._pschRows.map((r, i) => ({
          cond: r.condition || ('תשלום ' + (i + 1)),
          amt:  parseFloat(r.amount) || 0,
          note: r.notes || '',
          idx:  i,
        }))
      : [
          { cond: 'במעמד החתימה',          amt: price * 0.1, note: 'שיק בנקאי',      idx: 0 },
          { cond: 'לאחר רישום הערת אזהרה', amt: price * 0.8, note: 'העברה בנקאית',   idx: 1 },
          { cond: 'במסירת החזקה',           amt: price * 0.1, note: 'שיק בנקאי',      idx: 2 },
        ];
    paysEl.innerHTML = rows.length
      ? rows.map(r => {
          const cls = r.idx === 0 ? 'pay-done' : (r.idx === 1 ? 'pay-next' : 'pay-fut');
          const st  = r.idx === 0 ? '✅ שולם' : (r.idx === 1 ? '⏳ הבא' : '🔒 עתידי');
          return '<div class="cd-pay ' + cls + '">'
            + '<div><div style="font-weight:600;">' + r.cond + '</div>'
            + '<div style="font-size:.75rem;color:#64748b;">' + r.note + '</div></div>'
            + '<div style="font-size:.95rem;font-weight:800;color:#0f2744;">' + IL(r.amt) + '</div>'
            + '<div style="font-size:.72rem;font-weight:700;">' + st + '</div>'
            + '</div>';
        }).join('')
      : '<div style="color:#94a3b8;font-size:.85rem;">לוח תשלומים יוכן בקרוב</div>';
  }

  // ── Deadlines ────────────────────────────────────────────
  const dlsEl = document.getElementById('cd-dls');
  if (dlsEl) {
    // Try to use live deadline items
    const dls = (window._dlItems && window._dlItems.length)
      ? window._dlItems.slice(0, 5)
      : [
          { icon: '📋', name: 'דיווח מס רכישה',     date: '30 יום מהחתימה', urg: 'y' },
          { icon: '⏰', name: 'תשלום מקדמת שבח',     date: '30 יום מהחתימה', urg: 'r' },
          { icon: '🏛️', name: 'קבלת אישור עירייה',   date: '60 יום מהחתימה', urg: 'g' },
        ];
    dlsEl.innerHTML = dls.map(d => {
      const urg  = d.urg || (d.urgency === 'urgent' ? 'r' : d.urgency === 'soon' ? 'y' : 'g');
      const chip = urg === 'r' ? 'chip-r' : urg === 'y' ? 'chip-y' : 'chip-g';
      const ctxt = urg === 'r' ? '⚡ דחוף' : urg === 'y' ? '⏳ בקרוב' : '✓ בסדר';
      const date = d.date || (d.daysLeft != null ? 'עוד ' + d.daysLeft + ' ימים' : '');
      return '<div class="cd-dl">'
        + '<div style="font-size:1.3rem;flex-shrink:0;">' + (d.icon || '📌') + '</div>'
        + '<div><div class="dl-name">' + (d.name || d.label || '—') + '</div>'
        + '<div class="dl-date">' + date + '</div></div>'
        + '<div class="dl-chip ' + chip + '">' + ctxt + '</div>'
        + '</div>';
    }).join('');
  }

  // ── Documents ────────────────────────────────────────────
  _refreshCdDocs();

  // ── Show ─────────────────────────────────────────────────
  const dash = document.getElementById('cd-dash');
  if (dash) dash.classList.add('active');
}

// ── Refresh only the docs section (after upload) ──────────────
function _refreshCdDocs() {
  const el = document.getElementById('cd-docs');
  if (!el) return;
  el.innerHTML = PORTAL_DOCS.map(d =>
    '<div class="cd-doc" id="cddoc-' + d.id + '">'
    + '<div class="cd-doc-n">' + d.name + '</div>'
    + (d.recv
        ? '<span class="bdg-r">✅ התקבל</span>'
        : '<span class="bdg-m">🔴 חסר</span>'
          + '<button class="cd-upbtn" onclick="cdUpload(\'' + d.id + '\')">⬆ העלה</button>')
    + '</div>'
  ).join('');
}

// ── Client uploads a doc ──────────────────────────────────────
function cdUpload(docId) {
  const doc = PORTAL_DOCS.find(d => d.id === docId);
  if (!doc) return;
  const row = document.getElementById('cddoc-' + docId);
  const btn = row ? row.querySelector('.cd-upbtn') : null;
  if (btn) { btn.disabled = true; btn.innerHTML = '⏳ מעלה...'; }
  setTimeout(() => {
    doc.recv = true;
    _refreshCdDocs();
    ptRender();   // sync lawyer view
  }, 1100);
}

// ── Auto-open via ?client=XXXXXX URL param ─────────────────────
(function () {
  const p = new URLSearchParams(location.search);
  const c = p.get('client');
  if (c && /^\d{6}$/.test(c)) {
    window.addEventListener('DOMContentLoaded', function () {
      setTimeout(() => _openClientDash(c), 700);
    });
  }
}());


</script>
<!-- ═══════════════════════════════════════════════════════════
     GLOBAL BRAND FOOTER — static, desktop only
═══════════════════════════════════════════════════════════ -->
<!-- ══════════════ CLIENT LOGIN OVERLAY ════════════════════════ -->
<div id="cp-overlay">
  <div class="cpl-card">
    <button class="cpl-x" onclick="cpClose()">✕</button>
    <div class="cpl-logo">⚖️</div>
    <div class="cpl-title">LegalFlow OS</div>
    <div class="cpl-sub">פורטל לקוחות<br>הזן את קוד הגישה שקיבלת מעורך הדין</div>
    <input class="cpl-inp" id="cp-inp" type="text" maxlength="6"
      placeholder="• • • • • •" autocomplete="off"
      oninput="this.value=this.value.replace(/[^0-9]/g,'')"
      onkeydown="if(event.key==='Enter')cpLogin()"/>
    <button class="cpl-btn" onclick="cpLogin()">כניסה לפורטל ←</button>
    <div class="cpl-err" id="cp-err"></div>
  </div>
</div>

<!-- ══════════════ CLIENT DASHBOARD ════════════════════════════ -->
<div id="cd-dash">
  <div class="cdh">
    <div class="cdh-brand">
      <div class="cdh-logo">⚖️</div>
      <div>
        <div class="cdh-name" id="cd-uname">פורטל לקוח</div>
        <div class="cdh-sub">LEGALFLOW OS · READ ONLY</div>
      </div>
    </div>
    <button class="cdh-out" onclick="cpLogout()">↩ יציאה</button>
  </div>

  <div class="cdb">

    <!-- Progress -->
    <div class="cds">📊 התקדמות העסקה</div>
    <div class="cdc">
      <div style="display:flex;justify-content:space-between;align-items:baseline;margin-bottom:12px;">
        <div style="font-size:.92rem;font-weight:700;color:#0f2744;" id="cd-prog-lbl">טוען...</div>
        <div id="cd-prog-pct" style="font-size:1.5rem;font-weight:900;color:#2563eb;">0%</div>
      </div>
      <div class="cdp-trk">
        <div class="cdp-fill" id="cd-prog-fill" style="width:0%"></div>
      </div>
      <div class="cdp-lbl">
        <span>פתיחת תיק</span>
        <span>מסמכים</span>
        <span>חתימות</span>
        <span>מיסים</span>
        <span>רישום</span>
      </div>
      <div class="cd-pills" id="cd-pills"></div>
    </div>

    <!-- Payments -->
    <div class="cds">💳 לוח תשלומים</div>
    <div class="cdc"><div id="cd-pays"></div></div>

    <!-- Deadlines -->
    <div class="cds">📅 מועדים קרובים</div>
    <div class="cdc"><div id="cd-dls"></div></div>

    <!-- Docs -->
    <div class="cds">📁 מסמכים נדרשים</div>
    <div class="cdc">
      <div style="font-size:.82rem;color:#64748b;margin-bottom:14px;line-height:1.5;">
        לחץ "העלה" ליד כל מסמך חסר — המסמך יגיע ישירות לעורך הדין שלך.
      </div>
      <div id="cd-docs"></div>
    </div>

    <div style="text-align:center;padding:24px 0 8px;font-size:.72rem;color:#94a3b8;">
      ⚖️ LegalFlow OS · Aharoni Legal Platform · גישה לקריאה בלבד
    </div>
  </div>
</div>

<!-- FAB: client login button -->
<button id="cp-fab" onclick="cpOpen()">🔑 כניסת לקוחות</button>


<footer id="global-footer" role="contentinfo">
  <div>
    <span class="gf-badge">⚖️ LEGAL FLOW</span>
    <strong>© 2024 כל הזכויות שמורות</strong>
    <span class="gf-divider">·</span>
    <strong>עו"ד שחר אהרוני</strong>
    <span class="gf-divider">·</span>
    פותח באמצעות AI Legal-Tech
    <span class="gf-heart"> ♥</span>
    <span class="gf-divider">|</span>
    <a href="/cdn-cgi/l/email-protection#186b707970796a58796b3574796f367b77367174"><span class="__cf_email__" data-cfemail="02716a636a63704263712f6e63752c616d2c6b6e">[email&#160;protect